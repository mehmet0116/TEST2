name: DeepSeek V3.2 ULTIMATE AGENT (v10.0 - Stable)
on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]
  workflow_dispatch:
    inputs:
      task:
        description: 'What should I do?'
        required: true
        default: 'Analyze and fix the project'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  ultimate_brain:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.actor != 'github-actions[bot]'
    
    steps:
      - name: ğŸš€ Projeyi Checkout Et
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Proje YapÄ±sÄ±nÄ± Analiz Et
        id: scan_project
        run: |
          echo "ğŸ“ Proje analizi baÅŸlatÄ±lÄ±yor..."
          
          # Proje tipini belirle
          if [ -f "package.json" ]; then
            echo "NODE_PROJECT=true" >> $GITHUB_ENV
            echo "ğŸŸ¢ Node.js projesi tespit edildi"
          fi
          
          if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "ANDROID_PROJECT=true" >> $GITHUB_ENV
            echo "ğŸ“± Android projesi tespit edildi"
          fi
          
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            echo "PYTHON_PROJECT=true" >> $GITHUB_ENV
            echo "ğŸ Python projesi tespit edildi"
          fi
          
          # Dosya listesi oluÅŸtur
          find . -type f -name "*.json" -o -name "*.js" -o -name "*.ts" -o -name "*.py" -o -name "*.java" -o -name "*.kt" -o -name "*.gradle" -o -name "*.xml" | head -50 > file_list.txt
          
          echo "âœ… Analiz tamamlandÄ±"
          echo "FILE_COUNT=$(find . -type f | wc -l)" >> $GITHUB_ENV

      - name: ğŸ¤– DeepSeek Ultimate Motoru
        id: deepseek_engine
        uses: actions/github-script@v7
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          IS_ANDROID: ${{ env.ANDROID_PROJECT }}
          IS_NODE: ${{ env.NODE_PROJECT }}
          IS_PYTHON: ${{ env.PYTHON_PROJECT }}
        with:
          script: |
            console.log("ğŸ§  DeepSeek Ultimate Engine baÅŸlatÄ±lÄ±yor...");
            
            // KullanÄ±cÄ± mesajÄ±nÄ± al
            const userMessage = context.payload.comment ? 
              context.payload.comment.body : 
              (context.payload.issue ? context.payload.issue.body : "Analyze and improve the project");
            
            console.log(`ğŸ“ KullanÄ±cÄ± mesajÄ±: ${userMessage.substring(0, 200)}...`);
            
            // API Key kontrolÃ¼
            const apiKey = process.env.DEEPSEEK_API_KEY?.trim();
            if (!apiKey || apiKey === '') {
              throw new Error("âŒ DEEPSEEK_API_KEY GitHub Secrets'ta bulunamadÄ±!");
            }
            
            // --- DOSYA OKUMA ---
            const criticalFiles = [
              'package.json', 'package-lock.json', 'yarn.lock',
              'build.gradle', 'build.gradle.kts', 'settings.gradle', 'settings.gradle.kts',
              'app/build.gradle', 'app/build.gradle.kts',
              'requirements.txt', 'pyproject.toml', 'setup.py',
              'pom.xml', 'build.gradle',
              'README.md', '.gitignore', 'Dockerfile', 'docker-compose.yml',
              'index.html', 'style.css', 'script.js', 'main.py', 'app.py',
              'AndroidManifest.xml', 'pubspec.yaml'
            ];
            
            // KullanÄ±cÄ±nÄ±n bahsettiÄŸi dosyalarÄ± bul
            const fileRegex = /[\w\/.-]+\.(js|ts|jsx|tsx|py|java|kt|dart|go|rs|c|cpp|h|hpp|html|css|json|xml|yaml|yml|gradle|md|txt)/g;
            const mentionedFiles = [...new Set((userMessage.match(fileRegex) || []).map(f => f.trim()))];
            
            // TÃ¼m dosyalarÄ± birleÅŸtir
            const allFilesToCheck = [...new Set([...criticalFiles, ...mentionedFiles])];
            
            let projectContext = "ğŸ“ PROJE DOSYALARI:\n\n";
            let filesRead = 0;
            
            // Sadece ilk 20 dosyayÄ± oku (token sÄ±nÄ±rÄ± iÃ§in)
            for (const file of allFilesToCheck.slice(0, 20)) {
              try {
                const { data } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: file
                });
                
                if (data.type === 'file' && data.encoding === 'base64') {
                  const content = Buffer.from(data.content, 'base64').toString('utf8');
                  const preview = content.length > 3000 ? 
                    content.substring(0, 1500) + "\n... [devamÄ± var] ...\n" + content.substring(content.length - 1500) : 
                    content;
                  
                  projectContext += `ğŸ“„ ${file}:\n\`\`\`\n${preview}\n\`\`\`\n\n`;
                  filesRead++;
                }
              } catch (error) {
                // Dosya yoksa, sorun deÄŸil
              }
            }
            
            console.log(`âœ… ${filesRead} dosya okundu`);
            
            // --- DEEPSEEK API Ã‡AÄRISI ---
            const systemPrompt = `
            Sen DeepSeek V3.2 Ultimate Agent'sÄ±n. KullanÄ±cÄ±nÄ±n istediÄŸi her ÅŸeyi yapabilirsin.
            
            TEMEL GÃ–REVLERÄ°N:
            1. Kod yaz ve dÃ¼zelt
            2. Dosya oluÅŸtur ve gÃ¼ncelle
            3. Projeyi geliÅŸtir
            4. HatalarÄ± Ã§Ã¶z
            5. Eksikleri tamamla
            
            Ã‡IKTI FORMATI (ZORUNLU):
            Her dosya iÃ§in ÅŸu formatÄ± kullan:
            ---FILENAME: dosya/yolu.uzanti---
            [KODUN TAMAMI BURAYA]
            ---END_OF_FILE---
            
            Ã–NEMLÄ° NOTLAR:
            - KodlarÄ± tam ve Ã§alÄ±ÅŸÄ±r ÅŸekilde ver
            - Eksik bÄ±rakma
            - Android projesi ise Gradle dosyalarÄ±nÄ± doÄŸru yapÄ±landÄ±r
            - Node.js projesi ise package.json'u doÄŸru yapÄ±landÄ±r
            - TÃ¼m baÄŸÄ±mlÄ±lÄ±klarÄ± ekle
            `.trim();
            
            console.log("ğŸ“¡ DeepSeek API'ye istek gÃ¶nderiliyor...");
            
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${apiKey}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                  { 
                    role: "system", 
                    content: systemPrompt 
                  },
                  { 
                    role: "user", 
                    content: `GÃ–REV: ${userMessage}\n\n${projectContext}\n\nLÃ¼tfen gerekli tÃ¼m dosyalarÄ± oluÅŸtur veya dÃ¼zelt.` 
                  }
                ],
                max_tokens: 8000,
                temperature: 0.3
              })
            });
            
            if (!response.ok) {
              const errorText = await response.text();
              console.error("âŒ API HatasÄ±:", response.status, errorText);
              throw new Error(`DeepSeek API hatasÄ±: ${response.status}`);
            }
            
            const data = await response.json();
            const aiResponse = data.choices[0]?.message?.content;
            
            if (!aiResponse) {
              throw new Error("âŒ AI'dan yanÄ±t alÄ±namadÄ±");
            }
            
            console.log(`âœ… AI yanÄ±tÄ± alÄ±ndÄ± (${aiResponse.length} karakter)`);
            
            // --- DOSYA Ä°ÅLEMLERÄ° ---
            const filePattern = /---FILENAME:\s*(.+?)---\n([\s\S]*?)---END_OF_FILE---/g;
            let match;
            const updatedFiles = [];
            const createdFiles = [];
            
            while ((match = filePattern.exec(aiResponse)) !== null) {
              const fileName = match[1].trim();
              const fileContent = match[2].trim();
              
              try {
                // Dosya var mÄ± kontrol et
                let sha = undefined;
                try {
                  const { data: existing } = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: fileName
                  });
                  sha = existing.sha;
                } catch (e) {
                  // Dosya yok, yeni oluÅŸturulacak
                }
                
                await github.rest.repos.createOrUpdateFileContents({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: fileName,
                  message: `ğŸ¤– DeepSeek: ${fileName} ${sha ? 'gÃ¼ncellendi' : 'oluÅŸturuldu'}`,
                  content: Buffer.from(fileContent).toString('base64'),
                  sha: sha
                });
                
                if (sha) {
                  updatedFiles.push(fileName);
                } else {
                  createdFiles.push(fileName);
                }
                
                console.log(`âœ… ${fileName} ${sha ? 'gÃ¼ncellendi' : 'oluÅŸturuldu'}`);
                
              } catch (error) {
                console.error(`âŒ ${fileName} iÅŸlenirken hata:`, error.message);
              }
            }
            
            return {
              aiResponse: aiResponse.substring(0, 4000),
              updatedFiles: updatedFiles.join(','),
              createdFiles: createdFiles.join(','),
              totalFiles: (updatedFiles.length + createdFiles.length).toString()
            };

      - name: ğŸ—ï¸ Derleme Ä°ÅŸlemleri (Opsiyonel)
        id: build_process
        run: |
          echo "ğŸ—ï¸ Derleme iÅŸlemleri baÅŸlatÄ±lÄ±yor..."
          
          # Android projesi varsa
          if [ "${{ env.ANDROID_PROJECT }}" = "true" ]; then
            echo "ğŸ“± Android derlemesi deneniyor..."
            
            # Java kur
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jdk
            
            # Gradle wrapper kontrolÃ¼
            if [ ! -f "gradlew" ]; then
              echo "Gradle wrapper bulunamadÄ±, basit bir gradlew oluÅŸturuluyor..."
              echo '#!/usr/bin/env bash
              echo "Gradle wrapper is not fully set up. Please run: gradle wrapper" 
              exit 1' > gradlew
              chmod +x gradlew
            fi
            
            # Temizle ve derle
            chmod +x gradlew 2>/dev/null || true
            ./gradlew clean --no-daemon 2>&1 | tail -50 || echo "Clean baÅŸarÄ±sÄ±z olabilir"
            
          # Node.js projesi varsa
          elif [ "${{ env.NODE_PROJECT }}" = "true" ]; then
            echo "ğŸŸ¢ Node.js baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            npm install --silent 2>&1 | tail -30 || echo "npm install baÅŸarÄ±sÄ±z"
            
            # package.json'da build script'i varsa
            if grep -q '"build"' package.json; then
              echo "ğŸ”„ Build script Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
              npm run build --silent 2>&1 | tail -30 || echo "Build baÅŸarÄ±sÄ±z"
            fi
            
          # Python projesi varsa
          elif [ "${{ env.PYTHON_PROJECT }}" = "true" ]; then
            echo "ğŸ Python baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            pip install -r requirements.txt 2>&1 | tail -30 || echo "pip install baÅŸarÄ±sÄ±z"
          fi
          
          echo "âœ… Derleme iÅŸlemleri tamamlandÄ±"

      - name: ğŸ“Š SonuÃ§ Raporu
        uses: actions/github-script@v7
        env:
          AI_RESPONSE: ${{ steps.deepseek_engine.outputs.aiResponse }}
          UPDATED_FILES: ${{ steps.deepseek_engine.outputs.updatedFiles }}
          CREATED_FILES: ${{ steps.deepseek_engine.outputs.createdFiles }}
          TOTAL_FILES: ${{ steps.deepseek_engine.outputs.totalFiles }}
        with:
          script: |
            const issueNumber = context.payload.issue?.number || 
                               (context.payload.comment ? context.payload.comment.issue_number : null);
            
            if (!issueNumber) {
              console.log("â„¹ï¸ Issue numarasÄ± bulunamadÄ±, rapor atlanÄ±yor");
              return;
            }
            
            let report = `## ğŸ¤– DeepSeek Ultimate Agent Raporu\n\n`;
            
            // Ä°statistikler
            report += `### ğŸ“Š Ä°statistikler\n`;
            report += `- **Toplam Ä°ÅŸlenen Dosya:** ${process.env.TOTAL_FILES || '0'}\n`;
            report += `- **GÃ¼ncellenen Dosyalar:** ${process.env.UPDATED_FILES ? process.env.UPDATED_FILES.split(',').length : '0'}\n`;
            report += `- **OluÅŸturulan Dosyalar:** ${process.env.CREATED_FILES ? process.env.CREATED_FILES.split(',').length : '0'}\n`;
            report += `- **Zaman:** ${new Date().toLocaleString('tr-TR')}\n\n`;
            
            // GÃ¼ncellenen dosyalar
            if (process.env.UPDATED_FILES && process.env.UPDATED_FILES.length > 0) {
              report += `### ğŸ”„ GÃ¼ncellenen Dosyalar\n`;
              process.env.UPDATED_FILES.split(',').forEach(file => {
                if (file) report += `- \`${file}\`\n`;
              });
              report += `\n`;
            }
            
            // OluÅŸturulan dosyalar
            if (process.env.CREATED_FILES && process.env.CREATED_FILES.length > 0) {
              report += `### ğŸ†• OluÅŸturulan Dosyalar\n`;
              process.env.CREATED_FILES.split(',').forEach(file => {
                if (file) report += `- \`${file}\`\n`;
              });
              report += `\n`;
            }
            
            // AI YanÄ±tÄ± (kÄ±saltÄ±lmÄ±ÅŸ)
            if (process.env.AI_RESPONSE && process.env.AI_RESPONSE.length > 100) {
              report += `### ğŸ§  AI Ã–zeti\n`;
              const preview = process.env.AI_RESPONSE.length > 1500 ? 
                process.env.AI_RESPONSE.substring(0, 1500) + '...' : 
                process.env.AI_RESPONSE;
              report += `<details>\n<summary>TÄ±klayarak AI yanÄ±tÄ±nÄ± gÃ¶rÃ¼ntÃ¼le</summary>\n\n`;
              report += `\`\`\`\n${preview}\n\`\`\`\n`;
              report += `</details>\n\n`;
            }
            
            // Sonraki AdÄ±mlar
            report += `### ğŸ¯ Sonraki AdÄ±mlar\n`;
            report += `1. **DeÄŸiÅŸiklikleri incele** - YukarÄ±daki dosyalarÄ± kontrol edin\n`;
            report += `2. **Commit'leri gÃ¶zden geÃ§irin** - GitHub'da yapÄ±lan deÄŸiÅŸiklikleri gÃ¶rÃ¼n\n`;
            report += `3. **Projeyi test edin** - Yerel makinenizde Ã§alÄ±ÅŸtÄ±rmayÄ± deneyin\n`;
            report += `4. **Yeni bir issue aÃ§Ä±n** - BaÅŸka bir ÅŸeye ihtiyacÄ±nÄ±z varsa\n\n`;
            
            report += `---\n*Bu rapor otomatik olarak DeepSeek Ultimate Agent tarafÄ±ndan oluÅŸturuldu* ğŸ¤–`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: report
            });
            
            console.log("âœ… Rapor gÃ¶nderildi");

      - name: ğŸ‰ Ä°ÅŸlem TamamlandÄ±
        run: |
          echo "ğŸ‰ DeepSeek Ultimate Agent iÅŸlemi baÅŸarÄ±yla tamamlandÄ±!"
          echo "ğŸ“Š Ã–zet:"
          echo "- Dosya iÅŸlemleri: ${{ steps.deepseek_engine.outputs.totalFiles || 0 }} dosya"
          echo "- Derleme iÅŸlemleri: TamamlandÄ±"
          echo "- Rapor: GitHub Issue'ya yorum olarak eklendi"
