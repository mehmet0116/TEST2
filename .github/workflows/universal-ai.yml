name: ğŸ¤– UNIVERSAL AI CODE AGENT
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      command:
        description: 'AI Agent Komutu'
        required: true
        default: 'Projeyi analiz et ve geliÅŸtir'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  universal_ai_agent:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.actor != 'github-actions[bot]'
    
    steps:
      # 1. PROJEYÄ° AL
      - name: ğŸ“¥ Projeyi Checkout Et
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. HER ÅEYÄ° YAPAN AI MOTORU
      - name: ğŸ§  UNIVERSAL AI MOTORU
        id: ai_engine
        uses: actions/github-script@v7
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_COMMAND: ${{ github.event.inputs.command || github.event.comment.body || github.event.issue.body }}
        with:
          script: |
            const core = require('@actions/core');
            console.log('ğŸš€ UNIVERSAL AI AGENT BAÅLATILIYOR...');
            
            // 1. KULLANICI KOMUTUNU AL
            const userCommand = process.env.USER_COMMAND || "Bu projeyi geliÅŸtir";
            console.log(`ğŸ“ KOMUT: "${userCommand}"`);
            
            // 2. API KEY KONTROLÃœ
            const apiKey = process.env.DEEPSEEK_API_KEY?.trim();
            if (!apiKey) {
              core.setFailed('âŒ DEEPSEEK_API_KEY GitHub Secrets\'ta yok!');
              return;
            }
            
            // 3. PROJEDEKÄ° TÃœM Ã–NEMLÄ° DOSYALARI OKU
            console.log('ğŸ” Proje dosyalarÄ± taranÄ±yor...');
            
            // Kritik dosyalarÄ± oku
            const criticalFiles = [
              'package.json', 'requirements.txt', 'pom.xml',
              'build.gradle', 'Cargo.toml', 'go.mod',
              'Dockerfile', 'docker-compose.yml', 'Makefile',
              'README.md', '.gitignore',
              'index.html', 'main.js', 'app.py', 'main.py',
              'src/main.rs', 'src/main.go'
            ];
            
            let projectContext = "ğŸ“‚ PROJE DOSYALARI:\n\n";
            let filesRead = 0;
            
            for (const file of criticalFiles) {
              try {
                const { data } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: file
                });
                
                if (data.type === 'file' && data.encoding === 'base64') {
                  const content = Buffer.from(data.content, 'base64').toString('utf-8');
                  const preview = content.substring(0, 1000);
                  projectContext += `ğŸ“„ ${file}:\n\`\`\`\n${preview}${content.length > 1000 ? '\n... (devamÄ± var)' : ''}\n\`\`\`\n\n`;
                  filesRead++;
                }
              } catch (e) {
                // Dosya yoksa sorun deÄŸil
              }
            }
            
            console.log(`âœ… ${filesRead} dosya okundu`);
            
            // 4. AI PROMPT
            const systemPrompt = `
# ğŸš€ EVRENSEL KOD ÃœRETÄ°CÄ°

Sen "Universal Code Generator" adÄ±nda her tÃ¼rlÃ¼ projeyi otomatik oluÅŸturabilen bir AI ajanÄ±sÄ±n.

## KURALLAR:
1. KULLANICI NE Ä°STERSE ONU TAM YAP
2. ASLA YARIM BIRAKMA
3. TÃœM KODLAR Ã‡ALIÅIR OLSUN
4. TÃœM BAÄIMLILIKLARI EKLE

## DOSYA FORMATI:
Her dosya iÃ§in bu formatÄ± kullan:

### DOSYA: dosya/yolu.uzanti
\`\`\`uzanti
[DOSYANIN TAM Ä°Ã‡ERÄ°ÄÄ°]
\`\`\`

## DESTEKLENEN TEKNOLOJÄ°LER:
- Web: HTML, CSS, JavaScript, React, Vue
- Backend: Node.js, Python, Java, Go, Rust, PHP
- Mobil: Android, iOS, Flutter
- MasaÃ¼stÃ¼: Electron, JavaFX
- Oyun: Canvas, Basit oyun motorlarÄ±
- VeritabanÄ±: SQL, MongoDB
- DevOps: Docker, CI/CD

## ÅÄ°MDÄ° BAÅLA:
KullanÄ±cÄ± komutu: "${userCommand}"
`.trim();

            // 5. DEEPSEEK API Ã‡AÄRISI
            console.log('ğŸ“¡ DeepSeek API Ã§aÄŸrÄ±sÄ± yapÄ±lÄ±yor...');
            
            try {
              const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${apiKey}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: 'deepseek-chat',
                  messages: [
                    {
                      role: 'system',
                      content: systemPrompt
                    },
                    {
                      role: 'user',
                      content: `PROJE: ${context.repo.owner}/${context.repo.repo}\nKOMUT: ${userCommand}\n\nPROJE DURUMU:\n${projectContext}\n\nLÃ¼tfen gerekli tÃ¼m dosyalarÄ± oluÅŸtur.`
                    }
                  ],
                  max_tokens: 32000,
                  temperature: 0.2
                })
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API HatasÄ±: ${response.status} - ${errorText.substring(0, 200)}`);
              }
              
              const data = await response.json();
              const aiResponse = data.choices[0]?.message?.content || '';
              
              if (!aiResponse) {
                throw new Error('AI boÅŸ yanÄ±t dÃ¶ndÃ¼rdÃ¼');
              }
              
              console.log(`âœ… AI yanÄ±tÄ± alÄ±ndÄ± (${aiResponse.length} karakter)`);
              
              // 6. DOSYALARI Ã‡IKAR VE UYGULA
              console.log('ğŸ”„ Dosyalar iÅŸleniyor...');
              
              // Dosya pattern'ini bul
              const fileRegex = /### DOSYA:\s*(.+?)\s*\n```(?:[a-z]+)?\n([\s\S]*?)\n```/g;
              let match;
              const createdFiles = [];
              const updatedFiles = [];
              
              while ((match = fileRegex.exec(aiResponse)) !== null) {
                const filePath = match[1].trim();
                let fileContent = match[2].trim();
                
                console.log(`ğŸ“ Ä°ÅŸleniyor: ${filePath}`);
                
                try {
                  // Dosya var mÄ± kontrol et
                  let sha;
                  try {
                    const { data: existing } = await github.rest.repos.getContent({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      path: filePath
                    });
                    sha = existing.sha;
                  } catch (e) {
                    sha = undefined;
                  }
                  
                  // DosyayÄ± oluÅŸtur veya gÃ¼ncelle
                  await github.rest.repos.createOrUpdateFileContents({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: filePath,
                    message: `ğŸ¤– AI Agent: ${userCommand.substring(0, 50)}...`,
                    content: Buffer.from(fileContent).toString('base64'),
                    sha: sha || undefined
                  });
                  
                  if (sha) {
                    updatedFiles.push(filePath);
                  } else {
                    createdFiles.push(filePath);
                  }
                  
                } catch (fileError) {
                  console.error(`âŒ ${filePath} hatasÄ±:`, fileError.message);
                }
              }
              
              // 7. SONUÃ‡LARI DÃ–NDÃœR
              const result = {
                success: true,
                totalFiles: createdFiles.length + updatedFiles.length,
                created: createdFiles,
                updated: updatedFiles,
                aiResponsePreview: aiResponse.substring(0, 2000)
              };
              
              core.setOutput('files_created', createdFiles.length.toString());
              core.setOutput('files_updated', updatedFiles.length.toString());
              core.setOutput('total_files', result.totalFiles.toString());
              core.setOutput('ai_preview', result.aiResponsePreview);
              
              return result;
              
            } catch (error) {
              console.error('âŒ AI Motoru HatasÄ±:', error);
              core.setFailed(`AI Motoru HatasÄ±: ${error.message}`);
              return {
                success: false,
                error: error.message
              };
            }

      # 3. SONUÃ‡ RAPORU
      - name: ğŸ“ˆ SONUÃ‡ RAPORU
        if: always()
        uses: actions/github-script@v7
        env:
          FILES_CREATED: ${{ steps.ai_engine.outputs.files_created }}
          FILES_UPDATED: ${{ steps.ai_engine.outputs.files_updated }}
          TOTAL_FILES: ${{ steps.ai_engine.outputs.total_files }}
          AI_PREVIEW: ${{ steps.ai_engine.outputs.ai_preview }}
          USER_COMMAND: ${{ github.event.inputs.command || github.event.comment.body || github.event.issue.body }}
        with:
          script: |
            const issueNumber = context.payload.issue?.number || 
                               (context.payload.comment ? context.payload.comment.issue_number : null);
            
            if (!issueNumber) return;
            
            const filesCreated = parseInt(process.env.FILES_CREATED || '0');
            const filesUpdated = parseInt(process.env.FILES_UPDATED || '0');
            const totalFiles = parseInt(process.env.TOTAL_FILES || '0');
            const aiPreview = process.env.AI_PREVIEW || '';
            const userCommand = process.env.USER_COMMAND || '';
            
            let report = `# ğŸ¤– UNIVERSAL AI AGENT - Ä°ÅLEM TAMAMLANDI\n\n`;
            report += `## ğŸ“ KULLANICI KOMUTU\n\`\`\`\n${userCommand}\n\`\`\`\n\n`;
            report += `## ğŸ“Š DOSYA Ä°STATÄ°STÄ°KLERÄ°\n`;
            report += `- **Toplam Ä°ÅŸlenen Dosya:** ${totalFiles}\n`;
            report += `- **Yeni OluÅŸturulan:** ${filesCreated}\n`;
            report += `- **GÃ¼ncellenen:** ${filesUpdated}\n\n`;
            
            if (totalFiles > 0) {
              report += `## âœ… BAÅARILI\n`;
              report += `AI Agent talimatÄ±nÄ±zÄ± iÅŸledi.\n\n`;
            }
            
            if (aiPreview) {
              report += `## ğŸ§  AI YANIT Ã–ZETÄ°\n`;
              report += `<details>\n<summary>TÄ±klayarak gÃ¶rÃ¼ntÃ¼le</summary>\n\n`;
              report += `\`\`\`\n${aiPreview}\n\`\`\`\n`;
              report += `</details>\n\n`;
            }
            
            report += `---\n*Universal AI Agent*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: report
            });

      # 4. Ä°ÅLEM TAMAM
      - name: ğŸ Ä°ÅLEM TAMAMLANDI
        if: always()
        run: |
          echo "ğŸ¤– UNIVERSAL AI AGENT Ä°ÅLEMÄ° TAMAMLANDI"
          echo "OluÅŸturulan: ${{ steps.ai_engine.outputs.files_created || 0 }}"
          echo "GÃ¼ncellenen: ${{ steps.ai_engine.outputs.files_updated || 0 }}"
