name: ğŸ¤– UNIVERSAL AI CODE AGENT
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      command:
        description: 'AI Agent Komutu'
        required: true
        default: 'Projeyi analiz et ve geliÅŸtir'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  universal_ai_agent:
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: github.actor != 'github-actions[bot]'
    
    steps:
      # 1. PROJEYÄ° AL
      - name: ğŸ“¥ Projeyi Checkout Et
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: false

      # 2. HER ÅEYÄ° YAPAN AI MOTORU
      - name: ğŸ§  UNIVERSAL AI MOTORU
        id: ai_engine
        uses: actions/github-script@v7
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_COMMAND: ${{ github.event.inputs.command || github.event.comment.body || github.event.issue.body }}
        with:
          script: |
            const core = require('@actions/core');
            console.log('ğŸš€ UNIVERSAL AI AGENT BAÅLATILIYOR...');
            
            // 1. KULLANICI KOMUTUNU AL
            const userCommand = process.env.USER_COMMAND || "Bu projeyi geliÅŸtir";
            console.log(`ğŸ“ KOMUT: "${userCommand}"`);
            
            // 2. API KEY KONTROLÃœ
            const apiKey = process.env.DEEPSEEK_API_KEY?.trim();
            if (!apiKey) {
              core.setFailed('âŒ DEEPSEEK_API_KEY GitHub Secrets\'ta yok!');
              return;
            }
            
            // 3. PROJEDEKÄ° TÃœM Ã–NEMLÄ° DOSYALARI BUL VE OKU
            console.log('ğŸ” Proje dosyalarÄ± taranÄ±yor...');
            
            // Ã–nce kÃ¶k dizindeki dosyalarÄ± bul
            const getRootFiles = async () => {
              try {
                const { data } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: ''
                });
                return data.filter(item => item.type === 'file').map(f => f.name);
              } catch (e) {
                return [];
              }
            };
            
            const rootFiles = await getRootFiles();
            console.log(`ğŸ“ KÃ¶k dosyalar: ${rootFiles.join(', ')}`);
            
            // Proje tipini AI'nÄ±n kendisi anlasÄ±n diye sadece bazÄ± dosyalarÄ± oku
            const readFileContent = async (filePath) => {
              try {
                const { data } = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path: filePath
                });
                if (data.encoding === 'base64') {
                  return Buffer.from(data.content, 'base64').toString('utf-8');
                }
              } catch (e) {}
              return null;
            };
            
            // Projede hangi dil/teknoloji olduÄŸunu anlamak iÃ§in kritik dosyalar
            const criticalFiles = [
              ...rootFiles.filter(f => 
                f.endsWith('.json') || 
                f.endsWith('.js') || f.endsWith('.ts') || f.endsWith('.jsx') || f.endsWith('.tsx') ||
                f.endsWith('.py') || f.endsWith('.java') || f.endsWith('.kt') || f.endsWith('.cpp') ||
                f.endsWith('.cs') || f.endsWith('.go') || f.endsWith('.rs') || f.endsWith('.php') ||
                f.endsWith('.rb') || f.endsWith('.swift') || f.endsWith('.dart') ||
                f.endsWith('.html') || f.endsWith('.css') || f.endsWith('.scss') ||
                f.endsWith('.xml') || f.endsWith('.yaml') || f.endsWith('.yml') ||
                f === 'package.json' || f === 'requirements.txt' || f === 'pom.xml' ||
                f === 'build.gradle' || f === 'Cargo.toml' || f === 'go.mod' ||
                f === 'Dockerfile' || f === 'docker-compose.yml' || f === 'Makefile'
              )
            ].slice(0, 15); // Ä°lk 15 dosya
            
            let projectContext = "ğŸ“‚ PROJE DOSYALARI:\n\n";
            for (const file of criticalFiles) {
              const content = await readFileContent(file);
              if (content) {
                projectContext += `ğŸ“„ ${file}:\n\`\`\`\n${content.substring(0, 1000)}${content.length > 1000 ? '\n... (devamÄ± var)' : ''}\n\`\`\`\n\n`;
              }
            }
            
            // 4. AI'YA GÃ–NDERÄ°LECEK MÃœKEMMEL PROMPT
            const systemPrompt = `
# ğŸš€ EVRENSEL KOD ÃœRETÄ°CÄ° - SENARYO TALÄ°MATLARI

Sen "Universal Code Generator" adÄ±nda her tÃ¼rlÃ¼ kodlama projesini otomatik oluÅŸturabilen bir AI ajanÄ±sÄ±n.

## ğŸ¯ TEMEL PRENSÄ°PLER:
1. KULLANICI NE Ä°STERSE ONU TAM OLARAK YAP
2. ASLA YARIM BIRAKMA, ASLA "BURAYI SEN TAMAMLA" DEME
3. TÃœM KODLAR Ã‡ALIÅIR OLSUN, TÃœM BAÄIMLILIKLARI EKLE

## ğŸ› ï¸ DESTEKLENEN TEKNOLOJÄ°LER:
- âœ… Web: HTML, CSS, JavaScript, React, Vue, Angular
- âœ… Backend: Node.js, Python (Django/Flask), Java (Spring), Go, Rust, PHP
- âœ… Mobil: Android (Kotlin/Java), iOS (Swift), Flutter, React Native
- âœ… MasaÃ¼stÃ¼: Electron, JavaFX, PyQt, C#
- âœ… Oyun: Unity (C#), Godot (GDScript), Basit Canvas oyunlarÄ±
- âœ… VeritabanÄ±: SQL, MongoDB, Firebase
- âœ… DevOps: Docker, Kubernetes, CI/CD yapÄ±landÄ±rmalarÄ±
- âœ… Script: Bash, Python, PowerShell, Automation scriptleri

## ğŸ“ DOSYA FORMATI (DEÄÄ°ÅMEZ):
Her dosya iÃ§in bu formatÄ± kullan:

### DOSYA: dosya/yolu.uzanti
\`\`\`uzanti
[DOSYANIN TAM Ä°Ã‡ERÄ°ÄÄ°]
\`\`\`

Ã–RNEK:
### DOSYA: index.html
\`\`\`html
<!DOCTYPE html>
<html>
<head>
    <title>Benim Projem</title>
</head>
<body>
    <h1>Merhaba DÃ¼nya</h1>
</body>
</html>
\`\`\`

### DOSYA: app.js
\`\`\`javascript
console.log("Merhaba DÃ¼nya");
\`\`\`

## âš¡ TALÄ°MATLAR:
1. KullanÄ±cÄ± ne istiyorsa onu tam olarak yap
2. TÃ¼m gerekli dosyalarÄ± oluÅŸtur
3. BaÄŸÄ±mlÄ±lÄ±klarÄ± ekle (package.json, requirements.txt, build.gradle, vs.)
4. README.md oluÅŸtur (projeyi nasÄ±l Ã§alÄ±ÅŸtÄ±racaÄŸÄ±nÄ± anlatan)
5. .gitignore dosyasÄ± ekle
6. EÄŸer proje varsa, mevcut dosyalarÄ± bozma, geliÅŸtir
7. EÄŸer proje yoksa, sÄ±fÄ±rdan profesyonel bir proje oluÅŸtur

## ğŸš¨ Ã–NEMLÄ° UYARILAR:
- YANITINDA SADECE DOSYALAR VE KODLAR OLSUN
- AÃ‡IKLAMA YAPMA, SADECE KOD YAZ
- TÃœM KODLAR TAM VE Ã‡ALIÅIR OLSUN
- HATA KONTROLÃœ YAP, EXCEPTION HANDLING EKLE
- MODERN VE TEMÄ°Z KOD YAZ
- PERFORMANSLI KOD YAZ
- GÃœVENLÄ° KOD YAZ

## ğŸ ÅÄ°MDÄ° BAÅLA:
AÅŸaÄŸÄ±daki kullanÄ±cÄ± komutunu yerine getir:
"${userCommand}"

MEVCUT PROJE DURUMU:
${projectContext}

TALÄ°MAT: YukarÄ±daki tÃ¼m kurallara uyarak, kullanÄ±cÄ±nÄ±n istediÄŸini TAM OLARAK gerÃ§ekleÅŸtir.
`.trim();

            // 5. DEEPSEEK API Ã‡AÄRISI
            console.log('ğŸ“¡ DeepSeek API Ã§aÄŸrÄ±sÄ± yapÄ±lÄ±yor...');
            
            try {
              const response = await fetch('https://api.deepseek.com/chat/completions', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${apiKey}`,
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                  model: 'deepseek-chat',
                  messages: [
                    {
                      role: 'system',
                      content: systemPrompt
                    },
                    {
                      role: 'user',
                      content: `PROJE: ${context.repo.owner}/${context.repo.repo}\nKOMUT: ${userCommand}\n\nLÃ¼tfen gerekli tÃ¼m dosyalarÄ± oluÅŸtur.`
                    }
                  ],
                  max_tokens: 32000,
                  temperature: 0.2
                })
              });
              
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`API HatasÄ±: ${response.status} - ${errorText}`);
              }
              
              const data = await response.json();
              const aiResponse = data.choices[0]?.message?.content || '';
              
              if (!aiResponse) {
                throw new Error('AI boÅŸ yanÄ±t dÃ¶ndÃ¼rdÃ¼');
              }
              
              console.log(`âœ… AI yanÄ±tÄ± alÄ±ndÄ± (${aiResponse.length} karakter)`);
              
              // 6. AI YANITINDAN DOSYALARI Ã‡IKAR VE UYGULA
              console.log('ğŸ”„ Dosyalar iÅŸleniyor...');
              
              // Dosya pattern'ini bul: ### DOSYA: ... ``` ... ```
              const fileRegex = /### DOSYA:\s*(.+?)\s*\n```(?:[a-z]+)?\n([\s\S]*?)\n```/g;
              let match;
              const createdFiles = [];
              const updatedFiles = [];
              
              while ((match = fileRegex.exec(aiResponse)) !== null) {
                const filePath = match[1].trim();
                let fileContent = match[2].trim();
                
                // EÄŸer ilk satÄ±rda dil belirtilmiÅŸse onu kaldÄ±r
                const lines = fileContent.split('\n');
                if (lines[0] && lines[0].match(/^[a-zA-Z]+$/)) {
                  lines.shift(); // Ä°lk satÄ±rÄ± kaldÄ±r
                  fileContent = lines.join('\n');
                }
                
                console.log(`ğŸ“ Ä°ÅŸleniyor: ${filePath} (${fileContent.length} karakter)`);
                
                try {
                  // Dosya var mÄ± kontrol et
                  let sha;
                  try {
                    const { data: existing } = await github.rest.repos.getContent({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      path: filePath
                    });
                    sha = existing.sha;
                  } catch (e) {
                    sha = undefined;
                  }
                  
                  // DosyayÄ± oluÅŸtur veya gÃ¼ncelle
                  await github.rest.repos.createOrUpdateFileContents({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: filePath,
                    message: `ğŸ¤– AI Agent: ${userCommand.substring(0, 50)}...`,
                    content: Buffer.from(fileContent).toString('base64'),
                    sha: sha || undefined
                  });
                  
                  if (sha) {
                    updatedFiles.push(filePath);
                  } else {
                    createdFiles.push(filePath);
                  }
                  
                  console.log(`   ${sha ? 'ğŸ”„ GÃ¼ncellendi' : 'âœ… OluÅŸturuldu'}`);
                  
                } catch (fileError) {
                  console.error(`   âŒ Hata: ${fileError.message}`);
                }
              }
              
              // 7. SONUÃ‡LARI DÃ–NDÃœR
              const result = {
                success: true,
                totalFiles: createdFiles.length + updatedFiles.length,
                created: createdFiles,
                updated: updatedFiles,
                aiResponsePreview: aiResponse.substring(0, 2000) + (aiResponse.length > 2000 ? '...' : '')
              };
              
              core.setOutput('files_created', createdFiles.length.toString());
              core.setOutput('files_updated', updatedFiles.length.toString());
              core.setOutput('total_files', result.totalFiles.toString());
              core.setOutput('ai_preview', result.aiResponsePreview);
              
              return result;
              
            } catch (error) {
              console.error('âŒ AI Motoru HatasÄ±:', error);
              core.setFailed(`AI Motoru HatasÄ±: ${error.message}`);
              return {
                success: false,
                error: error.message
              };
            }

      # 3. SONUÃ‡ RAPORU
      - name: ğŸ“ˆ SONUÃ‡ RAPORU
        if: always()
        uses: actions/github-script@v7
        env:
          FILES_CREATED: ${{ steps.ai_engine.outputs.files_created }}
          FILES_UPDATED: ${{ steps.ai_engine.outputs.files_updated }}
          TOTAL_FILES: ${{ steps.ai_engine.outputs.total_files }}
          AI_PREVIEW: ${{ steps.ai_engine.outputs.ai_preview }}
          USER_COMMAND: ${{ github.event.inputs.command || github.event.comment.body || github.event.issue.body }}
        with:
          script: |
            const issueNumber = context.payload.issue?.number || 
                               (context.payload.comment ? context.payload.comment.issue_number : null);
            
            if (!issueNumber) return;
            
            const filesCreated = parseInt(process.env.FILES_CREATED || '0');
            const filesUpdated = parseInt(process.env.FILES_UPDATED || '0');
            const totalFiles = parseInt(process.env.TOTAL_FILES || '0');
            const aiPreview = process.env.AI_PREVIEW || '';
            const userCommand = process.env.USER_COMMAND || '';
            
            let report = `# ğŸ¤– UNIVERSAL AI AGENT - Ä°ÅLEM TAMAMLANDI\n\n`;
            
            report += `## ğŸ“ KULLANICI KOMUTU\n\`\`\`\n${userCommand}\n\`\`\`\n\n`;
            
            report += `## ğŸ“Š DOSYA Ä°STATÄ°STÄ°KLERÄ°\n`;
            report += `- **Toplam Ä°ÅŸlenen Dosya:** ${totalFiles}\n`;
            report += `- **Yeni OluÅŸturulan:** ${filesCreated}\n`;
            report += `- **GÃ¼ncellenen:** ${filesUpdated}\n\n`;
            
            if (totalFiles > 0) {
              report += `## âœ… BAÅARILI\n`;
              report += `AI Agent talimatÄ±nÄ±zÄ± iÅŸledi ve gerekli dosyalarÄ± oluÅŸturdu/gÃ¼ncelledi.\n`;
              report += `DeÄŸiÅŸiklikleri GitHub'da gÃ¶rebilirsiniz.\n\n`;
            } else {
              report += `## âš ï¸ UYARI\n`;
              report += `AI yanÄ±t verdi ancak dosya oluÅŸturulamadÄ±.\n`;
              report += `TalimatÄ±nÄ±zÄ± daha net verin veya mevcut projeyi geliÅŸtirmesini isteyin.\n\n`;
            }
            
            if (aiPreview) {
              report += `## ğŸ§  AI YANIT Ã–ZETÄ°\n`;
              report += `<details>\n<summary>TÄ±klayarak AI analizini gÃ¶rÃ¼ntÃ¼leyin</summary>\n\n`;
              report += `\`\`\`\n${aiPreview}\n\`\`\`\n`;
              report += `</details>\n\n`;
            }
            
            report += `## ğŸš€ SONRAKÄ° ADIMLAR\n`;
            report += `1. Dosya deÄŸiÅŸikliklerini inceleyin\n`;
            report += `2. Gerekirse yerel makinenize Ã§ekin (\`git pull\`)\n`;
            report += `3. Projeyi test edin\n`;
            report += `4. Yeni bir Issue aÃ§arak daha fazla geliÅŸtirme isteyin\n\n`;
            
            report += `---\n*Bu rapor Universal AI Agent tarafÄ±ndan otomatik oluÅŸturuldu.*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: report
            });

      # 4. Ä°ÅLEM TAMAM
      - name: ğŸ Ä°ÅLEM TAMAMLANDI
        if: always()
        run: |
          echo "========================================"
          echo "ğŸ¤– UNIVERSAL AI AGENT Ä°ÅLEMÄ° TAMAMLANDI"
          echo "========================================"
          echo ""
          echo "ğŸ“Š SonuÃ§lar:"
          echo "- OluÅŸturulan dosya: ${{ steps.ai_engine.outputs.files_created || 0 }}"
          echo "- GÃ¼ncellenen dosya: ${{ steps.ai_engine.outputs.files_updated || 0 }}"
          echo "- Toplam iÅŸlem: ${{ steps.ai_engine.outputs.total_files || 0 }}"
          echo ""
          echo "âœ… AI Agent gÃ¶revini tamamladÄ±."
          echo "ğŸ“ Detaylar iÃ§in Issue yorumlarÄ±nÄ± kontrol edin."
