name: DeepSeek Ultimate Agent v13
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  actions: write

jobs:
  ultimate_agent:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.actor != 'github-actions[bot]'
    
    steps:
      - name: ğŸš€ Tam Yetkili BaÅŸlangÄ±Ã§
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: ğŸ”§ TÃ¼m Gerekli AraÃ§larÄ± Kur
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            curl wget git unzip \
            build-essential \
            openjdk-17-jdk \
            nodejs npm \
            python3 python3-pip python3-venv \
            docker.io docker-compose \
            jq
          
          # Node.js gÃ¼ncelle
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          
          # Python gÃ¼ncelle
          pip3 install --upgrade pip
          
          echo "âœ… TÃ¼m araÃ§lar kuruldu"
          
      - name: ğŸ“ Proje Analizi ve Context Toplama
        id: collect_context
        run: |
          echo "ğŸ” Proje analizi baÅŸlatÄ±lÄ±yor..."
          
          # Proje boyutunu kontrol et (Ã§ok bÃ¼yÃ¼kse sÄ±nÄ±rla)
          find . -type f -name "*.json" -o -name "*.js" -o -name "*.py" -o -name "*.java" -o -name "*.kt" -o -name "*.gradle" -o -name "*.xml" -o -name "*.md" | head -50 > important_files.txt
          
          # Kritik dosyalarÄ± oku
          echo "=== PROJE DOSYALARI ===" > project_context.txt
          while IFS= read -r file; do
            if [ -f "$file" ]; then
              echo "" >> project_context.txt
              echo "ğŸ“„ $file:" >> project_context.txt
              head -200 "$file" >> project_context.txt
              if [ $(wc -l < "$file") -gt 200 ]; then
                echo "... [dosya devam ediyor] ..." >> project_context.txt
              fi
            fi
          done < important_files.txt
          
          # Proje tipini belirle
          if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ]; then
            echo "ANDROID_PROJECT=true" >> $GITHUB_ENV
            echo "Proje tipi: Android" >> project_context.txt
          elif [ -f "package.json" ]; then
            echo "NODEJS_PROJECT=true" >> $GITHUB_ENV
            echo "Proje tipi: Node.js" >> project_context.txt
          elif [ -f "pom.xml" ]; then
            echo "MAVEN_PROJECT=true" >> $GITHUB_ENV
            echo "Proje tipi: Java Maven" >> project_context.txt
          elif [ -f "Cargo.toml" ]; then
            echo "RUST_PROJECT=true" >> $GITHUB_ENV
            echo "Proje tipi: Rust" >> project_context.txt
          elif [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            echo "PYTHON_PROJECT=true" >> $GITHUB_ENV
            echo "Proje tipi: Python" >> project_context.txt
          fi
          
          echo "CONTEXT_FILE=project_context.txt" >> $GITHUB_ENV
          echo "âœ… Proje analizi tamamlandÄ±"
          
      - name: ğŸ—ï¸ Otomatik Derleme Denemesi
        id: build_attempt
        continue-on-error: true
        run: |
          echo "ğŸ—ï¸ Otomatik derleme baÅŸlatÄ±lÄ±yor..."
          
          # Build log dosyasÄ±
          BUILD_LOG="build_output.txt"
          echo "=== DERLEME LOGU ===" > $BUILD_LOG
          echo "BaÅŸlangÄ±Ã§: $(date)" >> $BUILD_LOG
          
          # Android derleme
          if [ "$ANDROID_PROJECT" = "true" ]; then
            echo "" >> $BUILD_LOG
            echo "ğŸ“± ANDROID DERLEMESÄ°:" >> $BUILD_LOG
            chmod +x gradlew 2>/dev/null || true
            ./gradlew clean assembleDebug --no-daemon 2>&1 | tail -100 >> $BUILD_LOG || true
          fi
          
          # Node.js derleme
          if [ "$NODEJS_PROJECT" = "true" ]; then
            echo "" >> $BUILD_LOG
            echo "ğŸŸ¢ NODE.JS DERLEMESÄ°:" >> $BUILD_LOG
            npm install --silent 2>&1 | tail -50 >> $BUILD_LOG || true
            npm run build 2>&1 | tail -50 >> $BUILD_LOG || true
          fi
          
          # Python derleme
          if [ "$PYTHON_PROJECT" = "true" ]; then
            echo "" >> $BUILD_LOG
            echo "ğŸ PYTHON KURULUMU:" >> $BUILD_LOG
            pip3 install -r requirements.txt 2>&1 | tail -50 >> $BUILD_LOG || true
          fi
          
          echo "" >> $BUILD_LOG
          echo "BitiÅŸ: $(date)" >> $BUILD_LOG
          
          # HatalarÄ± ayÄ±kla
          grep -i "error\|fail\|exception\|undefined" $BUILD_LOG | head -20 > build_errors.txt || true
          
          echo "BUILD_DONE=true" >> $GITHUB_ENV
          echo "âœ… Derleme denemesi tamamlandÄ±"
          
      - name: ğŸ§  DEEPSEEK ULTIMATE BRAIN - TAM OTOMASYON
        id: deepseek_brain
        uses: actions/github-script@v7
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          BUILD_LOG: ${{ steps.build_attempt.outputs.BUILD_LOG || 'No build log' }}
          BUILD_ERRORS: ${{ steps.build_attempt.outputs.BUILD_ERRORS || 'No errors' }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            console.log("ğŸ§  DEEPSEEK ULTIMATE BRAIN v13 AKTÄ°VASYON");
            
            // API Key kontrolÃ¼
            const apiKey = process.env.DEEPSEEK_API_KEY?.trim();
            if (!apiKey) {
              throw new Error("âŒ DEEPSEEK_API_KEY eksik! GitHub Secrets'a ekleyin.");
            }
            
            // KullanÄ±cÄ± mesajÄ±nÄ± al
            const userMessage = context.payload.comment?.body || context.payload.issue.body || "";
            
            // Proje context'ini oku
            let projectContext = "";
            try {
              projectContext = fs.readFileSync('project_context.txt', 'utf8');
            } catch (e) {
              projectContext = "Proje context dosyasÄ± bulunamadÄ±";
            }
            
            // Build logunu oku
            let buildLog = "";
            try {
              buildLog = fs.readFileSync('build_output.txt', 'utf8');
            } catch (e) {
              buildLog = "Build log bulunamadÄ±";
            }
            
            // ULTIMATE SYSTEM PROMPT
            const systemPrompt = `Sen DeepSeek Ultimate Agent v13'sin. TÃœM gÃ¶revleri tamamlayacak gÃ¼ce sahipsin.

            MUTLAK KURALLAR:
            1. ASLA "burayÄ± sen tamamla" deme
            2. ASLA yarÄ±m bÄ±rakma
            3. TÃœM kodlarÄ± tam ve Ã§alÄ±ÅŸÄ±r ÅŸekilde ver
            4. TÃœM dosyalarÄ± oluÅŸtur
            5. TÃœM hatalarÄ± dÃ¼zelt
            
            GÃ–REV TÄ°PLERÄ°:
            - Android projesi: build.gradle, Manifest, Java/Kotlin kodlarÄ±
            - Web projesi: HTML, CSS, JavaScript, Node.js
            - Python projesi: .py dosyalarÄ±, requirements.txt
            - DiÄŸer: Her tÃ¼rlÃ¼ programlama dili
            
            Ã‡IKTI FORMATI (KESÄ°NLÄ°KLE BU FORMATI KULLAN):
            ---FILENAME: dosya/yolu/dosya.uzanti---
            [TAM KOD BURAYA]
            ---END_OF_FILE---
            
            Birden fazla dosya iÃ§in bu formatÄ± tekrarla.
            
            Ã–RNEK:
            ---FILENAME: app/build.gradle---
            plugins {
                id 'com.android.application'
            }
            android {
                compileSdk 34
                // ... tam kod
            }
            ---END_OF_FILE---`;
            
            // API Ä°steÄŸi
            const response = await fetch("https://api.deepseek.com/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${apiKey}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model: "deepseek-chat",
                messages: [
                  {
                    role: "system",
                    content: systemPrompt
                  },
                  {
                    role: "user",
                    content: `ğŸ¯ GÃ–REV: ${userMessage}
                    
                    ğŸ“Š PROJE DURUMU:
                    ${projectContext.substring(0, 10000)}
                    
                    ğŸ—ï¸ DERLEME LOGU:
                    ${buildLog.substring(0, 5000)}
                    
                    âš¡ TALÄ°MAT: 
                    1. TÃœM istediklerini yap
                    2. TÃœM dosyalarÄ± oluÅŸtur
                    3. TÃœM hatalarÄ± dÃ¼zelt
                    4. Projeyi Ã‡ALIÅIR hale getir
                    5. Eksik NE varsa TAMAMLA`
                  }
                ],
                stream: false,
                max_tokens: 16000,
                temperature: 0.1
              })
            });
            
            if (!response.ok) {
              const errorText = await response.text();
              console.error("API HatasÄ±:", errorText);
              throw new Error(`DeepSeek API HatasÄ±: ${response.status}`);
            }
            
            const data = await response.json();
            const aiResponse = data.choices[0]?.message?.content || "";
            
            console.log(`âœ… AI YanÄ±tÄ± AlÄ±ndÄ±: ${aiResponse.length} karakter`);
            
            // Dosya iÅŸlemleri
            const fileRegex = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
            let match;
            const processedFiles = [];
            
            while ((match = fileRegex.exec(aiResponse)) !== null) {
              const fileName = match[1].trim();
              const fileContent = match[2].trim();
              
              try {
                // Dizin oluÅŸtur
                const dir = path.dirname(fileName);
                if (dir && !fs.existsSync(dir)) {
                  fs.mkdirSync(dir, { recursive: true });
                }
                
                // DosyayÄ± yaz
                fs.writeFileSync(fileName, fileContent, 'utf8');
                processedFiles.push(fileName);
                console.log(`âœ… Dosya oluÅŸturuldu: ${fileName}`);
              } catch (error) {
                console.error(`âŒ Dosya hatasÄ± ${fileName}:`, error.message);
              }
            }
            
            // EÄŸer hiÃ§ dosya yoksa, en azÄ±ndan bir README oluÅŸtur
            if (processedFiles.length === 0 && aiResponse.length > 100) {
              const readmeContent = `# DeepSeek Agent Raporu\n\n${aiResponse.substring(0, 3000)}`;
              fs.writeFileSync('DEEPSEEK_REPORT.md', readmeContent);
              processedFiles.push('DEEPSEEK_REPORT.md');
            }
            
            return {
              aiResponse: aiResponse.substring(0, 5000),
              processedFiles: processedFiles.join(','),
              fileCount: processedFiles.length.toString()
            };
            
      - name: âš¡ KOMUT Ã‡ALIÅTIRMA ve DERLEME
        id: execute_commands
        run: |
          echo "âš¡ AI'nin oluÅŸturduÄŸu dosyalar derleniyor..."
          
          # Android projesi iÃ§in
          if [ "$ANDROID_PROJECT" = "true" ]; then
            echo "ğŸ“± Android derleme baÅŸlatÄ±lÄ±yor..."
            if [ -f "gradlew" ]; then
              chmod +x gradlew
              ./gradlew clean assembleDebug --no-daemon 2>&1 | tail -100 || true
            fi
          fi
          
          # Node.js projesi iÃ§in
          if [ "$NODEJS_PROJECT" = "true" ]; then
            echo "ğŸŸ¢ Node.js baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            npm install --silent 2>&1 | tail -50 || true
            if [ -f "package.json" ]; then
              echo "ğŸŸ¢ Node.js build Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
              npm run build 2>&1 | tail -50 || true
            fi
          fi
          
          # Python projesi iÃ§in
          if [ "$PYTHON_PROJECT" = "true" ]; then
            echo "ğŸ Python baÄŸÄ±mlÄ±lÄ±klarÄ± kuruluyor..."
            pip3 install -r requirements.txt 2>&1 | tail -50 || true
            if [ -f "main.py" ] || [ -f "app.py" ]; then
              echo "ğŸ Python script Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor..."
              python3 main.py 2>&1 || python3 app.py 2>&1 || true
            fi
          fi
          
          echo "âœ… TÃ¼m komutlar Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±"
          
      - name: ğŸ“¤ DEÄÄ°ÅÄ°KLÄ°KLERÄ° COMMIT ET
        id: commit_changes
        run: |
          echo "ğŸ“¤ DeÄŸiÅŸiklikler commit ediliyor..."
          
          git config --global user.email "deepseek-agent@github.com"
          git config --global user.name "DeepSeek AI Agent"
          
          # DeÄŸiÅŸiklikleri kontrol et
          git status
          
          # TÃ¼m dosyalarÄ± ekle
          git add .
          
          # Commit mesajÄ± oluÅŸtur
          COMMIT_MSG="ğŸ¤– DeepSeek Ultimate Agent v13 - Otomatik gÃ¼ncelleme\n\n"
          COMMIT_MSG+="- AI tarafÄ±ndan dosyalar oluÅŸturuldu/dÃ¼zenlendi\n"
          COMMIT_MSG+="- Otomatik derleme yapÄ±ldÄ±\n"
          COMMIT_MSG+="- TÃ¼m gÃ¶revler tamamlandÄ±\n"
          COMMIT_MSG+="\nTimestamp: $(date)"
          
          # Commit ve push
          git commit -m "$COMMIT_MSG" || echo "âš ï¸ Commit yapÄ±lamadÄ± (deÄŸiÅŸiklik yok olabilir)"
          git push || echo "âš ï¸ Push yapÄ±lamadÄ±"
          
          echo "âœ… DeÄŸiÅŸiklikler gÃ¶nderildi"
          
      - name: ğŸ“Š DETAYLI RAPOR OLUÅTUR
        uses: actions/github-script@v7
        env:
          AI_RESPONSE: ${{ steps.deepseek_brain.outputs.aiResponse }}
          FILE_COUNT: ${{ steps.deepseek_brain.outputs.fileCount }}
          PROCESSED_FILES: ${{ steps.deepseek_brain.outputs.processedFiles }}
        with:
          script: |
            const aiResponse = process.env.AI_RESPONSE || "";
            const fileCount = process.env.FILE_COUNT || "0";
            const processedFiles = process.env.PROCESSED_FILES?.split(',').filter(Boolean) || [];
            
            // DetaylÄ± rapor oluÅŸtur
            let report = `## ğŸ¤– DEEPSEEK ULTIMATE AGENT v13 - TAM RAPOR\n\n`;
            report += `**ğŸ•’ Zaman:** ${new Date().toLocaleString('tr-TR')}\n`;
            report += `**âœ… Durum:** TÃ¼m iÅŸlemler tamamlandÄ±\n\n`;
            
            // Ä°statistikler
            report += `### ğŸ“Š Ä°STATÄ°STÄ°KLER\n`;
            report += `| Metrik | DeÄŸer |\n|--------|-------|\n`;
            report += `| Ä°ÅŸlenen Dosya | ${fileCount} adet |\n`;
            report += `| AI YanÄ±t UzunluÄŸu | ${aiResponse.length} karakter |\n`;
            report += `| Proje Tipi | ${process.env.ANDROID_PROJECT ? 'Android ğŸ“±' : process.env.NODEJS_PROJECT ? 'Node.js ğŸŸ¢' : process.env.PYTHON_PROJECT ? 'Python ğŸ' : 'DiÄŸer ğŸ¤–'} |\n`;
            
            // Ä°ÅŸlenen dosyalar
            if (processedFiles.length > 0) {
              report += `\n### ğŸ“ OLUÅTURULAN/GÃœNCELLENEN DOSYALAR\n`;
              processedFiles.forEach(file => {
                report += `- âœ… \`${file}\`\n`;
              });
            }
            
            // AI YanÄ±tÄ± (kÄ±saltÄ±lmÄ±ÅŸ)
            if (aiResponse.length > 100) {
              const preview = aiResponse.length > 2000 ? 
                aiResponse.substring(0, 2000) + "\n\n... [devamÄ± var] ..." : 
                aiResponse;
              
              report += `\n### ğŸ§  AI ANALÄ°Z Ã–ZETÄ°\n`;
              report += `<details>\n<summary>ğŸ“ TÄ±klayarak detaylarÄ± gÃ¶r (${aiResponse.length} karakter)</summary>\n\n`;
              report += `\`\`\`\n${preview}\n\`\`\`\n`;
              report += `</details>\n`;
            }
            
            // Sonraki adÄ±mlar
            report += `\n### ğŸ¯ SONRAKÄ° ADIMLAR\n`;
            
            if (process.env.ANDROID_PROJECT === 'true') {
              report += `ğŸ“± **Android iÃ§in:**\n`;
              report += `1. APK'yÄ± al: \`./gradlew assembleRelease\`\n`;
              report += `2. APK yolu: \`app/build/outputs/apk/\`\n`;
              report += `3. Test et: \`./gradlew test\`\n`;
            } else if (process.env.NODEJS_PROJECT === 'true') {
              report += `ğŸŸ¢ **Node.js iÃ§in:**\n`;
              report += `1. Ã‡alÄ±ÅŸtÄ±r: \`npm start\` veya \`node index.js\`\n`;
              report += `2. Test et: \`npm test\`\n`;
            } else if (process.env.PYTHON_PROJECT === 'true') {
              report += `ğŸ **Python iÃ§in:**\n`;
              report += `1. Ã‡alÄ±ÅŸtÄ±r: \`python3 main.py\`\n`;
              report += `2. Sanal ortam: \`python3 -m venv venv\`\n`;
            }
            
            report += `\n---\n`;
            report += `*Bu rapor DeepSeek Ultimate Agent v13 tarafÄ±ndan otomatik oluÅŸturuldu*\n`;
            report += `*Her tÃ¼rlÃ¼ projede Ã§alÄ±ÅŸÄ±r - Android, Web, Python, Java, vs.*`;
            
            // Yorum olarak ekle
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: report
            });
            
            // Issue'yu kapat (opsiyonel)
            try {
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                state: 'closed'
              });
            } catch (e) {
              // KapatÄ±lamazsa sorun deÄŸil
            }
