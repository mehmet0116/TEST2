name: DeepSeek Ultimate

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Yapılacak görev'
        required: true
        type: string
  push:
    branches:
      - main
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  deepseek:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GIT_COMMITTER_NAME: "github-actions[bot]"
      GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Git Yapilandirmasi
        run: |
          git config --global user.name "${GIT_COMMITTER_NAME}"
          git config --global user.email "${GIT_COMMITTER_EMAIL}"

      - name: Proje Tipi Algilama
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let projectType = 'general';
            let projectDetails = [];
            if (fs.existsSync('build.gradle') || fs.existsSync('app/build.gradle') ||
                fs.existsSync('build.gradle.kts') || fs.existsSync('settings.gradle') ||
                fs.existsSync('settings.gradle.kts')) {
              projectType = 'android';
              projectDetails.push('Android/Kotlin');
            }
            if (fs.existsSync('package.json')) {
              if (projectType === 'general') projectType = 'node';
              projectDetails.push('Node.js/JavaScript');
            }
            if (fs.existsSync('requirements.txt') || fs.existsSync('pyproject.toml') ||
                fs.existsSync('setup.py') || fs.existsSync('Pipfile')) {
              if (projectType === 'general') projectType = 'python';
              projectDetails.push('Python');
            }
            if (fs.existsSync('CMakeLists.txt') || fs.existsSync('Makefile') ||
                fs.existsSync('meson.build')) {
              if (projectType === 'general') projectType = 'cpp';
              projectDetails.push('C/C++');
            }
            if (fs.existsSync('Cargo.toml')) {
              if (projectType === 'general') projectType = 'rust';
              projectDetails.push('Rust');
            }
            if (fs.existsSync('go.mod')) {
              if (projectType === 'general') projectType = 'go';
              projectDetails.push('Go');
            }
            console.log('Tespit Edilen Tip: ' + projectType);
            console.log('Detaylar: ' + (projectDetails.join(', ') || 'Genel Proje'));
            core.setOutput('type', projectType);
            core.setOutput('details', projectDetails.join(', ') || 'Genel Proje');

      - name: Model Selection
        id: model_selector
        run: |
          TASK="${{ github.event.inputs.task }}"
          
          if echo "$TASK" | grep -iE "(migrasi|refactor|optimize|kompleks|yapı|arch|design|pattern|benchmark|performance|security|debug|investigate|critical|enhance|improve|transform|restructure|migration|integration|planning|strategy)" > /dev/null; then
            echo "model=deepseek-reasoner" >> $GITHUB_OUTPUT
          else
            echo "model=deepseek-chat" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python for DeepSeek
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install OpenAI SDK
        run: pip install openai

      - name: DeepSeek Kodlama Motoru
        id: deepseek
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_TASK: ${{ github.event.inputs.task || (github.event.comment && github.event.comment.body) || (github.event.issue && github.event.issue.body) || 'Proje optimize et' }}
          MODEL: ${{ steps.model_selector.outputs.model }}
          PROJECT_TYPE: ${{ steps.detect.outputs.type }}
          PROJECT_DETAILS: ${{ steps.detect.outputs.details }}
        run: |
          python3 << 'PYTHON_EOF'
          import os
          import sys
          import json
          import re
          from pathlib import Path
          from openai import OpenAI

          client = OpenAI(
              api_key=os.environ.get('DEEPSEEK_API_KEY'),
              base_url="https://api.deepseek.com"
          )

          fileList = []
          repoContext = ""

          ignoreDirs = {'.git', 'node_modules', 'build', 'dist', '.gradle', 'venv', '__pycache__', 'target', '.idea', '.vscode', 'bin', 'obj', 'out', 'vendor'}
          codeExtensions = {'.js', '.ts', '.jsx', '.tsx', '.mjs', '.cjs', '.py', '.pyw', '.pyi', '.java', '.kt', '.kts', '.scala', '.cpp', '.cc', '.cxx', '.c', '.h', '.hpp', '.hxx', '.cs', '.fs', '.vb', '.go', '.rs', '.rb', '.php', '.swift', '.m', '.mm', '.xml', '.json', '.yaml', '.yml', '.toml', '.html', '.css', '.scss', '.sass', '.less', '.md', '.txt', '.rst', '.gradle', '.properties', '.pro', '.sql', '.sh', '.bash', '.zsh', '.ps1', '.dockerfile'}

          def scanDirectory(directory, depth=0):
              global fileList, repoContext
              if depth > 10 or not Path(directory).exists():
                  return
              
              try:
                  for item in Path(directory).iterdir():
                      if item.name.startswith('.') and item.name != '.gitignore':
                          continue
                      
                      if item.is_dir():
                          if item.name not in ignoreDirs:
                              scanDirectory(item, depth + 1)
                      elif item.is_file():
                          if item.suffix.lower() in codeExtensions or item.name in ['Dockerfile', 'Makefile', 'CMakeLists.txt']: 
                              try:
                                  content = item.read_text(encoding='utf-8')
                                  if len(content) < 100000:
                                      relPath = str(item.relative_to('.'))
                                      repoContext += f"\n=== {relPath} ===\n{content}\n"
                                      fileList.append(relPath)
                              except:
                                  pass
              except:
                  pass

          scanDirectory('.')
          print(f"Taranan dosya: {len(fileList)}")

          systemPrompt = f"""Sen DeepSeek V3.2, dünya standardında profesyonel yazılım mühendisisin. 

          PROJE BILGISI:
          - Tip: {os.environ.get('PROJECT_TYPE')}
          - Detaylar: {os.environ.get('PROJECT_DETAILS')}

          GÖREV:
          {os.environ.get('USER_TASK')}

          DOSYA YAZMA FORMATI:
          ---FILE: dosya/yolu/isim.uzanti---
          [dosya içeriği]
          ---END---

          DOSYA SILME FORMATI:
          ---DELETE: dosya/yolu/isim.uzanti---
          ---END---

          DİZİN SILME FORMATI:
          ---DELETEDIR: klasor/yolu---
          ---END---

          KURALLAR:
          ✅ Tam çalışan, production-ready kod yaz
          ✅ Hata yönetimi ekle
          ✅ Türkçe yorum ekle
          ✅ Best practices uygula
          ❌ Markdown code block kullanma (backtick yok)
          ❌ Eksik kod yazma
          ❌ Placeholder bırakma

          MEVCUT DOSYALAR: {', '.join(fileList[:20]) if fileList else 'Yok'}"""

          try:
              print("DeepSeek API cagrisi basliyor...")
              print(f"Model: {os.environ.get('MODEL')}")
              
              response = client.chat.completions.create(
                  model=os.environ.get('MODEL'),
                  messages=[
                      {"role": "system", "content": systemPrompt},
                      {"role": "user", "content": repoContext or "Bos proje - sifirdan basla"}
                  ],
                  max_tokens=32000,
                  temperature=0.5 if os.environ.get('MODEL') == 'deepseek-reasoner' else 0.7,
                  stream=False
              )
              
              aiResponse = response.choices[0].message.content
              print("AI yaniti alindi")
              
              operations = []
              
              for match in re.finditer(r'---DELETEDIR:\s*(.+?)\s*---', aiResponse):
                  dirPath = match.group(1).strip()
                  if Path(dirPath).exists() and Path(dirPath).is_dir():
                      import shutil
                      shutil.rmtree(dirPath)
                      operations.append(f"Klasor silindi: {dirPath}")
                      print(f"Klasor silindi: {dirPath}")
              
              for match in re.finditer(r'---DELETE:\s*(.+?)\s*---', aiResponse):
                  filePath = match.group(1).strip()
                  if Path(filePath).exists():
                      Path(filePath).unlink()
                      operations.append(f"Dosya silindi: {filePath}")
                      print(f"Dosya silindi: {filePath}")
              
              for match in re.finditer(r'---FILE:\s*(.+?)\s*---\n([\s\S]*?)---END---', aiResponse):
                  filePath = match.group(1).strip()
                  content = match.group(2).strip()
                  
                  dirPath = Path(filePath).parent
                  if dirPath != Path('.'):
                      dirPath.mkdir(parents=True, exist_ok=True)
                  
                  Path(filePath).write_text(content, encoding='utf-8')
                  operations.append(f"Yazildi: {filePath}")
                  print(f"Yazildi: {filePath}")
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"operations<<EOF\n")
                  f.write('\n'.join(operations))
                  f.write(f"\nEOF\n")
                  f.write(f"count={len(operations)}\n")
                  f.write(f"success=true\n")
              
          except Exception as e:
              print(f"Hata: {str(e)}")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"success=false\n")
                  f.write(f"error={str(e)}\n")
              sys.exit(1)
          PYTHON_EOF

      - name: Degisiklikleri Kaydet ve Gonder
        if: steps.deepseek.outputs.success == 'true'
        run: |
          git add -A
          if git diff --cached --quiet; then
            echo "Degisiklik yok, commit yapilmiyor."
          else
            TASK="${{ github.event.inputs.task || (github.event.comment && github.event.comment.body) || (github.event.issue && github.event.issue.body) || 'Otomatik guncelleme' }}"
            TASK_SHORT=$(echo "$TASK" | head -c 100)
            git commit -m "DeepSeek Update: $TASK_SHORT" -m "Islem: ${{ steps.deepseek.outputs.count }}"
            
            # Basit Push (Senkronizasyon yok, direkt gonder)
            git push origin HEAD:${GITHUB_REF##*/}
          fi

      - name: Sonuc Raporu
        uses: actions/github-script@v7
        if: always()
        env:
          OPERATIONS: ${{ steps.deepseek.outputs.operations }}
          SUCCESS: ${{ steps.deepseek.outputs.success }}
          ERROR: ${{ steps.deepseek.outputs.error }}
        with:
          script: |
            const success = process.env.SUCCESS === 'true';
            const operations = process.env.OPERATIONS || 'Islem yapilmadi';
            
            let report = '## DeepSeek Raporu\n';
            report += success ? '✅ **İşlem Başarılı**\n\n' : '❌ **Hata Oluştu**\n\n';
            
            if (operations !== 'Islem yapilmadi') {
              report += '### Değişiklikler\n' + operations + '\n';
            }
            if (!success && process.env.ERROR) {
              report += '### Hata Detayı\n' + process.env.ERROR + '\n';
            }
            
            try {
              if (context.issue && context.issue.number) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: report
                });
              } else {
                core.info(report);
              }
            } catch (e) { console.log(e); }
