name: DEEPSEEK TITAN PRO (v13.0 - STABLE & SECURE)
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      task:
        description: 'GÃ¶rev'
        required: true
        default: 'Projeyi analiz et ve geliÅŸtir'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  deepseek_titan_agent:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: github.actor != 'github-actions[bot]'
    
    steps:
      # ------------------------------------------------------------------
      # 1. ORTAM HAZIRLIÄI
      # ------------------------------------------------------------------
      - name: ğŸš€ Proje KaynaklarÄ±nÄ± Ã‡ek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ•µï¸ Proje Tipini AlgÄ±la
        id: detector
        shell: bash
        run: |
          echo "================================================"
          echo "ğŸ” PROJE ANALÄ°ZÄ° BAÅLIYOR..."
          
          PROJECT_TYPE="general"
          
          if [ -f "build.gradle" ] || [ -f "app/build.gradle" ] || [ -f "build.gradle.kts" ]; then
            PROJECT_TYPE="android"
            echo "âœ… TESPÄ°T: Android Projesi"
            
            # Gradle Wrapper OnarÄ±mÄ±
            if [ ! -f "gradlew" ]; then
              echo "âš ï¸ gradlew yok, oluÅŸturuluyor..."
              gradle wrapper --gradle-version 8.5
            fi
            chmod +x gradlew
            
          elif [ -f "package.json" ]; then
            PROJECT_TYPE="nodejs"
            echo "âœ… TESPÄ°T: Node.js/Web Projesi"
            
          elif [ -f "requirements.txt" ] || [ -f "main.py" ] || [ -f "app.py" ]; then
            PROJECT_TYPE="python"
            echo "âœ… TESPÄ°T: Python Projesi"
          fi
          
          echo "PROJECT_TYPE=$PROJECT_TYPE" >> $GITHUB_ENV

      # ------------------------------------------------------------------
      # 2. PROFESYONEL KURULUMLAR
      # ------------------------------------------------------------------
      - name: â˜• Java 17 (Android iÃ§in)
        if: env.PROJECT_TYPE == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸŸ¢ Node.js 20
        if: env.PROJECT_TYPE == 'nodejs'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ Python 3.10
        if: env.PROJECT_TYPE == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # ------------------------------------------------------------------
      # 3. TITAN BEYNÄ° (GÃœVENLÄ° & AKILLI MOD)
      # ------------------------------------------------------------------
      - name: ğŸ§  DeepSeek TITAN Motoru
        uses: actions/github-script@v7
        id: titan_brain
        env:
          # BURASI KRÄ°TÄ°K: DeÄŸiÅŸkenleri ENV olarak alÄ±yoruz (Hata Ã‡Ã¶zÃ¼mÃ¼)
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          PROJECT_TYPE: ${{ env.PROJECT_TYPE }}
          USER_MSG: ${{ github.event.inputs.task || github.event.comment.body || github.event.issue.body }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            console.log("ğŸš€ [TITAN v13] Motor BaÅŸlatÄ±lÄ±yor...");
            
            // 1. GÃœVENLÄ° VERÄ° ALIMI
            const apiKey = process.env.API_KEY;
            if (!apiKey) throw new Error("API AnahtarÄ± Yok! Secrets kontrol et.");
            
            const projectType = process.env.PROJECT_TYPE;
            const userMsg = process.env.USER_MSG;
            
            // 2. CONTEXT OLUÅTURMA (GÃ¼venli YÃ¶ntem)
            let contextData = `### ğŸ“‚ PROJE TÃœRÃœ: ${projectType.toUpperCase()}\n\n`;
            
            // DosyalarÄ± tara (Sadece gÃ¼venli uzantÄ±lar ve kÃ¼Ã§Ã¼k dosyalar)
            const allowedExts = ['.js', '.json', '.py', '.java', '.kt', '.xml', '.gradle', '.html', '.css', '.md', '.txt', '.yml'];
            let fileCount = 0;
            
            function scan(dir) {
              if (!fs.existsSync(dir)) return;
              const files = fs.readdirSync(dir, { withFileTypes: true });
              for (const file of files) {
                const fullPath = path.join(dir, file.name);
                if (file.isDirectory()) {
                  if (!['node_modules', '.git', 'build', '.gradle', 'venv'].includes(file.name)) scan(fullPath);
                } else {
                  if (allowedExts.includes(path.extname(file.name)) || file.name === 'gradlew') {
                    try {
                      const stat = fs.statSync(fullPath);
                      if (stat.size < 20000) { // 20KB altÄ±
                        const content = fs.readFileSync(fullPath, 'utf8');
                        contextData += `---START_FILE: ${fullPath}---\n${content}\n---END_FILE---\n\n`;
                        fileCount++;
                      }
                    } catch(e) {}
                  }
                }
              }
            }
            scan('.');
            console.log(`ğŸ“š ${fileCount} dosya okunup baÄŸlama eklendi.`);

            // 3. SYSTEM PROMPT
            const systemPrompt = `
            Sen DeepSeek TITAN, profesyonel bir yazÄ±lÄ±m mimarÄ±sÄ±n.
            
            GÃ–REVÄ°N:
            1. KullanÄ±cÄ±nÄ±n isteÄŸini (${userMsg}) analiz et.
            2. Mevcut projeyi (Context) incele.
            3. Hata yapmadan, Ã§alÄ±ÅŸan, tam kodlar Ã¼ret.
            4. "Reasoning" (DÃ¼ÅŸÃ¼nme) yeteneÄŸini kullanarak Ã¶nce planla.
            
            FORMAT KURALLARI (BUNA UY):
            Dosya OluÅŸtur:
            ---FILENAME: dosya_yolu---
            [Kod]
            ---END_OF_FILE---
            
            Dosya Sil:
            ---DELETE: dosya_yolu---
            ---END_DELETE---
            `.trim();

            // 4. API Ä°STEÄÄ° (DeepSeek Reasoner)
            try {
              const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${apiKey}`, 
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "deepseek-reasoner",
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `Ä°STEK: ${userMsg}\n\nCONTEXT:\n${contextData}` }
                  ],
                  stream: false,
                  max_tokens: 8000
                })
              });

              if (!response.ok) {
                 const errTxt = await response.text();
                 throw new Error(`API HatasÄ±: ${errTxt}`);
              }

              const data = await response.json();
              const aiReply = data.choices[0].message.content || "";
              const thinking = data.choices[0].message.reasoning_content || "DÃ¼ÅŸÃ¼nce verisi yok.";
              
              console.log("âš¡ AI CevabÄ± AlÄ±ndÄ±.");
              
              // 5. DOSYA Ä°ÅLEME
              const startRegex = /---FILENAME:\s*(.*?)---\n([\s\S]*?)---END_OF_FILE---/g;
              const delRegex = /---DELETE:\s*(.*?)---\s*---END_DELETE---/g;
              
              let match;
              let createdFiles = [];
              
              // Yazma
              while ((match = startRegex.exec(aiReply)) !== null) {
                const fPath = match[1].trim();
                const fContent = match[2].trim();
                const dir = path.dirname(fPath);
                if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                fs.writeFileSync(fPath, fContent);
                console.log(`âœ… YazÄ±ldÄ±: ${fPath}`);
                createdFiles.push(fPath);
              }
              
              // Silme
              while ((match = delRegex.exec(aiReply)) !== null) {
                const fPath = match[1].trim();
                if (fs.existsSync(fPath)) fs.unlinkSync(fPath);
              }
              
              // Ã‡Ä±ktÄ±larÄ± bir sonraki adÄ±ma aktar (Safe Output)
              // Base64 encode ederek taÅŸÄ±yoruz, bozulmayÄ± Ã¶nler
              core.setOutput('thinking_b64', Buffer.from(thinking).toString('base64'));
              core.setOutput('reply_b64', Buffer.from(aiReply).toString('base64'));
              core.setOutput('files', createdFiles.join(', '));

            } catch (err) {
              console.error("KRÄ°TÄ°K HATA:", err);
              throw err;
            }

      # ------------------------------------------------------------------
      # 4. DEÄÄ°ÅÄ°KLÄ°KLERÄ° KAYDET
      # ------------------------------------------------------------------
      - name: ğŸ’¾ Git Commit & Push
        run: |
          git config --global user.name "DeepSeek TITAN"
          git config --global user.email "bot@deepseek.com"
          git add .
          git commit -m "ğŸ¤– TITAN: Otomatik Kod GeliÅŸtirme" || echo "DeÄŸiÅŸiklik yok."
          git push

      # ------------------------------------------------------------------
      # 5. DERLEME VE TEST (OTOMATÄ°K)
      # ------------------------------------------------------------------
      - name: ğŸ—ï¸ Projeyi Derle
        id: builder
        run: |
          echo "ğŸ”¨ Derleme BaÅŸlÄ±yor..."
          STATUS="ATLANDI"
          
          if [ "${{ env.PROJECT_TYPE }}" == "android" ]; then
            echo "ğŸ“± Android Build..."
            if ./gradlew assembleDebug --stacktrace; then
              STATUS="BAÅARILI"
            else
              STATUS="BAÅARISIZ"
            fi
            
          elif [ "${{ env.PROJECT_TYPE }}" == "nodejs" ]; then
            echo "ğŸŸ¢ Node.js Build..."
            npm install
            if npm run build --if-present; then
              STATUS="BAÅARILI"
            else
              STATUS="BAÅARISIZ"
            fi
            
          elif [ "${{ env.PROJECT_TYPE }}" == "python" ]; then
            echo "ğŸ Python Syntax Check..."
            if python3 -m py_compile *.py; then
              STATUS="BAÅARILI"
            else
              STATUS="BAÅARISIZ"
            fi
          fi
          
          echo "BUILD_STATUS=$STATUS" >> $GITHUB_ENV
        continue-on-error: true

      # ------------------------------------------------------------------
      # 6. SONUÃ‡LARI YÃœKLE (APK vb.)
      # ------------------------------------------------------------------
      - name: ğŸ“¤ Artifact Upload (Android)
        if: env.PROJECT_TYPE == 'android'
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk

      # ------------------------------------------------------------------
      # 7. RAPORLAMA
      # ------------------------------------------------------------------
      - name: ğŸ“Š Rapor Yaz
        uses: actions/github-script@v7
        env:
          THINKING_B64: ${{ steps.titan_brain.outputs.thinking_b64 }}
          REPLY_B64: ${{ steps.titan_brain.outputs.reply_b64 }}
          FILES: ${{ steps.titan_brain.outputs.files }}
          BUILD_STATUS: ${{ env.BUILD_STATUS }}
        with:
          script: |
            const decode = (str) => {
              try { return Buffer.from(str || '', 'base64').toString('utf-8'); } catch(e) { return "Veri yok"; }
            };
            
            const thinking = decode(process.env.THINKING_B64);
            const reply = decode(process.env.REPLY_B64);
            const files = process.env.FILES || "Dosya deÄŸiÅŸmedi.";
            const buildStatus = process.env.BUILD_STATUS;
            
            let body = `### ğŸ›ï¸ DEEPSEEK TITAN PRO RAPORU\n\n`;
            
            body += `<details><summary>ğŸ§  <b>Modelin DÃ¼ÅŸÃ¼nce SÃ¼reci (TÄ±kla)</b></summary>\n\n\`\`\`text\n${thinking.substring(0, 5000)}...\n\`\`\`\n</details>\n\n`;
            
            body += `#### ğŸ› ï¸ Ä°ÅŸlem Ã–zeti:\n`;
            body += `- **Ä°ÅŸlenen Dosyalar:** ${files}\n`;
            body += `- **Derleme Durumu:** ${buildStatus == 'BAÅARILI' ? 'âœ… BAÅARILI' : 'âŒ ' + buildStatus}\n\n`;
            
            body += `#### ğŸ’¬ Cevap:\n${reply.substring(0, 2000)}...\n\n`;
            
            if (process.env.PROJECT_TYPE == 'android' && buildStatus == 'BAÅARILI') {
              body += `ğŸ‰ **APK HazÄ±r!** SayfanÄ±n Ã¼st kÄ±smÄ±ndaki 'Artifacts' bÃ¶lÃ¼mÃ¼nden indirebilirsiniz.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
