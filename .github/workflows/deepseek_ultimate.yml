name: DeepSeek Ultimate CI

on:
  workflow_dispatch:
    inputs:
      task:
        description: "DeepSeek'e verilecek görev"
        required: false
        default: ""
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  deepseek:
    runs-on: ubuntu-latest

    steps:
      - name: Depoyu Cek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Git Yapilandirmasi
        run: |
          git config --global user.name "DeepSeek Ultimate"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global pull.rebase false
          git config --global push.autoSetupRemote true

      - name: Senkronizasyon
        run: |
          echo "Uzak degisiklikler kontrol ediliyor..."
          git fetch origin || true
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
          if [ -z "$CURRENT_BRANCH" ] || [ "$CURRENT_BRANCH" = "HEAD" ]; then
            # fallback to default branch if detached
            CURRENT_BRANCH="${GITHUB_REF##*/}"
          fi
          echo "Mevcut dal: $CURRENT_BRANCH"
          if git ls-remote --exit-code origin "$CURRENT_BRANCH" >/dev/null 2>&1; then
            if git diff --quiet HEAD origin/$CURRENT_BRANCH 2>/dev/null; then
              echo "Yerel ve uzak senkronize."
            else
              echo "Uzak degisiklikler birlestiriliyor..."
              git pull origin "$CURRENT_BRANCH" --no-edit --strategy-option=ours || true
            fi
          else
            echo "Uzakta $CURRENT_BRANCH dalı bulunamadi; devam ediliyor."
          fi

      - name: Proje Tipi Algilama
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let projectType = 'general';
            let projectDetails = [];
            if (fs.existsSync('build.gradle') || fs.existsSync('app/build.gradle') ||
                fs.existsSync('build.gradle.kts') || fs.existsSync('settings.gradle') ||
                fs.existsSync('settings.gradle.kts')) {
              projectType = 'android';
              projectDetails.push('Android/Kotlin');
            }
            if (fs.existsSync('package.json')) {
              if (projectType === 'general') projectType = 'node';
              projectDetails.push('Node.js/JavaScript');
            }
            if (fs.existsSync('requirements.txt') || fs.existsSync('pyproject.toml') ||
                fs.existsSync('setup.py') || fs.existsSync('Pipfile')) {
              if (projectType === 'general') projectType = 'python';
              projectDetails.push('Python');
            }
            if (fs.existsSync('CMakeLists.txt') || fs.existsSync('Makefile') ||
                fs.existsSync('meson.build')) {
              if (projectType === 'general') projectType = 'cpp';
              projectDetails.push('C/C++');
            }
            if (fs.existsSync('Cargo.toml')) {
              if (projectType === 'general') projectType = 'rust';
              projectDetails.push('Rust');
            }
            if (fs.existsSync('go.mod')) {
              if (projectType === 'general') projectType = 'go';
              projectDetails.push('Go');
            }
            console.log('Tespit Edilen Tip: ' + projectType);
            console.log('Detaylar: ' + (projectDetails.join(', ') || 'Genel Proje'));
            core.setOutput('type', projectType);
            core.setOutput('details', projectDetails.join(', ') || 'Genel Proje');

      - name: (Optional) Java Kurulumu
        if: steps.detect.outputs.type == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: (Optional) Node.js Kurulumu
        if: steps.detect.outputs.type == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: (Optional) Python Kurulumu
        if: steps.detect.outputs.type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: (Optional) Rust Kurulumu
        if: steps.detect.outputs.type == 'rust'
        uses: dtolnay/rust-toolchain@stable

      - name: (Optional) Go Kurulumu
        if: steps.detect.outputs.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Sanity: Kökde tanımsız suppressKotlinVersionCompatibilityCheck satırlarını yorumla
        # Bu adım repoda tek başına duran "suppressKotlinVersionCompatibilityCheck" gibi satırları bulup
        # yorum satırına çevirir. Böylece /home/runner/...: command not found hatası engellenir.
        run: |
          set -eu
          FOUND=false
          # dosya uzantılarına göre tarama (şüpheli yerleri kapsar)
          while IFS= read -r -d '' file; do
            if grep -n -E '^[[:space:]]*suppressKotlinVersionCompatibilityCheck[[:space:]]*$' "$file" >/dev/null 2>&1; then
              echo "Duzeltiliyor: $file"
              sed -i.bak -E "s/^[[:space:]]*suppressKotlinVersionCompatibilityCheck[[:space:]]*$/# removed undefined suppressKotlinVersionCompatibilityCheck/" "$file"
              rm -f "$file.bak" || true
              FOUND=true
            fi
          done < <(git ls-files -z -- '*.sh' '*.yml' '*.yaml' '*.gradle' '*.kt' '*.kts' || true)
          if [ "$FOUND" = true ]; then
            git add -A
            if git diff --cached --quiet; then
              echo "No changes to commit after sanitation."
            else
              git -c user.name="DeepSeek Ultimate" -c user.email="41898282+github-actions[bot]@users.noreply.github.com" commit -m "ci: sanitize undefined suppressKotlinVersionCompatibilityCheck occurrences" || true
              # push may fail if token perms are restricted; do best-effort
              git push origin HEAD || echo "Push izin yetersiz veya başarısız; değişiklikler local kaldı."
            fi
          else
            echo "Sanitation gerekli degil."
          fi

      - name: DeepSeek Kodlama Motoru
        id: deepseek
        uses: actions/github-script@v7
        timeout-minutes: 45
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_MSG: ${{ github.event.inputs.task || github.event.comment && github.event.comment.body || github.event.issue && github.event.issue.body || '' }}
          PROJECT_TYPE: ${{ steps.detect.outputs.type }}
          PROJECT_DETAILS: ${{ steps.detect.outputs.details }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const fetch = global.fetch || require('node-fetch');
            const ignoreDirs = new Set(['.git', 'node_modules', 'build', 'dist', '.gradle', 'venv', '__pycache__', 'target', '.idea', '.vscode', 'bin', 'obj', 'out', 'vendor', '.next', '.nuxt']);
            const codeExtensions = new Set([
              '.js', '.ts', '.jsx', '.tsx', '.mjs', '.cjs',
              '.py', '.pyw', '.pyi',
              '.java', '.kt', '.kts', '.scala',
              '.cpp', '.cc', '.cxx', '.c', '.h', '.hpp', '.hxx',
              '.cs', '.fs', '.vb',
              '.go', '.rs', '.rb',
              '.php',
              '.swift', '.m', '.mm',
              '.xml', '.json', '.yaml', '.yml', '.toml',
              '.html', '.css', '.scss', '.sass', '.less',
              '.md', '.txt', '.rst',
              '.gradle', '.properties', '.pro',
              '.sql',
              '.sh', '.bash', '.zsh', '.ps1',
              '.dockerfile',
              '.env.example'
            ]);
            let repoContext = "";
            let fileList = [];
            function scanDirectory(dir, depth) {
              if (depth === undefined) depth = 0;
              if (depth > 10) return;
              if (!fs.existsSync(dir)) return;
              try {
                const entries = fs.readdirSync(dir, { withFileTypes: true });
                for (const entry of entries) {
                  const fullPath = path.join(dir, entry.name);
                  const relativePath = path.relative('.', fullPath);
                  if (entry.isDirectory()) {
                    if (!ignoreDirs.has(entry.name) && !entry.name.startsWith('.')) {
                      scanDirectory(fullPath, depth + 1);
                    }
                  } else if (entry.isFile()) {
                    const ext = path.extname(entry.name).toLowerCase();
                    if (codeExtensions.has(ext) || entry.name === 'Dockerfile' || entry.name === 'Makefile' || entry.name === 'CMakeLists.txt') {
                      const stats = fs.statSync(fullPath);
                      if (stats.size < 50000) {
                        try {
                          const content = fs.readFileSync(fullPath, 'utf8');
                          repoContext += '\n=== DOSYA: ' + relativePath + ' ===\n' + content + '\n=== DOSYA SONU ===\n';
                          fileList.push(relativePath);
                        } catch (e) {}
                      }
                    }
                  }
                }
              } catch (e) {}
            }
            scanDirectory('.');
            console.log('Taranan dosya sayisi: ' + fileList.length);
            const systemPrompt =
              'Sen DeepSeek ULTIMATE, dunya standartlarinda profesyonel bir yazilim muhendisisin.\n\n' +
              'PROJE BILGISI:\n' +
              '- Tip: ' + process.env.PROJECT_TYPE + '\n' +
              '- Detaylar: ' + process.env.PROJECT_DETAILS + '\n\n' +
              'GOREV:\n' + process.env.USER_MSG + '\n\n' +
              'KRITIK KURALLAR:\n\n' +
              '1. DOSYA OLUSTURMA/GUNCELLEME FORMATI:\n' +
              '   ---FILE:dosya/yolu/isim.uzanti---\n' +
              '   [dosya icerigi]\n' +
              '   ---END---\n\n' +
              '2. DOSYA SILME FORMATI:\n' +
              '   ---DELETE:dosya/yolu/isim.uzanti---\n' +
              '   ---END---\n\n' +
              '3. KLASOR SILME FORMATI:\n' +
              '   ---DELETEDIR:klasor/yolu---\n' +
              '   ---END---\n\n' +
              '4. KODLAMA KURALLARI:\n' +
              '   - Tam calisan, production-ready kod yaz\n' +
              '   - Hata yonetimi ekle\n' +
              '   - Yorum satirlari ekle (Turkce)\n' +
              '   - Best practices uygula\n' +
              '   - DRY ve SOLID prensiplerine uy\n\n' +
              '5. YASAKLAR:\n' +
              '   - Markdown code block kullanma (backtick yok)\n' +
              '   - Eksik kod yazma\n' +
              '   - Placeholder birakma\n\n' +
              'MEVCUT DOSYALAR:\n' + fileList.join(', ');
            try {
              const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": "Bearer " + process.env.API_KEY,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "deepseek-reasoner",
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: repoContext || "Bos proje - sifirdan olustur" }
                  ],
                  stream: false,
                  max_tokens: 16000,
                  temperature: 0.7
                })
              });
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error('API Hatasi: ' + response.status + ' - ' + errorText);
              }
              const data = await response.json();
              const aiResponse = data.choices[0].message.content;
              const thinking = data.choices[0].message.reasoning_content || "";
              console.log("AI yaniti alindi");
              let operations = [];
              const deleteDirRegex = /---DELETEDIR:\s*(.+?)\s*---\s*---END---/gs;
              let match;
              while ((match = deleteDirRegex.exec(aiResponse)) !== null) {
                const dirPath = match[1].trim();
                if (fs.existsSync(dirPath) && fs.statSync(dirPath).isDirectory()) {
                  fs.rmSync(dirPath, { recursive: true, force: true });
                  operations.push('Klasor silindi: ' + dirPath);
                  console.log('Klasor silindi: ' + dirPath);
                }
              }
              const deleteRegex = /---DELETE:\s*(.+?)\s*---\s*---END---/gs;
              while ((match = deleteRegex.exec(aiResponse)) !== null) {
                const filePath = match[1].trim();
                if (fs.existsSync(filePath)) {
                  fs.unlinkSync(filePath);
                  operations.push('Dosya silindi: ' + filePath);
                  console.log('Dosya silindi: ' + filePath);
                }
              }
              const fileRegex = /---FILE:\s*(.+?)\s*---\n([\s\S]*?)---END---/g;
              while ((match = fileRegex.exec(aiResponse)) !== null) {
                const filePath = match[1].trim();
                let content = match[2];
                content = content.replace(/^[\s\n]+|[\s\n]+$/g, '');
                const dir = path.dirname(filePath);
                if (dir && dir !== '.' && !fs.existsSync(dir)) {
                  fs.mkdirSync(dir, { recursive: true });
                }
                fs.writeFileSync(filePath, content, 'utf8');
                operations.push('Yazildi: ' + filePath);
                console.log('Yazildi: ' + filePath);
              }
              core.setOutput('operations', operations.join('\n'));
              core.setOutput('count', operations.length.toString());
              core.setOutput('response', Buffer.from(aiResponse).toString('base64'));
              core.setOutput('thinking', Buffer.from(thinking).toString('base64'));
              core.setOutput('success', 'true');
            } catch (error) {
              console.error('Hata: ' + error.message);
              core.setOutput('success', 'false');
              core.setOutput('error', error.message);
              core.setFailed(error.message);
            }

      - name: Derleme
        id: build
        if: steps.deepseek.outputs.success == 'true'
        continue-on-error: true
        run: |
          TYPE="${{ steps.detect.outputs.type }}"
          echo "Derleme baslatiliyor... (Tip: $TYPE)"
          case "$TYPE" in
            android)
              if [ -f "gradlew" ]; then
                chmod +x gradlew
                # Kotlin sürüm uyumsuzluk uyarılarını bastırmak için property eklendi
                ./gradlew assembleDebug -Pkotlin.suppressVersionCompatibilityCheck=true --no-daemon && echo "BUILD_STATUS=Basarili" >> $GITHUB_ENV || echo "BUILD_STATUS=Derleme hatasi" >> $GITHUB_ENV
              else
                echo "BUILD_STATUS=Gradle wrapper bulunamadi" >> $GITHUB_ENV
              fi
              ;;
            node)
              if [ -f "package.json" ]; then
                npm ci --silent || npm install --silent
                npm run build --if-present && echo "BUILD_STATUS=Basarili" >> $GITHUB_ENV || echo "BUILD_STATUS=Build hatasi" >> $GITHUB_ENV
              fi
              ;;
            python)
              if [ -f "requirements.txt" ]; then
                pip install -r requirements.txt --quiet
              fi
              echo "BUILD_STATUS=Bagimliliklar yuklendi" >> $GITHUB_ENV
              ;;
            rust)
              cargo build --release && echo "BUILD_STATUS=Basarili" >> $GITHUB_ENV || echo "BUILD_STATUS=Cargo hatasi" >> $GITHUB_ENV
              ;;
            go)
              go build ./... && echo "BUILD_STATUS=Basarili" >> $GITHUB_ENV || echo "BUILD_STATUS=Go hatasi" >> $GITHUB_ENV
              ;;
            *)
              echo "BUILD_STATUS=Derleme gerekmedi" >> $GITHUB_ENV
              ;;
          esac

      - name: Degisiklikleri Kaydet
        if: steps.deepseek.outputs.success == 'true'
        run: |
          echo "Degisiklikler kontrol ediliyor..."
          git add -A
          if git diff --cached --quiet; then
            echo "Degisiklik yok"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo "Degisiklikler tespit edildi"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
            TASK="${{ github.event.inputs.task || github.event.comment && github.event.comment.body || github.event.issue && github.event.issue.body || 'Otomatik guncelleme' }}"
            TASK_SHORT=$(echo "$TASK" | head -c 100)
            git -c user.name="DeepSeek Ultimate" -c user.email="41898282+github-actions[bot]@users.noreply.github.com" commit -m "DeepSeek Ultimate: $TASK_SHORT" -m "Islem sayisi: ${{ steps.deepseek.outputs.count }}" -m "Proje tipi: ${{ steps.detect.outputs.type }}" || true
          fi

      - name: Degisiklikleri Gonder
        if: env.HAS_CHANGES == 'true'
        run: |
          echo "Degisiklikler gonderiliyor..."
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "${GITHUB_REF##*/}")
          git pull origin "$CURRENT_BRANCH" --no-edit --strategy-option=ours || true
          git push origin "$CURRENT_BRANCH" || echo "Push izin yetersiz veya basarisiz."

      - name: Sonuc Raporu
        uses: actions/github-script@v7
        if: always()
        env:
          OPERATIONS: ${{ steps.deepseek.outputs.operations }}
          COUNT: ${{ steps.deepseek.outputs.count }}
          SUCCESS: ${{ steps.deepseek.outputs.success }}
          ERROR: ${{ steps.deepseek.outputs.error }}
          BUILD_STATUS: ${{ env.BUILD_STATUS }}
          PROJECT_TYPE: ${{ steps.detect.outputs.type }}
          PROJECT_DETAILS: ${{ steps.detect.outputs.details }}
          THINKING_B64: ${{ steps.deepseek.outputs.thinking }}
        with:
          script: |
            const success = process.env.SUCCESS === 'true';
            const operations = process.env.OPERATIONS || 'Islem yapilmadi';
            const count = process.env.COUNT || '0';
            const buildStatus = process.env.BUILD_STATUS || 'Derleme yapilmadi';
            const projectType = process.env.PROJECT_TYPE || 'general';
            const projectDetails = process.env.PROJECT_DETAILS || 'Genel';
            let thinking = '';
            try {
              thinking = Buffer.from(process.env.THINKING_B64 || '', 'base64').toString('utf-8');
            } catch (e) {}
            const statusEmoji = success ? 'BASARILI' : 'HATA';
            let report = '## DeepSeek Ultimate Raporu\n\n';
            report += '| Ozellik | Deger |\n';
            report += '|---------|-------|\n';
            report += '| **Durum** | ' + statusEmoji + ' |\n';
            report += '| **Proje Tipi** | ' + projectDetails + ' |\n';
            report += '| **Islem Sayisi** | ' + count + ' |\n';
            report += '| **Derleme** | ' + buildStatus + ' |\n\n';
            if (operations && operations !== 'Islem yapilmadi') {
              report += '### Yapilan Islemler\n```' + '\n' + operations + '\n' + '```' + '\n\n';
            }
            if (!success && process.env.ERROR) {
              report += '### Hata Detayi\n```' + '\n' + process.env.ERROR + '\n' + '```' + '\n\n';
            }
            if (thinking && thinking.length > 0) {
              const thinkingPreview = thinking.substring(0, 2000);
              report += '<details>\n<summary>AI Dusunce Sureci (Kisa)</summary>\n\n' + thinkingPreview + (thinking.length > 2000 ? '\n\n...[devami kisaltildi]' : '') + '\n\n</details>\n';
            }
            report += '\n---\n*DeepSeek Ultimate v30.0 tarafindan olusturuldu*';
            try {
              if (context.issue && context.issue.number) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: report
                });
              } else {
                // fallback: create a workflow run annotation
                core.info(report);
              }
            } catch (e) {
              console.log("Yorum eklenemedi (issue context yok olabilir): " + e.message);
            }
