name: DeepSeek Ultimate - Smart Interactive

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'YapÄ±lacak gÃ¶rev'
        required: true
        type: string
      context_files:
        description: 'Ä°lgili dosyalar (virgÃ¼lle, boÅŸsa otomatik seÃ§er)'
        required: false
        type: string
  push:
    branches:
      - main
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  deepseek:
    runs-on: ubuntu-latest
    env:
      GIT_COMMITTER_NAME: "github-actions[bot]"
      GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Git YapÄ±landÄ±rmasÄ±
        run: |
          git config --global user.name "${GIT_COMMITTER_NAME}"
          git config --global user.email "${GIT_COMMITTER_EMAIL}"
          git config --global pull.rebase false
          git config --global push.autoSetupRemote true

      - name: Senkronizasyon
        run: |
          set -euo pipefail
          echo "Uzak deÄŸiÅŸiklikler kontrol ediliyor..."
          git fetch origin || true
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
          if [ -z "$CURRENT_BRANCH" ] || [ "$CURRENT_BRANCH" = "HEAD" ]; then
            CURRENT_BRANCH="${GITHUB_REF##*/}"
          fi
          echo "Mevcut dal: $CURRENT_BRANCH"
          if git ls-remote --exit-code origin "$CURRENT_BRANCH" >/dev/null 2>&1; then
            if git diff --quiet HEAD origin/"$CURRENT_BRANCH" 2>/dev/null; then
              echo "Yerel ve uzak senkronize."
            else
              echo "Uzak deÄŸiÅŸiklikler birleÅŸtiriliyor..."
              git pull origin "$CURRENT_BRANCH" --no-edit || true
            fi
          else
            echo "Uzakta $CURRENT_BRANCH dalÄ± bulunamadÄ±; devam ediliyor."
          fi

      - name: Proje Tipi AlgÄ±lama
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let projectType = 'general';
            let projectDetails = [];
            if (fs.existsSync('build.gradle') || fs.existsSync('app/build.gradle') ||
                fs.existsSync('build.gradle.kts') || fs.existsSync('settings.gradle') ||
                fs.existsSync('settings.gradle.kts')) {
              projectType = 'android';
              projectDetails.push('Android/Kotlin');
            }
            if (fs.existsSync('package.json')) {
              if (projectType === 'general') projectType = 'node';
              projectDetails.push('Node.js/JavaScript');
            }
            if (fs.existsSync('requirements.txt') || fs.existsSync('pyproject.toml') ||
                fs.existsSync('setup.py') || fs.existsSync('Pipfile')) {
              if (projectType === 'general') projectType = 'python';
              projectDetails.push('Python');
            }
            if (fs.existsSync('CMakeLists.txt') || fs.existsSync('Makefile') ||
                fs.existsSync('meson.build')) {
              if (projectType === 'general') projectType = 'cpp';
              projectDetails.push('C/C++');
            }
            if (fs.existsSync('Cargo.toml')) {
              if (projectType === 'general') projectType = 'rust';
              projectDetails.push('Rust');
            }
            if (fs.existsSync('go.mod')) {
              if (projectType === 'general') projectType = 'go';
              projectDetails.push('Go');
            }
            console.log('Tespit Edilen Tip: ' + projectType);
            console.log('Detaylar: ' + (projectDetails.join(', ') || 'Genel Proje'));
            core.setOutput('type', projectType);
            core.setOutput('details', projectDetails.join(', ') || 'Genel Proje')

      - name: Model Selection
        id: model_selector
        run: |
          TASK="${{ github.event.inputs.task }}"
          
          if echo "$TASK" | grep -qiE "(IMO|CMO|ICPC|IOI|olympiad|gold-medal|ultimate reasoning|speciale)"; then
            echo "model=deepseek-reasoner" >> $GITHUB_OUTPUT
            echo "base_url=https://api.deepseek.com/v3.2_speciale_expires_on_20251215" >> $GITHUB_OUTPUT
            echo "complexity=speciale" >> $GITHUB_OUTPUT
          elif echo "$TASK" | grep -qiE "(migrasi|refactor|optimize|kompleks|yapÄ±|arch|design|pattern|benchmark|performance|security|debug|investigate|critical|enhance|improve|transform|restructure)"; then
            echo "model=deepseek-reasoner" >> $GITHUB_OUTPUT
            echo "base_url=https://api.deepseek.com" >> $GITHUB_OUTPUT
            echo "complexity=high" >> $GITHUB_OUTPUT
          else
            echo "model=deepseek-chat" >> $GITHUB_OUTPUT
            echo "base_url=https://api.deepseek.com" >> $GITHUB_OUTPUT
            echo "complexity=low" >> $GITHUB_OUTPUT
          fi

      - name: Smart Context Collector
        id: context
        run: |
          echo "ğŸ”„ AkÄ±llÄ± context toplanÄ±yor..."
          
          # KullanÄ±cÄ± dosya belirtmiÅŸse onlarÄ± kullan
          USER_FILES="${{ github.event.inputs.context_files }}"
          if [ -n "$USER_FILES" ]; then
            echo "âœ… KullanÄ±cÄ± dosyalarÄ± kullanÄ±lÄ±yor: $USER_FILES"
            echo "files=$USER_FILES" >> $GITHUB_OUTPUT
            echo "smart_mode=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # AKILLI DOSYA SEÃ‡Ä°MÄ° (GitHub Copilot stili)
          echo "ğŸ¤– AkÄ±llÄ± dosya seÃ§imi yapÄ±lÄ±yor..."
          SELECTED_FILES=""
          
          # 1. Proje yapÄ± dosyalarÄ± (Kritik)
          for file in "build.gradle" "build.gradle.kts" "settings.gradle" "package.json" "requirements.txt" "pyproject.toml" "Cargo.toml" "go.mod" "pom.xml"; do
            if [ -f "$file" ]; then
              SELECTED_FILES="$SELECTED_FILES,$file"
              echo "â• $file (yapÄ± dosyasÄ±)"
            fi
          done
          
          # 2. Manifest/Config dosyalarÄ±
          if [ -f "app/build.gradle" ]; then
            SELECTED_FILES="$SELECTED_FILES,app/build.gradle"
            echo "â• app/build.gradle (manifest)"
          fi
          if [ -f "app/src/main/AndroidManifest.xml" ]; then
            SELECTED_FILES="$SELECTED_FILES,app/src/main/AndroidManifest.xml"
            echo "â• AndroidManifest.xml"
          fi
          
          # 3. README ve config
          if [ -f "README.md" ]; then
            SELECTED_FILES="$SELECTED_FILES,README.md"
            echo "â• README.md"
          fi
          if [ -f ".gitignore" ]; then
            SELECTED_FILES="$SELECTED_FILES,.gitignore"
            echo "â• .gitignore"
          fi
          
          # 4. Ana kod dosyalarÄ± (max 3 tane)
          MAIN_FILES_COUNT=0
          for file in "app/src/main/java/com/"*".kt" "app/src/main/kotlin/"*".kt" "src/App.js" "src/App.tsx" "src/main.py" "main.rs" "main.go"; do
            if [ -f "$file" ] && [ $MAIN_FILES_COUNT -lt 3 ]; then
              SELECTED_FILES="$SELECTED_FILES,$file"
              MAIN_FILES_COUNT=$((MAIN_FILES_COUNT + 1))
              echo "â• $file (ana kod)"
            fi
          done
          
          # 5. BoÅŸsa default
          if [ -z "$SELECTED_FILES" ]; then
            SELECTED_FILES="README.md"
            echo "âš ï¸  Dosya bulunamadÄ±, default kullanÄ±lÄ±yor"
          fi
          
          # Temizle ve max 8 dosya
          SELECTED_FILES=$(echo "$SELECTED_FILES" | sed 's/^,//' | cut -d',' -f1-8)
          echo "âœ… SeÃ§ilen dosyalar: $SELECTED_FILES"
          echo "files=$SELECTED_FILES" >> $GITHUB_OUTPUT
          echo "smart_mode=true" >> $GITHUB_OUTPUT

      - name: Java Kurulumu
        if: steps.detect.outputs.type == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Node.js Kurulumu
        if: steps.detect.outputs.type == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Python Kurulumu
        if: steps.detect.outputs.type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Rust Kurulumu
        if: steps.detect.outputs.type == 'rust'
        uses: dtolnay/rust-toolchain@stable

      - name: Go Kurulumu
        if: steps.detect.outputs.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Python for DeepSeek
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests

      - name: Validate DEEPSEEK_API_KEY
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          BASE_URL: ${{ steps.model_selector.outputs.base_url }}
          MODEL: ${{ steps.model_selector.outputs.model }}
        run: |
          python3 - <<'PY'
          import os, sys, requests
          def sanitize_key(k):
              if k is None:
                  return None
              k = k.strip()
              if (k.startswith("'") and k.endswith("'")) or (k.startswith('"') and k.endswith('"')):
                  k = k[1:-1].strip()
              if (k.startswith("b'") and k.endswith("'")) or (k.startswith('b"') and k.endswith('"')):
                  k = k[2:-1]
              return k.strip()

          raw = os.environ.get('DEEPSEEK_API_KEY')
          key = sanitize_key(raw)
          if not key:
              print("HATA: DEEPSEEK_API_KEY yok veya boÅŸ")
              sys.exit(1)
          base = (os.environ.get('BASE_URL') or "https://api.deepseek.com").rstrip('/')
          model = os.environ.get('MODEL') or 'deepseek-chat'
          
          try:
              url = base + "/v1/models"
              print(f"API baÄŸlantÄ±sÄ± kontrol ediliyor: {url}")
              r = requests.get(url, headers={'Authorization': f'Bearer {key}'}, timeout=15)
              print("Auth check HTTP status:", r.status_code)
              if r.status_code == 401:
                  print("HATA: DEEPSEEK_API_KEY geÃ§ersiz veya izin yok (401)")
                  sys.exit(2)
              r.raise_for_status()
              models_data = r.json()
              available_models = [m['id'] for m in models_data.get('data', [])]
              print(f"Mevcut modeller: {', '.join(available_models)}")
              
              if model not in available_models:
                  print(f"UYARI: SeÃ§ilen model '{model}' API'nin listesinde gÃ¶rÃ¼nmÃ¼yor.")
                  print("AnahtarÄ±nÄ±zÄ±n bu modeli kullanma izni olmayabilir veya model adÄ± deÄŸiÅŸmiÅŸ olabilir.")
          except requests.exceptions.RequestException as e:
              print(f"API baÄŸlantÄ± hatasÄ±: {e}")
              sys.exit(3)
          except Exception as e:
              print(f"Model listesi kontrolÃ¼ sÄ±rasÄ±nda beklenmedik hata: {e}")
          
          print("DEEPSEEK API anahtar doÄŸrulamasÄ± ve model kontrolÃ¼ tamamlandÄ±.")
          PY

      - name: DeepSeek Smart Interactive Engine
        id: deepseek
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_TASK: ${{ github.event.inputs.task || (github.event.comment && github.event.comment.body) || (github.event.issue && github.event.issue.body) || 'Proje optimize et' }}
          MODEL: ${{ steps.model_selector.outputs.model }}
          BASE_URL: ${{ steps.model_selector.outputs.base_url }}
          PROJECT_TYPE: ${{ steps.detect.outputs.type }}
          PROJECT_DETAILS: ${{ steps.detect.outputs.details }}
          CONTEXT_FILES: ${{ steps.context.outputs.files }}
        run: |
          python3 << 'PYTHON_EOF'
          import os
          import sys
          import time
          import json
          import re
          from pathlib import Path
          import requests

          GITHUB_OUTPUT = os.environ.get('GITHUB_OUTPUT', '/dev/null')
          def write_output(name: str, value: str):
              try:
                  with open(GITHUB_OUTPUT, 'a') as f:
                      if '\n' in value:
                          f.write(f"{name}<<EOF\n")
                          f.write(value)
                          if not value.endswith('\n'):
                              f.write('\n')
                          f.write("EOF\n")
                      else:
                          sanitized = value.replace('\r', '').replace('`', "'")
                          f.write(f"{name}={sanitized}\n")
              except Exception:
                  pass

          api_key = os.environ.get('DEEPSEEK_API_KEY')
          api_base = (os.environ.get('BASE_URL') or "https://api.deepseek.com").rstrip('/')
          MODEL = os.environ.get('MODEL') or 'deepseek-chat'
          USER_TASK = os.environ.get('USER_TASK') or 'Proje optimize et'
          PROJECT_TYPE = os.environ.get('PROJECT_TYPE', '')
          PROJECT_DETAILS = os.environ.get('PROJECT_DETAILS', '')
          CONTEXT_FILES = os.environ.get('CONTEXT_FILES', '')

          def sanitize_key(k: str) -> str:
              if k is None:
                  return None
              k = k.strip()
              if (k.startswith("'") and k.endswith("'")) or (k.startswith('"') and k.endswith('"')):
                  k = k[1:-1].strip()
              if (k.startswith("b'") and k.endswith("'")) or (k.startswith('b"') and k.endswith('"')):
                  k = k[2:-1]
              return k.strip()

          api_key = sanitize_key(api_key)
          if not api_key:
              msg = "DEEPSEEK_API_KEY yok veya boÅŸ. LÃ¼tfen repo secrets iÃ§ine DEEPSEEK_API_KEY ekleyin."
              print(msg)
              write_output("success", "false")
              write_output("error", msg)
              sys.exit(1)

          # AKILLI DOSYA OKUMA (GitHub Copilot stili)
          repoContext = ""
          fileList = []
          
          if CONTEXT_FILES:
              files = [f.strip() for f in CONTEXT_FILES.split(',') if f.strip()]
              for file_path in files:
                  try:
                      path = Path(file_path)
                      if path.exists() and path.is_file():
                          content = path.read_text(encoding='utf-8')
                          # Dosya boyutunu sÄ±nÄ±rla
                          if len(content) > 10000:
                              content = content[:10000] + "\n... [kesildi, devamÄ± var]"
                          repoContext += f"\n=== {file_path} ===\n{content}\n"
                          fileList.append(file_path)
                          print(f"âœ“ Okundu: {file_path} ({len(content)} karakter)")
                  except Exception as e:
                      print(f"âš ï¸  OkunamadÄ±: {file_path} - {e}")
          
          print(f"Toplam {len(fileList)} dosya okundu (~{len(repoContext)} karakter)")

          # INTERAKTÄ°F SMART PROMPT
          systemPrompt = f"""Sen DeepSeek V3.2, akÄ±llÄ± ve interaktif bir kod asistanÄ±sÄ±n.

          Ã‡ALIÅMA PRENSÄ°BÄ°N (GitHub Copilot gibi):
          1. Ã–NCE mevcut context'i analiz et (sana sÄ±nÄ±rlÄ± dosya gÃ¶sterildi)
          2. EKSÄ°K BÄ°LGÄ° VARSA SOR:
             - "Hangi teknoloji/versiyon?"
             - "Hangi kÃ¼tÃ¼phaneler?"
             - "TasarÄ±m tercihlerin?"
             - "Ã–zel gereksinimler?"
          3. NET DEÄÄ°LSE SOR, ASLA VARSAYIM YAPMA!
          4. Eksik yoksa TAM ve Ã‡ALIÅAN kod yaz.

          PROJE BÄ°LGÄ°SÄ°:
          - Tip: {PROJECT_TYPE}
          - Detaylar: {PROJECT_DETAILS}
          - Model: {MODEL}

          GÃ–REV:
          {USER_TASK}

          DOSYA YAZMA FORMATI:
          ---FILE: dosya/yolu/isim.uzanti---
          [tam Ã§alÄ±ÅŸan kod]
          ---END---

          DOSYA SILME:
          ---DELETE: dosya/yolu---
          ---END---

          SORU FORMATI (Eksik bilgi varsa):
          ---QUESTION---
          [Net ve spesifik soru]
          ---END---

          KURALLAR:
          âœ… Eksik bilgi varsa SOR
          âœ… Tam Ã§alÄ±ÅŸan kod yaz
          âœ… Hata yÃ¶netimi ekle
          âœ… Best practices uygula
          âŒ Eksik/yarÄ±m kod YAZMA
          âŒ Tahmin yapÄ±p devam etme

          MEVCUT DOSYALAR: {', '.join(fileList) if fileList else 'Yeni proje'}

          ÅÄ°MDÄ°: Analiz et ve gerekiyorsa SOR, yoksa KOD YAZ:"""

          def post_chat(api_base, api_key, model, messages, max_tokens=12000, temperature=0.7, timeout=60):
              if "/v3.2_speciale" in api_base:
                  url = f"{api_base}/chat/completions"
              else:
                  url = f"{api_base}/v1/chat/completions"
              
              headers = {
                  "Authorization": f"Bearer {api_key}",
                  "Content-Type": "application/json"
              }
              payload = {
                  "model": model,
                  "messages": messages,
                  "max_tokens": max_tokens,
                  "temperature": temperature
              }
              print(f"API'ye istek gÃ¶nderiliyor: {url}")
              return requests.post(url, headers=headers, json=payload, timeout=timeout)

          def parse_response(resp_json):
              try:
                  choices = resp_json.get('choices') or []
                  if choices:
                      msg = choices[0].get('message') or {}
                      content = msg.get('content')
                      if content:
                          return content
                      reasoning = msg.get('reasoning_content')
                      if reasoning:
                          return reasoning
                      text = choices[0].get('text')
                      if text:
                          return text
              except Exception:
                  pass
              return json.dumps(resp_json)

          max_retries = 3
          backoff = 2
          aiResponse = None
          last_exc = None

          messages = [
              {"role":"system","content": systemPrompt},
              {"role":"user","content": repoContext or "Yeni proje oluÅŸturulacak. Gerekiyorsa detay sor."}
          ]

          for attempt in range(1, max_retries + 1):
              try:
                  resp = post_chat(api_base, api_key, MODEL, messages,
                                   max_tokens=12000,
                                   temperature=0.5 if MODEL == 'deepseek-reasoner' else 0.7)
                  print("HTTP status:", resp.status_code)
                  if resp.status_code == 401:
                      msg = "Unauthorized (401): DEEPSEEK_API_KEY geÃ§ersiz veya izin yok"
                      print(msg)
                      write_output("success","false")
                      write_output("error", msg)
                      sys.exit(1)
                  if resp.status_code == 404:
                      msg = f"Not Found (404): Endpoint bulunamadÄ±: {resp.url}"
                      print(msg)
                      write_output("success","false")
                      write_output("error", msg)
                      sys.exit(1)
                  if not resp.ok:
                      raise Exception(f"HTTP {resp.status_code}: {resp.text[:1000]}")
                  data = resp.json()
                  aiResponse = parse_response(data)
                  print("âœ… AI yanÄ±tÄ± alÄ±ndÄ±")
                  break
              except Exception as e:
                  last_exc = e
                  serr = str(e).replace('`', "'")
                  print(f"API Ã§aÄŸrÄ±sÄ± hatasÄ± (deneme {attempt}/{max_retries}): {serr}")
                  if attempt < max_retries:
                      sleep_time = backoff ** attempt
                      print(f"{sleep_time}s beklenip tekrar deneniyor...")
                      time.sleep(sleep_time)
                  else:
                      raise

          if aiResponse is None:
              err = f"No response from API. Last error: {last_exc}"
              print(err)
              write_output("success","false")
              write_output("error", str(last_exc))
              sys.exit(1)

          # SORU VAR MI KONTROL ET (Interaktif mod)
          question_match = re.search(r'---QUESTION---\s*(.+?)\s*---END---', aiResponse, re.DOTALL)
          if question_match:
              question = question_match.group(1).strip()
              print(f"â“ AI soru sordu: {question[:100]}...")
              write_output("has_question", "true")
              write_output("question", question)
              write_output("response", aiResponse)
              write_output("success", "true")  # BaÅŸarÄ±lÄ± ama soru var
          else:
              write_output("has_question", "false")
              
              # DOSYA Ä°ÅLEMLERÄ°
              operations = []
              for m in re.finditer(r'---DELETEDIR:\s*(.+?)\s*---', aiResponse):
                  dirPath = m.group(1).strip()
                  if Path(dirPath).exists() and Path(dirPath).is_dir():
                      import shutil
                      shutil.rmtree(dirPath)
                      operations.append(f"KlasÃ¶r silindi: {dirPath}")
              for m in re.finditer(r'---DELETE:\s*(.+?)\s*---', aiResponse):
                  filePath = m.group(1).strip()
                  if Path(filePath).exists():
                      Path(filePath).unlink()
                      operations.append(f"Dosya silindi: {filePath}")
              for m in re.finditer(r'---FILE:\s*(.+?)\s*---\n([\s\S]*?)---END---', aiResponse):
                  filePath = m.group(1).strip()
                  content = m.group(2).rstrip()
                  dirPath = Path(filePath).parent
                  if dirPath != Path('.'):
                      dirPath.mkdir(parents=True, exist_ok=True)
                  Path(filePath).write_text(content, encoding='utf-8')
                  operations.append(f"YazÄ±ldÄ±: {filePath}")

              write_output("operations", '\n'.join(operations) if operations else 'Ä°ÅŸlem yapÄ±lmadÄ±')
              write_output("count", str(len(operations)))
              write_output("success", "true")
          
          PYTHON_EOF

      - name: Interactive Question Handler
        if: steps.deepseek.outputs.has_question == 'true'
        run: |
          echo "## ğŸ¤– DEEPSEEK SORU SORDU"
          echo ""
          echo "**GÃ¶rev:** ${{ github.event.inputs.task }}"
          echo ""
          echo "### â“ SORU:"
          echo "${{ steps.deepseek.outputs.question }}"
          echo ""
          echo "### ğŸ“‹ MEVCUT DOSYALAR:"
          echo "${{ steps.context.outputs.files }}"
          echo ""
          echo "### ğŸš€ SONRAKÄ° ADIMLAR:"
          echo "1. **YanÄ±tÄ±nÄ± hazÄ±rla:** AI'nÄ±n sorusunu cevapla"
          echo "2. **Dosya ekle:** Eksik dosyalarÄ± 'context_files' alanÄ±na ekle"
          echo "3. **Yeniden Ã§alÄ±ÅŸtÄ±r:** Workflow'u tekrar baÅŸlat"
          echo ""
          echo "### ğŸ’¡ Ã–RNEK:"
          echo "```yaml"
          echo "task: \"${{ github.event.inputs.task }}\""
          echo "context_files: \"${{ steps.context.outputs.files }},app/src/main/AndroidManifest.xml,build.gradle\""
          echo "```"
          echo ""
          echo "---"
          echo "*Interaktif mod: AI Ã¶ÄŸreniyor, daha iyi kod yazÄ±yor!*"
          
          # Soruyu issue olarak aÃ§ (opsiyonel)
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ github.event.inputs.task }}" ]; then
            echo "## AI Sordu: ${{ github.event.inputs.task }}" > ai_question.md
            echo "" >> ai_question.md
            echo "**Soru:** ${{ steps.deepseek.outputs.question }}" >> ai_question.md
            echo "" >> ai_question.md
            echo "**Mevcut Dosyalar:** ${{ steps.context.outputs.files }}" >> ai_question.md
            echo "" >> ai_question.md
            echo "**YanÄ±t vermek iÃ§in:**" >> ai_question.md
            echo "1. Eksik dosyalarÄ± ekle: \`${{ steps.context.outputs.files }},yeni_dosya.kt\`" >> ai_question.md
            echo "2. Workflow'u yeniden Ã§alÄ±ÅŸtÄ±r" >> ai_question.md
          fi

      - name: Derleme
        id: build
        if: steps.deepseek.outputs.success == 'true' && steps.deepseek.outputs.has_question != 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          TYPE="${{ steps.detect.outputs.type }}"
          echo "Derleme baÅŸlatÄ±lÄ±yor... (Tip: $TYPE)"
          case "$TYPE" in
            android)
              if [ -f "gradlew" ]; then
                chmod +x gradlew
                ./gradlew assembleDebug -Pandroid.suppressKotlinVersionCompatibilityCheck=true --no-daemon && echo "BUILD_STATUS=BaÅŸarÄ±lÄ±" >> $GITHUB_ENV || echo "BUILD_STATUS=Derleme hatasÄ±" >> $GITHUB_ENV
              else
                echo "BUILD_STATUS=Gradle wrapper bulunamadÄ±" >> $GITHUB_ENV
              fi
              ;;
            node)
              if [ -f "package.json" ]; then
                npm ci --silent || npm install --silent
                npm run build --if-present && echo "BUILD_STATUS=BaÅŸarÄ±lÄ±" >> $GITHUB_ENV || echo "BUILD_STATUS=Build hatasÄ±" >> $GITHUB_ENV
              else
                echo "BUILD_STATUS=package.json bulunamadÄ±" >> $GITHUB_ENV
              fi
              ;;
            python)
              if [ -f "requirements.txt" ]; then
                pip install -r requirements.txt --quiet
              fi
              echo "BUILD_STATUS=BaÄŸÄ±mlÄ±lÄ±klar yÃ¼klendi" >> $GITHUB_ENV
              ;;
            rust)
              cargo build --release && echo "BUILD_STATUS=BaÅŸarÄ±lÄ±" >> $GITHUB_ENV || echo "BUILD_STATUS=Cargo hatasÄ±" >> $GITHUB_ENV
              ;;
            go)
              go build ./... && echo "BUILD_STATUS=BaÅŸarÄ±lÄ±" >> $GITHUB_ENV || echo "BUILD_STATUS=Go hatasÄ±" >> $GITHUB_ENV
              ;;
            *)
              echo "BUILD_STATUS=Derleme gerekmedi" >> $GITHUB_ENV
              ;;
          esac

      - name: DeÄŸiÅŸiklikleri Kaydet
        if: steps.deepseek.outputs.success == 'true' && steps.deepseek.outputs.has_question != 'true'
        run: |
          set -euo pipefail
          echo "DeÄŸiÅŸiklikler kontrol ediliyor..."
          git add -A
          if git diff --cached --quiet; then
            echo "DeÄŸiÅŸiklik yok"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo "DeÄŸiÅŸiklikler tespit edildi"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
            TASK="${{ github.event.inputs.task || (github.event.comment && github.event.comment.body) || (github.event.issue && github.event.issue.body) || 'Otomatik gÃ¼ncelleme' }}"
            TASK_SHORT=$(echo "$TASK" | head -c 100)
            git -c user.name="${GIT_COMMITTER_NAME}" -c user.email="${GIT_COMMITTER_EMAIL}" commit -m "DeepSeek Ultimate: $TASK_SHORT" -m "Model: ${{ steps.model_selector.outputs.model }}" -m "Kompleksite: ${{ steps.model_selector.outputs.complexity }}" || true
          fi

      - name: DeÄŸiÅŸiklikleri GÃ¶nder
        if: env.HAS_CHANGES == 'true'
        run: |
          set -euo pipefail
          echo "DeÄŸiÅŸiklikler gÃ¶nderiliyor..."
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")
          git pull origin "$CURRENT_BRANCH" --no-edit || true
          git push origin "$CURRENT_BRANCH"
          echo "Push baÅŸarÄ±lÄ±!"

      - name: SonuÃ§ Raporu
        uses: actions/github-script@v7
        if: always()
        env:
          OPERATIONS: ${{ steps.deepseek.outputs.operations }}
          COUNT: ${{ steps.deepseek.outputs.count }}
          SUCCESS: ${{ steps.deepseek.outputs.success }}
          ERROR: ${{ steps.deepseek.outputs.error }}
          HAS_QUESTION: ${{ steps.deepseek.outputs.has_question }}
          QUESTION: ${{ steps.deepseek.outputs.question }}
          BUILD_STATUS: ${{ env.BUILD_STATUS }}
          PROJECT_TYPE: ${{ steps.detect.outputs.type }}
          PROJECT_DETAILS: ${{ steps.detect.outputs.details }}
          MODEL: ${{ steps.model_selector.outputs.model }}
          COMPLEXITY: ${{ steps.model_selector.outputs.complexity }}
          CONTEXT_FILES: ${{ steps.context.outputs.files }}
          SMART_MODE: ${{ steps.context.outputs.smart_mode }}
        with:
          script: |
            const success = process.env.SUCCESS === 'true';
            const hasQuestion = process.env.HAS_QUESTION === 'true';
            const operations = process.env.OPERATIONS || 'Ä°ÅŸlem yapÄ±lmadÄ±';
            const count = process.env.COUNT || '0';
            const buildStatus = process.env.BUILD_STATUS || 'Derleme yapÄ±lmadÄ±';
            const projectType = process.env.PROJECT_TYPE || 'general';
            const projectDetails = process.env.PROJECT_DETAILS || 'Genel';
            const model = process.env.MODEL || 'deepseek-chat';
            const complexity = process.env.COMPLEXITY || 'low';
            const contextFiles = process.env.CONTEXT_FILES || 'Otomatik seÃ§ildi';
            const smartMode = process.env.SMART_MODE === 'true';
            const question = process.env.QUESTION || '';
            
            let statusEmoji = 'ğŸ”„';
            if (hasQuestion) statusEmoji = 'â“ BEKLEYEN SORU';
            else if (success) statusEmoji = 'âœ… BAÅARILI';
            else statusEmoji = 'âŒ HATA';
            
            let report = '## ğŸš€ DeepSeek Ultimate - Smart Interactive\n\n';
            
            report += '| Ã–zellik | DeÄŸer |\n';
            report += '|---------|-------|\n';
            report += '| **Durum** | ' + statusEmoji + ' |\n';
            report += '| **Model** | ' + model + ' |\n';
            report += '| **Kompleksite** | ' + complexity + ' |\n';
            report += '| **Proje Tipi** | ' + projectDetails + ' |\n';
            report += '| **Context DosyalarÄ±** | ' + contextFiles + ' |\n';
            report += '| **AkÄ±llÄ± Mod** | ' + (smartMode ? 'âœ… AÃ‡IK' : 'ğŸ”§ MANUEL') + ' |\n';
            report += '| **Ä°ÅŸlem SayÄ±sÄ±** | ' + count + ' |\n';
            report += '| **Derleme** | ' + buildStatus + ' |\n\n';
            
            if (hasQuestion) {
              report += '### â“ INTERAKTÄ°F SORU\n';
              report += question + '\n\n';
              report += '**ğŸ“‹ Sonraki AdÄ±mlar:**\n';
              report += '1. Bu soruyu yanÄ±tla\n';
              report += '2. Eksik dosyalarÄ± `context_files` alanÄ±na ekle\n';
              report += '3. Workflow\'u yeniden Ã§alÄ±ÅŸtÄ±r\n\n';
              report += '**ğŸ’¡ Ã–rnek:**\n```yaml\ncontext_files: "' + contextFiles + ',ek_dosya.kt"\n```\n\n';
            } else if (operations && operations !== 'Ä°ÅŸlem yapÄ±lmadÄ±') {
              report += '### âœ… YAPILAN Ä°ÅLEMLER\n' + operations + '\n\n';
            }
            
            if (!success && process.env.ERROR && !hasQuestion) {
              report += '### âŒ HATA DETAYI\n' + process.env.ERROR + '\n\n';
            }
            
            report += '---\n';
            report += '**ğŸ¯ Token Optimizasyonu:** ' + (smartMode ? 'AkÄ±llÄ± dosya seÃ§imi (~3-5K token)' : 'Manuel seÃ§im') + '\n';
            report += '*GitHub Copilot stili interaktif kodlama*';
            
            try {
              if (context.issue && context.issue.number) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: report
                });
              } else {
                core.info(report);
              }
            } catch (e) {
              console.log("Yorum eklenemedi: " + e.message);
            }
