name: DEEPSEEK OMNI v23.0 (DIRECT PUSH & AUTO-DETECT)
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      task:
        description: 'GÃ¶rev'
        required: true
        default: 'Projeyi geliÅŸtir'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  omni_direct:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: github.actor != 'github-actions[bot]'
    
    steps:
      # 1. SAHA HAZIRLIÄI
      - name: ğŸš€ Projeyi Ã‡ek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ORTAM ANALÄ°ZÄ° (DÄ°NAMÄ°K)
      # BurasÄ± projenin ne olduÄŸuna bakar ve ona gÃ¶re ortamÄ± belirler.
      - name: ğŸ§  Ortam AlgÄ±layÄ±cÄ±
        id: setup
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let type = 'general';
            
            // DosyalarÄ± kontrol et ve tipi belirle
            if (fs.existsSync('build.gradle') || fs.existsSync('app/build.gradle') || fs.existsSync('build.gradle.kts')) {
                type = 'android';
                console.log("âœ… Tespit Edildi: Android Projesi");
            } else if (fs.existsSync('package.json')) {
                type = 'node';
                console.log("âœ… Tespit Edildi: Node.js/Web Projesi");
            } else if (fs.existsSync('requirements.txt') || fs.existsSync('pyproject.toml')) {
                type = 'python';
                console.log("âœ… Tespit Edildi: Python Projesi");
            } else {
                console.log("â„¹ï¸ Tespit Edildi: Genel Proje (C++, PLC, vb.)");
            }
            
            core.setOutput('env_type', type);

      # 3. ORTAM KURULUMLARI (Sadece Gerekiyorsa Ã‡alÄ±ÅŸÄ±r)
      - name: â˜• Java Kur (Sadece Android ise)
        if: steps.setup.outputs.env_type == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸŸ¢ Node.js Kur (Sadece Web ise)
        if: steps.setup.outputs.env_type == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ Python Kur (Sadece Python ise)
        if: steps.setup.outputs.env_type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4. DEEPSEEK BEYNÄ° (KODLAMA & YÃ–NETÄ°M)
      - name: âš¡ DeepSeek Kodlama Motoru
        id: coder
        uses: actions/github-script@v7
        timeout-minutes: 30
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_MSG: ${{ github.event.inputs.task || github.event.comment.body || github.event.issue.body }}
          ENV_TYPE: ${{ steps.setup.outputs.env_type }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Mevcut dosyalarÄ± oku (Recursive Scan)
            let repoContext = "";
            function scan(dir) {
                if (!fs.existsSync(dir)) return;
                const files = fs.readdirSync(dir);
                for (const f of files) {
                    // Gereksiz klasÃ¶rleri atla
                    if (['.git', 'node_modules', 'build', '.gradle', 'venv', '__pycache__'].includes(f)) continue;
                    
                    const fp = path.join(dir, f);
                    if (fs.statSync(fp).isDirectory()) scan(fp);
                    else {
                        // Kod dosyalarÄ±nÄ± tanÄ± (PLC, C++, Java, JS, Python vs.)
                        if (fp.match(/\.(js|py|java|kt|xml|gradle|json|md|html|css|txt|cpp|h|c|ino|st)$/i)) {
                            // Ã‡ok bÃ¼yÃ¼k dosyalarÄ± okuma
                            if (fs.statSync(fp).size < 20000) {
                                repoContext += `FILE: ${fp}\n${fs.readFileSync(fp, 'utf8')}\n---\n`;
                            }
                        }
                    }
                }
            }
            scan('.');

            const prompt = `
            Sen DeepSeek OMNI. Åu anki Proje Tipi: ${process.env.ENV_TYPE}
            
            GÃ–REV:
            KullanÄ±cÄ± isteÄŸini (${process.env.USER_MSG}) profesyonelce yerine getir.
            
            KURALLAR:
            1. Tam Ã§alÄ±ÅŸan, profesyonel kod yaz.
            2. FORMAT (ZORUNLU): 
               ---FILE:dosya/yolu--- 
               [iÃ§erik] 
               ---END---
            3. SÄ°LMEK Ä°Ã‡Ä°N:
               ---DELETE:dosya/yolu---
               ---END---
            4. DÃ¼ÅŸÃ¼nce zincirini (Reasoning) kullan.
            5. Asla markdown (backtick) iÃ§ine alma, ham metin ver.
            `;

            try {
                const response = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${process.env.API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "deepseek-reasoner",
                        messages: [{ role: "system", content: prompt }, { role: "user", content: repoContext }],
                        stream: false,
                        max_tokens: 8000
                    })
                });
                
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                
                const aiReply = data.choices[0].message.content;
                const thinking = data.choices[0].message.reasoning_content || "";
                
                // DosyalarÄ± Yaz
                const regex = /---FILE:\s*(.*?)---\n([\s\S]*?)---END---/g;
                const delRegex = /---DELETE:\s*(.*?)---\n---END---/g;
                
                let match;
                let files = [];
                
                // OluÅŸturma / GÃ¼ncelleme
                while ((match = regex.exec(aiReply)) !== null) {
                    const fpath = match[1].trim();
                    const content = match[2].trim();
                    const dir = path.dirname(fpath);
                    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                    fs.writeFileSync(fpath, content);
                    files.push(`YazÄ±ldÄ±: ${fpath}`);
                    console.log("YazÄ±ldÄ±:", fpath);
                }
                
                // Silme
                while ((match = delRegex.exec(aiReply)) !== null) {
                    const fpath = match[1].trim();
                    if (fs.existsSync(fpath)) {
                        fs.unlinkSync(fpath);
                        files.push(`Silindi: ${fpath}`);
                        console.log("Silindi:", fpath);
                    }
                }
                
                // Base64 ile gÃ¼venli aktarÄ±m
                core.setOutput('files', files.join(', '));
                core.setOutput('reply', Buffer.from(aiReply).toString('base64'));
                core.setOutput('thinking', Buffer.from(thinking).toString('base64'));

            } catch (e) {
                core.setFailed(e.message);
            }

      # 5. DERLEME (Sadece Ä°lgili Ortam Varsa Ã‡alÄ±ÅŸÄ±r)
      - name: ğŸ—ï¸ Derleme KontrolÃ¼
        id: build
        run: |
          echo "ğŸ”¨ Derleme deneniyor..."
          TYPE="${{ steps.setup.outputs.env_type }}"
          
          if [ "$TYPE" == "android" ]; then
             chmod +x gradlew || true
             if ./gradlew assembleDebug; then
               echo "STATUS=BAÅARILI" >> $GITHUB_ENV
             else
               echo "STATUS=HATA (Ama kodlar kaydedildi)" >> $GITHUB_ENV
             fi
          elif [ "$TYPE" == "node" ]; then
             npm install
             npm run build --if-present
             echo "STATUS=TAMAMLANDI" >> $GITHUB_ENV
          else
             echo "STATUS=DERLEME YOK (Genel Proje)" >> $GITHUB_ENV
          fi
        continue-on-error: true

      # 6. KAYDET (Direct Push to Main - Branch Yok!)
      - name: ğŸ’¾ Kaydet ve Yolla (Direct Push)
        run: |
          git config --global user.name "DeepSeek OMNI"
          git config --global user.email "bot@deepseek.com"
          git add .
          git commit -m "ğŸ¤– DeepSeek: ${{ github.event.inputs.task || 'Otomatik GeliÅŸtirme' }}" || echo "DeÄŸiÅŸiklik yok"
          git push

      # 7. RAPOR
      - name: ğŸ“Š Rapor
        uses: actions/github-script@v7
        if: always()
        env:
          THINKING_B64: ${{ steps.coder.outputs.thinking }}
          REPLY_B64: ${{ steps.coder.outputs.reply }}
          FILES: ${{ steps.coder.outputs.files }}
          STATUS: ${{ env.STATUS }}
        with:
          script: |
            const safeDecode = (str) => {
                try { return Buffer.from(str || '', 'base64').toString('utf-8'); } catch(e) { return "Veri yok"; }
            };
            
            const thinking = safeDecode(process.env.THINKING_B64);
            const reply = safeDecode(process.env.REPLY_B64);
            
            let msg = `### ğŸš€ DeepSeek OMNI Raporu\n\n`;
            msg += `**Durum:** ${process.env.STATUS}\n`;
            msg += `**Ä°ÅŸlemler:**\n${process.env.FILES}\n\n`;
            msg += `<details><summary>ğŸ§  Modelin DÃ¼ÅŸÃ¼nce SÃ¼reci</summary>\n\n${thinking.substring(0,3000)}\n</details>\n\n`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: msg
            });
