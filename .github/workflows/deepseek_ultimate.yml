name: DeepSeek Ultimate

on:
  workflow_dispatch:
    inputs:
      task:
        description: 'Yapılacak görev'
        required: true
        type: string
  push:
    branches:
      - main
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]

jobs:
  deepseek:
    runs-on: ubuntu-latest
    env:
      GIT_COMMITTER_NAME: "github-actions[bot]"
      GIT_COMMITTER_EMAIL: "github-actions[bot]@users.noreply.github.com"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Git Yapılandırması
        run: |
          git config --global user.name "${GIT_COMMITTER_NAME}"
          git config --global user.email "${GIT_COMMITTER_EMAIL}"
          git config --global pull.rebase false
          git config --global push.autoSetupRemote true

      - name: Senkronizasyon
        run: |
          set -euo pipefail
          echo "Uzak değişiklikler kontrol ediliyor..."
          git fetch origin || true
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "")
          if [ -z "$CURRENT_BRANCH" ] || [ "$CURRENT_BRANCH" = "HEAD" ]; then
            CURRENT_BRANCH="${GITHUB_REF##*/}"
          fi
          echo "Mevcut dal: $CURRENT_BRANCH"
          if git ls-remote --exit-code origin "$CURRENT_BRANCH" >/dev/null 2>&1; then
            if git diff --quiet HEAD origin/"$CURRENT_BRANCH" 2>/dev/null; then
              echo "Yerel ve uzak senkronize."
            else
              echo "Uzak değişiklikler birleştiriliyor..."
              git pull origin "$CURRENT_BRANCH" --no-edit || true
            fi
          else
            echo "Uzakta $CURRENT_BRANCH dalı bulunamadı; devam ediliyor."
          fi

      - name: Proje Tipi Algılama
        id: detect
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let projectType = 'general';
            let projectDetails = [];
            if (fs.existsSync('build.gradle') || fs.existsSync('app/build.gradle') ||
                fs.existsSync('build.gradle.kts') || fs.existsSync('settings.gradle') ||
                fs.existsSync('settings.gradle.kts')) {
              projectType = 'android';
              projectDetails.push('Android/Kotlin');
            }
            if (fs.existsSync('package.json')) {
              if (projectType === 'general') projectType = 'node';
              projectDetails.push('Node.js/JavaScript');
            }
            if (fs.existsSync('requirements.txt') || fs.existsSync('pyproject.toml') ||
                fs.existsSync('setup.py') || fs.existsSync('Pipfile')) {
              if (projectType === 'general') projectType = 'python';
              projectDetails.push('Python');
            }
            if (fs.existsSync('CMakeLists.txt') || fs.existsSync('Makefile') ||
                fs.existsSync('meson.build')) {
              if (projectType === 'general') projectType = 'cpp';
              projectDetails.push('C/C++');
            }
            if (fs.existsSync('Cargo.toml')) {
              if (projectType === 'general') projectType = 'rust';
              projectDetails.push('Rust');
            }
            if (fs.existsSync('go.mod')) {
              if (projectType === 'general') projectType = 'go';
              projectDetails.push('Go');
            }
            console.log('Tespit Edilen Tip: ' + projectType);
            console.log('Detaylar: ' + (projectDetails.join(', ') || 'Genel Proje'));
            core.setOutput('type', projectType);
            core.setOutput('details', projectDetails.join(', ') || 'Genel Proje')

      - name: Model Selection
        id: model_selector
        run: |
          TASK="${{ github.event.inputs.task }}"
          
          if echo "$TASK" | grep -qiE "(IMO|CMO|ICPC|IOI|olympiad|gold-medal|ultimate reasoning|speciale)"; then
            echo "model=deepseek-reasoner" >> $GITHUB_OUTPUT
            echo "base_url=https://api.deepseek.com/v3.2_speciale_expires_on_20251215" >> $GITHUB_OUTPUT
            echo "complexity=speciale" >> $GITHUB_OUTPUT
          elif echo "$TASK" | grep -qiE "(migrasi|refactor|optimize|kompleks|yapı|arch|design|pattern|benchmark|performance|security|debug|investigate|critical|enhance|improve|transform|restructure)"; then
            echo "model=deepseek-reasoner" >> $GITHUB_OUTPUT
            echo "base_url=https://api.deepseek.com" >> $GITHUB_OUTPUT
            echo "complexity=high" >> $GITHUB_OUTPUT
          else
            echo "model=deepseek-chat" >> $GITHUB_OUTPUT
            echo "base_url=https://api.deepseek.com" >> $GITHUB_OUTPUT
            echo "complexity=low" >> $GITHUB_OUTPUT
          fi

      - name: Java Kurulumu
        if: steps.detect.outputs.type == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Node.js Kurulumu
        if: steps.detect.outputs.type == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Python Kurulumu
        if: steps.detect.outputs.type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Rust Kurulumu
        if: steps.detect.outputs.type == 'rust'
        uses: dtolnay/rust-toolchain@stable

      - name: Go Kurulumu
        if: steps.detect.outputs.type == 'go'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Setup Python for DeepSeek
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install requests

      - name: Validate DEEPSEEK_API_KEY
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          BASE_URL: ${{ steps.model_selector.outputs.base_url }}
        run: |
          python3 - <<'PY'
          import os, sys, requests
          def sanitize_key(k):
              if k is None:
                  return None
              k = k.strip()
              # remove surrounding quotes if present
              if (k.startswith("'") and k.endswith("'")) or (k.startswith('"') and k.endswith('"')):
                  k = k[1:-1].strip()
              # remove leading byte-literal prefix b'...' or b"..."
              if (k.startswith("b'") and k.endswith("'")) or (k.startswith('b"') and k.endswith('"')):
                  k = k[2:-1]
              # final strip of whitespace/newlines
              return k.strip()

          raw = os.environ.get('DEEPSEEK_API_KEY')
          key = sanitize_key(raw)
          if not key:
              print("DEEPSEEK_API_KEY yok veya boş")
              sys.exit(1)
          base = (os.environ.get('BASE_URL') or "https://api.deepseek.com").rstrip('/')
          url = base + "/v1/models"
          try:
              # length check (safe to print)
              print("Key length:", len(key))
              r = requests.get(url, headers={'Authorization': f'Bearer {key}'}, timeout=10)
              print("Auth check HTTP status:", r.status_code)
              if r.status_code == 401:
                  print("Unauthorized: DEEPSEEK_API_KEY geçersiz veya izin yok")
                  sys.exit(2)
              r.raise_for_status()
              print("DEEPSEEK API anahtar doğrulandı")
          except Exception as e:
              print("Auth check failed:", e)
              sys.exit(3)
          PY

      - name: DeepSeek Kodlama Motoru
        id: deepseek
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_TASK: ${{ github.event.inputs.task || (github.event.comment && github.event.comment.body) || (github.event.issue && github.event.issue.body) || 'Proje optimize et' }}
          MODEL: ${{ steps.model_selector.outputs.model }}
          BASE_URL: ${{ steps.model_selector.outputs.base_url }}
          PROJECT_TYPE: ${{ steps.detect.outputs.type }}
          PROJECT_DETAILS: ${{ steps.detect.outputs.details }}
        run: |
          python3 << 'PYTHON_EOF'
          import os
          import sys
          import time
          import json
          import re
          from pathlib import Path
          import requests

          # GITHUB_OUTPUT helper: single-line or multiline safe
          GITHUB_OUTPUT = os.environ.get('GITHUB_OUTPUT', '/dev/null')
          def write_output(name: str, value: str):
              try:
                  with open(GITHUB_OUTPUT, 'a') as f:
                      if '\n' in value:
                          f.write(f"{name}<<EOF\n")
                          f.write(value)
                          if not value.endswith('\n'):
                              f.write('\n')
                          f.write("EOF\n")
                      else:
                          sanitized = value.replace('\r', '').replace('`', "'")
                          f.write(f"{name}={sanitized}\n")
              except Exception:
                  pass

          # Read envs
          api_key = os.environ.get('DEEPSEEK_API_KEY')
          api_base = (os.environ.get('BASE_URL') or "https://api.deepseek.com").rstrip('/')
          MODEL = os.environ.get('MODEL') or 'deepseek-chat'
          USER_TASK = os.environ.get('USER_TASK') or 'Proje optimize et'
          PROJECT_TYPE = os.environ.get('PROJECT_TYPE', '')
          PROJECT_DETAILS = os.environ.get('PROJECT_DETAILS', '')

          # Sanitize API key
          def sanitize_key(k: str) -> str:
              if k is None:
                  return None
              k = k.strip()
              # remove surrounding quotes
              if (k.startswith("'") and k.endswith("'")) or (k.startswith('"') and k.endswith('"')):
                  k = k[1:-1].strip()
              # remove leading byte literal b'...' or b"..."
              if (k.startswith("b'") and k.endswith("'")) or (k.startswith('b"') and k.endswith('"')):
                  k = k[2:-1]
              return k.strip()

          api_key = sanitize_key(api_key)
          if not api_key:
              msg = "DEEPSEEK_API_KEY yok veya boş. Lütfen repo secrets içine DEEPSEEK_API_KEY ekleyin."
              print(msg)
              write_output("success", "false")
              write_output("error", msg)
              sys.exit(1)

          # Scan repository for context
          fileList = []
          repoContext = ""
          ignoreDirs = {'.git', 'node_modules', 'build', 'dist', '.gradle', 'venv', '__pycache__', 'target', '.idea', '.vscode', 'bin', 'obj', 'out', 'vendor'}
          codeExtensions = {
              '.js', '.ts', '.jsx', '.tsx', '.mjs', '.cjs',
              '.py', '.pyw', '.pyi', '.java', '.kt', '.kts',
              '.scala', '.cpp', '.cc', '.cxx', '.c', '.h', '.hpp', '.hxx',
              '.cs', '.fs', '.vb', '.go', '.rs', '.php', '.rb', '.pl',
              '.swift', '.sh', '.ps1', '.yaml', '.yml', '.xml', '.json',
              '.gradle', '.properties'
          }

          def scanDirectory(directory, depth=0):
              global fileList, repoContext
              if depth > 10 or not Path(directory).exists():
                  return
              try:
                  for item in Path(directory).iterdir():
                      if item.name.startswith('.') and item.name != '.gitignore':
                          continue
                      if item.is_dir():
                          if item.name not in ignoreDirs:
                              scanDirectory(item, depth + 1)
                      elif item.is_file():
                          if item.suffix.lower() in codeExtensions or item.name in ['Dockerfile', 'Makefile', 'CMakeLists.txt']:
                              try:
                                  content = item.read_text(encoding='utf-8')
                                  if len(content) < 100000:
                                      relPath = str(item.relative_to('.'))
                                      repoContext += f"\n=== {relPath} ===\n{content}\n"
                                      fileList.append(relPath)
                              except Exception:
                                  pass
              except Exception:
                  pass

          scanDirectory('.')
          print(f"Taranan dosya: {len(fileList)}")

          # System prompt (triple-quoted f-string)
          systemPrompt = f"""Sen DeepSeek V3.2, dünya standardında profesyonel yazılım mühendisisin.

          PROJE BILGISI:
          - Tip: {PROJECT_TYPE}
          - Detaylar: {PROJECT_DETAILS}
          - Model: {MODEL}

          GÖREV:
          {USER_TASK}

          DOSYA YAZMA FORMATI:
          ---FILE: dosya/yolu/isim.uzanti---
          [dosya içeriği]
          ---END---

          DOSYA SILME FORMATI:
          ---DELETE: dosya/yolu/isim.uzanti---
          ---END---

          DİZİN SILME FORMATI:
          ---DELETEDIR: klasor/yolu---
          ---END---

          KURALLAR:
          ✅ Tam çalışan, production-ready kod yaz
          ✅ Hata yönetimi ekle
          ✅ Türkçe yorum ekle
          ✅ Best practices uygula
          ✅ Test kodunu dahil et
          ❌ Markdown code block kullanma (backtick yok)
          ❌ Eksik kod yazma
          ❌ Placeholder bırakma

          MEVCUT DOSYALAR: {', '.join(fileList[:20]) if fileList else 'Yok'}"""

          # Direct HTTP helper (OpenAI-compatible)
          def post_chat(api_base, api_key, model, messages, max_tokens=16000, temperature=0.7, timeout=60):
              url = f"{api_base}/v1/chat/completions"
              headers = {
                  "Authorization": f"Bearer {api_key}",
                  "Content-Type": "application/json"
              }
              payload = {
                  "model": model,
                  "messages": messages,
                  "max_tokens": max_tokens,
                  "temperature": temperature
              }
              return requests.post(url, headers=headers, json=payload, timeout=timeout)

          def parse_response(resp_json):
              try:
                  choices = resp_json.get('choices') or []
                  if choices:
                      msg = choices[0].get('message') or {}
                      content = msg.get('content')
                      if content:
                          return content
                      reasoning = msg.get('reasoning_content')
                      if reasoning:
                          return reasoning
                      text = choices[0].get('text')
                      if text:
                          return text
              except Exception:
                  pass
              return json.dumps(resp_json)

          # Retry/backoff
          max_retries = 3
          backoff = 2
          aiResponse = None
          last_exc = None

          messages = [
              {"role":"system","content": systemPrompt},
              {"role":"user","content": repoContext or "Boş proje - sıfırdan başla"}
          ]

          for attempt in range(1, max_retries + 1):
              try:
                  resp = post_chat(api_base, api_key, MODEL, messages,
                                   max_tokens=16000,
                                   temperature=0.5 if MODEL == 'deepseek-reasoner' else 0.7)
                  print("HTTP status:", resp.status_code)
                  if resp.status_code == 401:
                      msg = "Unauthorized (401): DEEPSEEK_API_KEY geçersiz veya izin yok"
                      print(msg)
                      write_output("success","false")
                      write_output("error", msg)
                      sys.exit(1)
                  if not resp.ok:
                      raise Exception(f"HTTP {resp.status_code}: {resp.text[:1000]}")
                  data = resp.json()
                  aiResponse = parse_response(data)
                  print("AI yanıtı alındı")
                  break
              except Exception as e:
                  last_exc = e
                  serr = str(e).replace('`', "'")
                  print(f"API çağrısı hatası (deneme {attempt}/{max_retries}): {serr}")
                  if attempt < max_retries:
                      sleep_time = backoff ** attempt
                      print(f"{sleep_time}s beklenip tekrar deneniyor...")
                      time.sleep(sleep_time)
                  else:
                      raise

          if aiResponse is None:
              err = f"No response from API. Last error: {last_exc}"
              print(err)
              write_output("success","false")
              write_output("error", str(last_exc))
              sys.exit(1)

          # Parse operations from aiResponse
          operations = []
          for m in re.finditer(r'---DELETEDIR:\s*(.+?)\s*---', aiResponse):
              dirPath = m.group(1).strip()
              if Path(dirPath).exists() and Path(dirPath).is_dir():
                  import shutil
                  shutil.rmtree(dirPath)
                  operations.append(f"Klasör silindi: {dirPath}")
          for m in re.finditer(r'---DELETE:\s*(.+?)\s*---', aiResponse):
              filePath = m.group(1).strip()
              if Path(filePath).exists():
                  Path(filePath).unlink()
                  operations.append(f"Dosya silindi: {filePath}")
          for m in re.finditer(r'---FILE:\s*(.+?)\s*---\n([\s\S]*?)---END---', aiResponse):
              filePath = m.group(1).strip()
              content = m.group(2).rstrip()
              dirPath = Path(filePath).parent
              if dirPath != Path('.'):
                  dirPath.mkdir(parents=True, exist_ok=True)
              Path(filePath).write_text(content, encoding='utf-8')
              operations.append(f"Yazıldı: {filePath}")

          # Write outputs safely
          write_output("operations", '\n'.join(operations) if operations else 'İşlem yapılmadı')
          write_output("count", str(len(operations)))
          write_output("success", "true")
          PYTHON_EOF

      - name: Derleme
        id: build
        if: steps.deepseek.outputs.success == 'true'
        continue-on-error: true
        run: |
          set -euo pipefail
          TYPE="${{ steps.detect.outputs.type }}"
          echo "Derleme başlatılıyor... (Tip: $TYPE)"
          case "$TYPE" in
            android)
              if [ -f "gradlew" ]; then
                chmod +x gradlew
                ./gradlew assembleDebug -Pkotlin.suppressVersionCompatibilityCheck=true --no-daemon && echo "BUILD_STATUS=Başarılı" >> $GITHUB_ENV || echo "BUILD_STATUS=Derleme hatası" >> $GITHUB_ENV
              else
                echo "BUILD_STATUS=Gradle wrapper bulunamadı" >> $GITHUB_ENV
              fi
              ;;
            node)
              if [ -f "package.json" ]; then
                npm ci --silent || npm install --silent
                npm run build --if-present && echo "BUILD_STATUS=Başarılı" >> $GITHUB_ENV || echo "BUILD_STATUS=Build hatası" >> $GITHUB_ENV
              else
                echo "BUILD_STATUS=package.json bulunamadı" >> $GITHUB_ENV
              fi
              ;;
            python)
              if [ -f "requirements.txt" ]; then
                pip install -r requirements.txt --quiet
              fi
              echo "BUILD_STATUS=Bağımlılıklar yüklendi" >> $GITHUB_ENV
              ;;
            rust)
              cargo build --release && echo "BUILD_STATUS=Başarılı" >> $GITHUB_ENV || echo "BUILD_STATUS=Cargo hatası" >> $GITHUB_ENV
              ;;
            go)
              go build ./... && echo "BUILD_STATUS=Başarılı" >> $GITHUB_ENV || echo "BUILD_STATUS=Go hatası" >> $GITHUB_ENV
              ;;
            *)
              echo "BUILD_STATUS=Derleme gerekmedi" >> $GITHUB_ENV
              ;;
          esac

      - name: Değişiklikleri Kaydet
        if: steps.deepseek.outputs.success == 'true'
        run: |
          set -euo pipefail
          echo "Değişiklikler kontrol ediliyor..."
          git add -A
          if git diff --cached --quiet; then
            echo "Değişiklik yok"
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          else
            echo "Değişiklikler tespit edildi"
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
            TASK="${{ github.event.inputs.task || (github.event.comment && github.event.comment.body) || (github.event.issue && github.event.issue.body) || 'Otomatik güncelleme' }}"
            TASK_SHORT=$(echo "$TASK" | head -c 100)
            git -c user.name="${GIT_COMMITTER_NAME}" -c user.email="${GIT_COMMITTER_EMAIL}" commit -m "DeepSeek Ultimate: $TASK_SHORT" -m "Model: ${{ steps.model_selector.outputs.model }}" -m "Kompleksite: ${{ steps.model_selector.outputs.complexity }}" || true
          fi

      - name: Değişiklikleri Gönder
        if: env.HAS_CHANGES == 'true'
        run: |
          set -euo pipefail
          echo "Değişiklikler gönderiliyor..."
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "main")
          git pull origin "$CURRENT_BRANCH" --no-edit || true
          git push origin "$CURRENT_BRANCH"
          echo "Push başarılı!"

      - name: Sonuç Raporu
        uses: actions/github-script@v7
        if: always()
        env:
          OPERATIONS: ${{ steps.deepseek.outputs.operations }}
          COUNT: ${{ steps.deepseek.outputs.count }}
          SUCCESS: ${{ steps.deepseek.outputs.success }}
          ERROR: ${{ steps.deepseek.outputs.error }}
          BUILD_STATUS: ${{ env.BUILD_STATUS }}
          PROJECT_TYPE: ${{ steps.detect.outputs.type }}
          PROJECT_DETAILS: ${{ steps.detect.outputs.details }}
          MODEL: ${{ steps.model_selector.outputs.model }}
          COMPLEXITY: ${{ steps.model_selector.outputs.complexity }}
        with:
          script: |
            const success = process.env.SUCCESS === 'true';
            const operations = process.env.OPERATIONS || 'İşlem yapılmadı';
            const count = process.env.COUNT || '0';
            const buildStatus = process.env.BUILD_STATUS || 'Derleme yapılmadı';
            const projectType = process.env.PROJECT_TYPE || 'general';
            const projectDetails = process.env.PROJECT_DETAILS || 'Genel';
            const model = process.env.MODEL || 'deepseek-chat';
            const complexity = process.env.COMPLEXITY || 'low';
            
            const statusEmoji = success ? '✅ BAŞARILI' : '❌ HATA';
            let report = '## DeepSeek Ultimate Raporu\n\n';
            
            report += '| Özellik | Değer |\n';
            report += '|---------|-------|\n';
            report += '| **Durum** | ' + statusEmoji + ' |\n';
            report += '| **Model** | ' + model + ' |\n';
            report += '| **Kompleksite** | ' + complexity + ' |\n';
            report += '| **Proje Tipi** | ' + projectDetails + ' |\n';
            report += '| **İşlem Sayısı** | ' + count + ' |\n';
            report += '| **Derleme** | ' + buildStatus + ' |\n\n';
            
            if (operations && operations !== 'İşlem yapılmadı') {
              report += '### Yapılan İşlemler\n' + operations + '\n\n';
            }
            
            if (!success && process.env.ERROR) {
              report += '### Hata Detayı\n' + process.env.ERROR + '\n\n';
            }
            
            report += '\n---\n*DeepSeek Ultimate v3.2-Güncel tarafından oluşturuldu*';
            
            try {
              if (context.issue && context.issue.number) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: report
                });
              } else {
                core.info(report);
              }
            } catch (e) {
              console.log("Yorum eklenemedi: " + e.message);
            }
