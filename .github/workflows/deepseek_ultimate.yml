name: DEEPSEEK v12.0 ULTIMATE (STABLE & SECURE)
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      task:
        description: 'GÃ¶rev'
        required: true
        default: 'Projeyi analiz et ve geliÅŸtir'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  deepseek_stable_brain:
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Saat
    if: github.actor != 'github-actions[bot]'
    
    steps:
      # ========================================================
      # 1. SAHA HAZIRLIÄI
      # ========================================================
      - name: ğŸš€ Proje KaynaklarÄ±nÄ± Ã‡ek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ========================================================
      # 2. GÃœVENLÄ° ORTAM ANALÄ°ZÄ°
      # ========================================================
      - name: ğŸ” Proje Tipini AlgÄ±la
        id: analyzer
        shell: bash
        run: |
          echo "================================================"
          echo "ğŸ•µï¸ GÃœVENLÄ° ORTAM TARAMASI"
          echo "================================================"
          
          PROJECT_TYPE="genel"
          
          if [ -f "build.gradle" ] || [ -f "app/build.gradle" ] || [ -f "build.gradle.kts" ]; then
            PROJECT_TYPE="android"
            echo "âœ… Android Projesi"
            if [ ! -f "gradlew" ]; then
              gradle wrapper --gradle-version 8.5
            fi
            chmod +x gradlew
          elif [ -f "package.json" ]; then
            PROJECT_TYPE="nodejs"
            echo "âœ… Node.js Projesi"
          elif [ -f "requirements.txt" ] || [ -f "main.py" ]; then
            PROJECT_TYPE="python"
            echo "âœ… Python Projesi"
          fi
          
          echo "PROJECT_TYPE=$PROJECT_TYPE" >> $GITHUB_ENV
          
          # DosyalarÄ± gÃ¼venli bir ÅŸekilde listele ve geÃ§ici dosyaya yaz
          # (Context verisini JS iÃ§ine gÃ¶mmemek iÃ§in dosyaya yazÄ±yoruz)
          echo "--- FILE CONTEXT START ---" > context_data.txt
          
          find . -maxdepth 3 -not -path '*/.*' -not -path '*/node_modules*' -not -path '*/build*' | while read file; do
            if [ -f "$file" ]; then
              # Sadece kod dosyalarÄ±nÄ± al (Boyut limiti 20KB)
              if [[ "$file" =~ \.(js|json|py|java|kt|xml|gradle|html|css|md|yml|txt)$ ]]; then
                FILE_SIZE=$(stat -c%s "$file")
                if [ $FILE_SIZE -lt 20000 ]; then
                  echo ">>> DOSYA: $file" >> context_data.txt
                  cat "$file" >> context_data.txt
                  echo -e "\n--- END OF FILE ---\n" >> context_data.txt
                fi
              fi
            fi
          done

      # ========================================================
      # 3. ORTAM KURULUMU
      # ========================================================
      - name: â˜• Java Kurulumu (Android)
        if: env.PROJECT_TYPE == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: ğŸŸ¢ Node.js Kurulumu (Web)
        if: env.PROJECT_TYPE == 'nodejs'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ Python Kurulumu
        if: env.PROJECT_TYPE == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # ========================================================
      # 4. DEEPSEEK BEYNÄ° (GÃœVENLÄ° MOD)
      # ========================================================
      - name: ğŸ§  DeepSeek Reasoner Motoru
        id: deepseek_safe_engine
        uses: actions/github-script@v7
        timeout-minutes: 30
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          PROJECT_TYPE: ${{ env.PROJECT_TYPE }}
          # KullanÄ±cÄ± mesajÄ±nÄ± ENV olarak alÄ±yoruz (Injection hatasÄ±nÄ± Ã¶nler)
          USER_MSG: ${{ github.event.inputs.task || github.event.comment.body || github.event.issue.body }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            console.log("ğŸš€ [v12.0 GÃœVENLÄ° MOD] BaÅŸlatÄ±lÄ±yor...");
            
            // 1. GÃœVENLÄ° DEÄÄ°ÅKEN ALIMI
            const apiKey = process.env.DEEPSEEK_API_KEY;
            const projectType = process.env.PROJECT_TYPE;
            const userMsg = process.env.USER_MSG;
            
            if (!apiKey) throw new Error("API AnahtarÄ± bulunamadÄ±!");
            
            // 2. CONTEXT OKUMA (Dosyadan okuma = Hata riskini sÄ±fÄ±rlar)
            let contextData = "";
            try {
              if (fs.existsSync('context_data.txt')) {
                contextData = fs.readFileSync('context_data.txt', 'utf8');
                console.log(`ğŸ“š BaÄŸlam verisi okundu (${contextData.length} karakter).`);
              }
            } catch (e) { console.error("Context okuma hatasÄ±:", e); }

            // 3. SYSTEM PROMPT
            const systemPrompt = `
            Sen DeepSeek v12.0 (Ultimate Stable), dÃ¼nyanÄ±n en iyi otonom yazÄ±lÄ±mcÄ±sÄ±sÄ±n.
            Proje Tipi: ${projectType}
            
            GÃ–REVLERÄ°N:
            1. KullanÄ±cÄ±nÄ±n isteÄŸini analiz et.
            2. AÅŸaÄŸÄ±daki dosya iÃ§eriklerine bakarak eksikleri tamamla.
            3. "Reasoning" yeteneÄŸinle dÃ¼ÅŸÃ¼n, planla ve uygula.
            4. Hata yapma, yarÄ±m kod bÄ±rakma.
            
            Ã‡IKTI FORMATI (ZORUNLU):
            ---START_FILE: dosya_yolu---
            [Kod Ä°Ã§eriÄŸi]
            ---END_FILE---
            
            ---DELETE_FILE: dosya_yolu---
            ---END_DELETE---
            `.trim();

            // 4. API Ã‡AÄRISI
            try {
              const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: {
                  "Authorization": `Bearer ${apiKey}`, 
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  model: "deepseek-reasoner",
                  messages: [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: `Ä°STEK: ${userMsg}\n\nMEVCUT DOSYALAR:\n${contextData}` }
                  ],
                  stream: false,
                  max_tokens: 8000
                })
              });

              if (!response.ok) {
                 const errTxt = await response.text();
                 throw new Error(`API HatasÄ±: ${errTxt}`);
              }

              const data = await response.json();
              const aiReply = data.choices[0].message.content || "";
              const thinking = data.choices[0].message.reasoning_content || "DÃ¼ÅŸÃ¼nce verisi yok.";
              
              console.log("âš¡ AI CevabÄ± baÅŸarÄ±yla alÄ±ndÄ±.");
              
              // 5. DOSYA Ä°ÅLEME (GÃœVENLÄ° PARSE)
              const startRegex = /---START_FILE:\s*(.*?)---\n([\s\S]*?)\n---END_FILE---/g;
              const delRegex = /---DELETE_FILE:\s*(.*?)---\n---END_DELETE---/g;
              
              let match;
              let filesList = [];
              
              // Dosya OluÅŸturma
              while ((match = startRegex.exec(aiReply)) !== null) {
                  const fPath = match[1].trim();
                  const fContent = match[2].trim();
                  
                  // Dizin kontrolÃ¼
                  const dir = path.dirname(fPath);
                  if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                  
                  fs.writeFileSync(fPath, fContent);
                  console.log(`âœ… YazÄ±ldÄ±: ${fPath}`);
                  filesList.push(fPath);
              }
              
              // Dosya Silme
              while ((match = delRegex.exec(aiReply)) !== null) {
                  const fPath = match[1].trim();
                  if (fs.existsSync(fPath)) {
                      fs.unlinkSync(fPath);
                      console.log(`ğŸ—‘ï¸ Silindi: ${fPath}`);
                  }
              }
              
              // Ã‡Ä±ktÄ±larÄ± gÃ¼venli ÅŸekilde dÄ±ÅŸarÄ± aktar (Environment File kullanarak)
              // DoÄŸrudan setOutput kullanmak yerine GITHUB_OUTPUT dosyasÄ±na yazÄ±yoruz
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `thinking_b64=${Buffer.from(thinking).toString('base64')}\n`);
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `reply_b64=${Buffer.from(aiReply).toString('base64')}\n`);
              fs.appendFileSync(process.env.GITHUB_OUTPUT, `files=${filesList.join(', ')}\n`);

            } catch (err) {
              console.error("KRÄ°TÄ°K HATA:", err);
              throw err;
            }

      # ========================================================
      # 5. KODLARI KAYDET (COMMIT)
      # ========================================================
      - name: ğŸ’¾ KodlarÄ± Commit Et
        run: |
          git config --global user.name "DeepSeek v12"
          git config --global user.email "bot@deepseek.com"
          git add .
          git commit -m "ğŸ¤– DeepSeek v12: Otomatik GeliÅŸtirme" || echo "DeÄŸiÅŸiklik yok."
          git push

      # ========================================================
      # 6. DERLEME VE TEST
      # ========================================================
      - name: ğŸ—ï¸ Derleme (Build)
        id: build_step
        run: |
          echo "ğŸ”¨ Derleme BaÅŸlÄ±yor..."
          
          if [ "${{ env.PROJECT_TYPE }}" == "android" ]; then
            echo "ğŸ“± Android APK Derleniyor..."
            ./gradlew assembleDebug --stacktrace
            echo "BUILD_STATUS=SUCCESS" >> $GITHUB_ENV
          
          elif [ "${{ env.PROJECT_TYPE }}" == "nodejs" ]; then
            echo "ğŸŸ¢ Node.js Build..."
            npm install
            npm run build --if-present
            echo "BUILD_STATUS=SUCCESS" >> $GITHUB_ENV
            
          elif [ "${{ env.PROJECT_TYPE }}" == "python" ]; then
            echo "ğŸ Python Syntax Check..."
            python3 -m py_compile *.py || true
            echo "BUILD_STATUS=SUCCESS" >> $GITHUB_ENV
          fi
        continue-on-error: true

      # ========================================================
      # 7. ARTIFACTS (SONUÃ‡ DOSYALARI)
      # ========================================================
      - name: ğŸ“¤ APK YÃ¼kle
        if: env.PROJECT_TYPE == 'android'
        uses: actions/upload-artifact@v4
        with:
          name: app-debug
          path: app/build/outputs/apk/debug/*.apk

      # ========================================================
      # 8. GÃœVENLÄ° RAPORLAMA
      # ========================================================
      - name: ğŸ“Š SonuÃ§ Raporu
        uses: actions/github-script@v7
        env:
          THINKING_B64: ${{ steps.deepseek_safe_engine.outputs.thinking_b64 }}
          REPLY_B64: ${{ steps.deepseek_safe_engine.outputs.reply_b64 }}
          FILES: ${{ steps.deepseek_safe_engine.outputs.files }}
          BUILD_STATUS: ${{ env.BUILD_STATUS }}
        with:
          script: |
            // DeÄŸiÅŸkenleri gÃ¼venli ÅŸekilde Ã§Ã¶z (Base64 decode)
            // Bu yÃ¶ntem 'ReferenceError' ve karakter hatalarÄ±nÄ± %100 Ã¶nler.
            
            const decode = (str) => {
              try { return Buffer.from(str || '', 'base64').toString('utf-8'); }
              catch (e) { return "Veri Ã§Ã¶zÃ¼lemedi"; }
            };
            
            const thinking = decode(process.env.THINKING_B64);
            const reply = decode(process.env.REPLY_B64);
            const files = process.env.FILES || "DeÄŸiÅŸiklik yok";
            const buildStatus = process.env.BUILD_STATUS || "ATLANDI";
            
            let body = `### ğŸ›¡ï¸ DeepSeek v12.0 (Stable) Raporu\n\n`;
            
            body += `<details><summary>ğŸ§  <b>DÃ¼ÅŸÃ¼nce SÃ¼reci (Reasoning Trace)</b></summary>\n\n\`\`\`text\n${thinking.substring(0, 5000)}...\n\`\`\`\n</details>\n\n`;
            
            body += `#### ğŸ› ï¸ Ä°ÅŸlem Ã–zeti:\n`;
            body += `- **Dosyalar:** ${files}\n`;
            body += `- **Derleme:** ${buildStatus}\n\n`;
            
            body += `#### ğŸ’¬ AI MesajÄ±:\n${reply.substring(0, 2000)}...\n\n`;
            
            if (buildStatus === 'SUCCESS' && process.env.PROJECT_TYPE === 'android') {
                body += `ğŸ‰ **APK DosyasÄ± HazÄ±r!** YukarÄ±dan indirebilirsiniz.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
