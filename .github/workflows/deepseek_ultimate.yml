name: DEEPSEEK OMNI v23.0 (DIRECT PUSH)
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      task:
        description: 'G√∂rev'
        required: true
        default: 'Projeyi geli≈ütir'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  omni_direct:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: github.actor != 'github-actions[bot]'
    
    steps:
      # 1. SAHA HAZIRLIƒûI
      - name: üöÄ Projeyi √áek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. ORTAM ANALƒ∞Zƒ∞ VE HAZIRLIK (Node.js ile)
      - name: üß† Analiz ve Kurulum
        id: setup
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            // Proje tipini belirle
            let type = 'general';
            if (fs.existsSync('build.gradle') || fs.existsSync('app/build.gradle')) type = 'android';
            else if (fs.existsSync('package.json')) type = 'node';
            else if (fs.existsSync('requirements.txt')) type = 'python';
            
            console.log(`‚úÖ Proje Tipi: ${type}`);
            core.setOutput('env_type', type);

      # 3. ORTAM KURULUMLARI (Otomatik)
      - name: ‚òï Java (Android)
        if: steps.setup.outputs.env_type == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: üü¢ Node.js
        if: steps.setup.outputs.env_type == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: üêç Python
        if: steps.setup.outputs.env_type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 4. DEEPSEEK BEYNƒ∞ (KODLAMA)
      - name: ‚ö° DeepSeek Kodlama Motoru
        id: coder
        uses: actions/github-script@v7
        timeout-minutes: 30
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_MSG: ${{ github.event.inputs.task || github.event.comment.body || github.event.issue.body }}
          ENV_TYPE: ${{ steps.setup.outputs.env_type }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Mevcut dosyalarƒ± oku (Context)
            let repoContext = "";
            function scan(dir) {
                if (!fs.existsSync(dir)) return;
                const files = fs.readdirSync(dir);
                for (const f of files) {
                    if (['.git', 'node_modules', 'build', '.gradle'].includes(f)) continue;
                    const fp = path.join(dir, f);
                    if (fs.statSync(fp).isDirectory()) scan(fp);
                    else {
                        if (fp.match(/\.(js|py|java|kt|xml|gradle|json|md|html|css|txt)$/)) {
                            if (fs.statSync(fp).size < 15000) {
                                repoContext += `FILE: ${fp}\n${fs.readFileSync(fp, 'utf8')}\n---\n`;
                            }
                        }
                    }
                }
            }
            scan('.');

            const prompt = `
            Sen DeepSeek OMNI. Proje Tipi: ${process.env.ENV_TYPE}
            
            G√ñREV:
            Kullanƒ±cƒ± isteƒüini (${process.env.USER_MSG}) yerine getir.
            
            KURALLAR:
            1. Tam √ßalƒ±≈üan, profesyonel kod yaz.
            2. FORMAT: ---FILE:dosya/yolu--- i√ßerik ---END---
            3. D√º≈ü√ºnce zincirini (Reasoning) kullan.
            4. Asla markdown (backtick) i√ßine alma.
            `;

            try {
                const response = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${process.env.API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "deepseek-reasoner",
                        messages: [{ role: "system", content: prompt }, { role: "user", content: repoContext }],
                        stream: false,
                        max_tokens: 8000
                    })
                });
                
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                
                const aiReply = data.choices[0].message.content;
                const thinking = data.choices[0].message.reasoning_content || "";
                
                // Dosyalarƒ± Yaz
                const regex = /---FILE:\s*(.*?)---\n([\s\S]*?)---END---/g;
                let match;
                let files = [];
                while ((match = regex.exec(aiReply)) !== null) {
                    const fpath = match[1].trim();
                    const content = match[2].trim();
                    const dir = path.dirname(fpath);
                    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                    fs.writeFileSync(fpath, content);
                    files.push(fpath);
                    console.log("Yazƒ±ldƒ±:", fpath);
                }
                
                // Base64 ile g√ºvenli aktarƒ±m
                core.setOutput('files', files.join(', '));
                core.setOutput('reply', Buffer.from(aiReply).toString('base64'));
                core.setOutput('thinking', Buffer.from(thinking).toString('base64'));

            } catch (e) {
                core.setFailed(e.message);
            }

      # 5. DERLEME (Build - Hata Olsa Bile Devam Et)
      - name: üèóÔ∏è Derleme Kontrol√º
        id: build
        run: |
          echo "üî® Derleme deneniyor..."
          
          if [ "${{ steps.setup.outputs.env_type }}" == "android" ]; then
             chmod +x gradlew || true
             if ./gradlew assembleDebug; then
               echo "STATUS=BA≈ûARILI" >> $GITHUB_ENV
             else
               echo "STATUS=HATA (Ama kodlar kaydedildi)" >> $GITHUB_ENV
             fi
          elif [ "${{ steps.setup.outputs.env_type }}" == "node" ]; then
             npm install
             npm run build --if-present
             echo "STATUS=TAMAMLANDI" >> $GITHUB_ENV
          else
             echo "STATUS=DERLEME YOK" >> $GITHUB_ENV
          fi
        continue-on-error: true

      # 6. KAYDET (Direct Push to Main)
      - name: üíæ Kaydet ve Yolla
        run: |
          git config --global user.name "DeepSeek OMNI"
          git config --global user.email "bot@deepseek.com"
          git add .
          git commit -m "ü§ñ DeepSeek: ${{ github.event.inputs.task || 'Geli≈ütirme' }}" || echo "Deƒüi≈üiklik yok"
          git push

      # 7. RAPOR
      - name: üìä Rapor
        uses: actions/github-script@v7
        if: always()
        env:
          THINKING_B64: ${{ steps.coder.outputs.thinking }}
          REPLY_B64: ${{ steps.coder.outputs.reply }}
          FILES: ${{ steps.coder.outputs.files }}
          STATUS: ${{ env.STATUS }}
        with:
          script: |
            const safeDecode = (str) => {
                try { return Buffer.from(str || '', 'base64').toString('utf-8'); } catch(e) { return "Veri yok"; }
            };
            
            const thinking = safeDecode(process.env.THINKING_B64);
            const reply = safeDecode(process.env.REPLY_B64);
            
            let msg = `### üöÄ DeepSeek OMNI Raporu\n\n`;
            msg += `**Durum:** ${process.env.STATUS}\n`;
            msg += `**Deƒüi≈üen Dosyalar:** ${process.env.FILES}\n\n`;
            msg += `<details><summary>üß† Modelin D√º≈ü√ºnce S√ºreci</summary>\n\n${thinking.substring(0,3000)}\n</details>\n\n`;
            msg += `**Cevap √ñzeti:**\n${reply.substring(0, 500)}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: msg
            });
