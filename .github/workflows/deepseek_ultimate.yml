name: DEEPSEEK ORCHESTRATOR v21.0 (GitFlow)
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      task:
        description: 'GÃ¶rev'
        required: true
        default: 'Projeyi geliÅŸtir'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  orchestrator:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: github.actor != 'github-actions[bot]'
    
    steps:
      # 1. ANA DALI Ã‡EK
      - name: ğŸš€ Ana Depoyu Ã‡ek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. GÃ–REV ANALÄ°ZÄ° VE BRANCH Ä°SMÄ° BELÄ°RLEME
      - name: ğŸ§  Strateji Belirle
        id: strategy
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_MSG: ${{ github.event.inputs.task || github.event.comment.body || github.event.issue.body }}
        with:
          script: |
            const userMsg = process.env.USER_MSG;
            console.log("KullanÄ±cÄ± Ä°steÄŸi:", userMsg);
            
            // Branch ismi Ã¼retmek iÃ§in basit bir AI Ã§aÄŸrÄ±sÄ± veya regex
            // Basitlik ve hÄ±z iÃ§in regex ve tarih kullanÄ±yoruz
            const cleanName = userMsg.toLowerCase().replace(/[^a-z0-9]/g, '-').substring(0, 30);
            const branchName = `feature/${cleanName}-${Date.now().toString().substring(8)}`;
            
            console.log(`Hedef Dal: ${branchName}`);
            core.setOutput('branch_name', branchName);
            
            // KonfigÃ¼rasyonu belirle (Ã–nceki hatayÄ± Ã¶nleyen gÃ¼venli yÃ¶ntem)
            // JSON ile uÄŸraÅŸmÄ±yoruz, doÄŸrudan Node.js iÃ§inde environment belirliyoruz.
            const fs = require('fs');
            let envConfig = { type: 'general', setup_cmd: 'echo "Setup yok"', build_cmd: 'echo "Build yok"' };
            
            if (fs.existsSync('build.gradle')) envConfig = { type: 'android', setup_cmd: 'chmod +x gradlew', build_cmd: './gradlew assembleDebug' };
            else if (fs.existsSync('package.json')) envConfig = { type: 'node', setup_cmd: 'npm install', build_cmd: 'npm run build --if-present' };
            else if (fs.existsSync('requirements.txt')) envConfig = { type: 'python', setup_cmd: 'pip install -r requirements.txt', build_cmd: 'python -m py_compile *.py' };
            
            core.setOutput('env_type', envConfig.type);
            core.setOutput('setup_cmd', envConfig.setup_cmd);
            core.setOutput('build_cmd', envConfig.build_cmd);

      # 3. YENÄ° DAL OLUÅTUR VE GEÃ‡Ä°Å YAP
      - name: ğŸŒ¿ Yeni Dal OluÅŸtur
        run: |
          git config --global user.name "DeepSeek Orchestrator"
          git config --global user.email "bot@deepseek.com"
          BRANCH_NAME="${{ steps.strategy.outputs.branch_name }}"
          git checkout -b $BRANCH_NAME
          echo "CURRENT_BRANCH=$BRANCH_NAME" >> $GITHUB_ENV
          echo "âœ… Ã‡alÄ±ÅŸma alanÄ±: $BRANCH_NAME dalÄ±na taÅŸÄ±ndÄ±."

      # 4. ORTAM KURULUMU (Dinamik)
      - name: ğŸ› ï¸ Ortam HazÄ±rla
        uses: actions/setup-java@v4
        if: steps.strategy.outputs.env_type == 'android'
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ğŸŸ¢ Node HazÄ±rla
        uses: actions/setup-node@v4
        if: steps.strategy.outputs.env_type == 'node'
        with:
          node-version: '20'

      - name: ğŸ Python HazÄ±rla
        uses: actions/setup-python@v5
        if: steps.strategy.outputs.env_type == 'python'
        with:
          python-version: '3.10'

      # 5. DEEPSEEK BEYNÄ° (KODLAMA)
      - name: âš¡ DeepSeek Reasoner (Kodlama)
        id: coder
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_MSG: ${{ github.event.inputs.task || github.event.comment.body || github.event.issue.body }}
          ENV_TYPE: ${{ steps.strategy.outputs.env_type }}
        with:
          timeout-minutes: 30
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Mevcut dosyalarÄ± oku (Context)
            let context = "";
            function scan(dir) {
                if (!fs.existsSync(dir)) return;
                const files = fs.readdirSync(dir);
                for (const f of files) {
                    if (['.git', 'node_modules', 'build'].includes(f)) continue;
                    const fp = path.join(dir, f);
                    if (fs.statSync(fp).isDirectory()) scan(fp);
                    else {
                        if (fp.match(/\.(js|py|java|kt|xml|gradle|json|md|html|css)$/)) {
                            if (fs.statSync(fp).size < 10000) context += `FILE: ${fp}\n${fs.readFileSync(fp, 'utf8')}\n---\n`;
                        }
                    }
                }
            }
            scan('.');

            const systemPrompt = `
            Sen DeepSeek Orchestrator. 
            Åu an '${process.env.ENV_TYPE}' projesi Ã¼zerinde, '${process.env.USER_MSG}' gÃ¶revini yapÄ±yorsun.
            
            KURALLAR:
            1. Tam ve profesyonel kod yaz.
            2. Ã‡Ä±ktÄ± formatÄ±: ---FILE:dosya/yolu--- iÃ§erik ---END---
            3. Asla markdown bloÄŸu (backtick) iÃ§ine alma, dÃ¼z metin ver.
            4. DÃ¼ÅŸÃ¼nce zincirini (Reasoning) kullan.
            `;

            try {
                const response = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${process.env.API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "deepseek-reasoner",
                        messages: [{ role: "system", content: systemPrompt }, { role: "user", content: context }],
                        stream: false,
                        max_tokens: 8000
                    })
                });
                
                const data = await response.json();
                if (!data.choices) throw new Error(JSON.stringify(data));
                
                const aiReply = data.choices[0].message.content;
                const thinking = data.choices[0].message.reasoning_content || "Thinking verisi yok.";
                
                // DosyalarÄ± Yaz
                const regex = /---FILE:\s*(.*?)---\n([\s\S]*?)---END---/g;
                let match;
                let files = [];
                while ((match = regex.exec(aiReply)) !== null) {
                    const fpath = match[1].trim();
                    const content = match[2].trim();
                    const dir = path.dirname(fpath);
                    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                    fs.writeFileSync(fpath, content);
                    files.push(fpath);
                    console.log("YazÄ±ldÄ±:", fpath);
                }
                
                core.setOutput('files', files.join(', '));
                core.setOutput('thinking', Buffer.from(thinking).toString('base64'));
                core.setOutput('reply', Buffer.from(aiReply).toString('base64'));

            } catch (e) {
                core.setFailed(e.message);
            }

      # 6. DERLEME VE TEST (Yeni Dalda)
      - name: ğŸ—ï¸ Derle ve Test Et
        id: build
        run: |
          echo "ğŸ”¨ Derleme BaÅŸlÄ±yor..."
          SETUP_CMD="${{ steps.strategy.outputs.setup_cmd }}"
          BUILD_CMD="${{ steps.strategy.outputs.build_cmd }}"
          
          eval "$SETUP_CMD"
          if eval "$BUILD_CMD"; then
            echo "âœ… Build BaÅŸarÄ±lÄ±"
            echo "BUILD_STATUS=SUCCESS" >> $GITHUB_ENV
          else
            echo "âŒ Build BaÅŸarÄ±sÄ±z (Ama kodlar kaydedilecek)"
            echo "BUILD_STATUS=FAILURE" >> $GITHUB_ENV
          fi
        continue-on-error: true

      # 7. COMMIT VE PUSH (Yeni Dala)
      - name: ğŸ’¾ Commit ve Push
        run: |
          git add .
          git commit -m "ğŸ¤– DeepSeek: ${{ github.event.inputs.task || 'Otomatik GeliÅŸtirme' }}"
          git push origin ${{ env.CURRENT_BRANCH }}

      # 8. PULL REQUEST OLUÅTURMA (Otomatik)
      - name: ğŸ”€ Pull Request AÃ§
        uses: actions/github-script@v7
        with:
          script: |
            const { repo, owner } = context.repo;
            const branch = process.env.CURRENT_BRANCH;
            const title = `ğŸ¤– DeepSeek AI: ${process.env.USER_MSG || 'Otomatik PR'}`;
            const body = `Bu PR, DeepSeek Orchestrator tarafÄ±ndan otomatik oluÅŸturulmuÅŸtur.\n\n**Dal:** \`${branch}\`\n**Durum:** HazÄ±r.`;
            
            try {
              await github.rest.pulls.create({
                owner,
                repo,
                title,
                body,
                head: branch,
                base: 'main'
              });
              console.log("âœ… PR OluÅŸturuldu!");
            } catch (e) {
              console.log("â„¹ï¸ PR zaten var veya hata oluÅŸtu:", e.message);
            }

      # 9. ARTIFACTS
      - name: ğŸ“¤ SonuÃ§larÄ± YÃ¼kle
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: |
            **/*.apk
            dist/
            build/

      # 10. RAPOR
      - name: ğŸ“Š Rapor
        uses: actions/github-script@v7
        env:
          THINKING_B64: ${{ steps.coder.outputs.thinking }}
          FILES: ${{ steps.coder.outputs.files }}
          BRANCH: ${{ env.CURRENT_BRANCH }}
        with:
          script: |
            const thinking = Buffer.from(process.env.THINKING_B64, 'base64').toString('utf-8');
            const files = process.env.FILES;
            const branch = process.env.BRANCH;
            
            let msg = `### ğŸŒ³ DeepSeek Orchestrator Raporu\n\n`;
            msg += `**âœ… Ä°ÅŸlem TamamlandÄ±!**\n`;
            msg += `Kodlar **\`${branch}\`** isimli yeni bir dala (branch) yazÄ±ldÄ±.\n`;
            msg += `LÃ¼tfen **"Pull Requests"** sekmesini kontrol edin.\n\n`;
            
            msg += `<details><summary>ğŸ§  DÃ¼ÅŸÃ¼nce SÃ¼reci</summary>\n\`\`\`\n${thinking.substring(0, 2000)}\n\`\`\`\n</details>\n\n`;
            msg += `**DeÄŸiÅŸen Dosyalar:** ${files}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: msg
            });
