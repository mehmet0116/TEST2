name: DEEPSEEK ORCHESTRATOR v22.0 (FIXED)
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      task:
        description: 'GÃ¶rev'
        required: true
        default: 'Projeyi geliÅŸtir'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  orchestrator_fix:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    if: github.actor != 'github-actions[bot]'
    
    steps:
      # 1. ANA DALI Ã‡EK
      - name: ğŸš€ Ana Depoyu Ã‡ek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. STRATEJÄ° VE CONFIG (Node.js ile)
      - name: ğŸ§  Strateji Belirle
        id: strategy
        uses: actions/github-script@v7
        env:
          USER_MSG: ${{ github.event.inputs.task || github.event.comment.body || github.event.issue.body }}
        with:
          script: |
            const userMsg = process.env.USER_MSG;
            
            // Branch ismi Ã¼ret
            const cleanName = userMsg.toLowerCase().replace(/[^a-z0-9]/g, '-').substring(0, 30);
            const branchName = `feature/${cleanName}-${Date.now().toString().substring(8)}`;
            core.setOutput('branch_name', branchName);
            
            // Ortam Tespiti
            const fs = require('fs');
            let type = 'general';
            let build = 'echo "Build yok"';
            let setup = 'echo "Setup yok"';
            
            if (fs.existsSync('build.gradle') || fs.existsSync('app/build.gradle')) {
               type = 'android';
               setup = 'chmod +x gradlew || true';
               build = './gradlew assembleDebug';
            } else if (fs.existsSync('package.json')) {
               type = 'node';
               setup = 'npm install';
               build = 'npm run build --if-present';
            } else if (fs.existsSync('requirements.txt')) {
               type = 'python';
               setup = 'pip install -r requirements.txt';
               build = 'python -m py_compile *.py';
            }
            
            core.setOutput('env_type', type);
            core.setOutput('setup_cmd', setup);
            core.setOutput('build_cmd', build);

      # 3. YENÄ° DAL OLUÅTUR
      - name: ğŸŒ¿ Yeni Dal (Branch) AÃ§
        run: |
          git config --global user.name "DeepSeek Orchestrator"
          git config --global user.email "bot@deepseek.com"
          BRANCH="${{ steps.strategy.outputs.branch_name }}"
          git checkout -b $BRANCH
          echo "CURRENT_BRANCH=$BRANCH" >> $GITHUB_ENV

      # 4. ORTAM KURULUMU
      - name: ğŸ› ï¸ Java Kurulumu (Android)
        if: steps.strategy.outputs.env_type == 'android'
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: ğŸŸ¢ Node Kurulumu
        if: steps.strategy.outputs.env_type == 'node'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ Python Kurulumu
        if: steps.strategy.outputs.env_type == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # 5. KODLAMA MOTORU (DÃ¼zeltilmiÅŸ)
      - name: âš¡ DeepSeek Reasoner
        id: coder
        uses: actions/github-script@v7
        timeout-minutes: 30 # <--- DÃœZELTÄ°LDÄ°: Yeri burasÄ±
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_MSG: ${{ github.event.inputs.task || github.event.comment.body || github.event.issue.body }}
          ENV_TYPE: ${{ steps.strategy.outputs.env_type }}
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // HATA DÃœZELTÄ°LDÄ°: DeÄŸiÅŸken adÄ± 'repoContext' oldu ('context' yasaklÄ±)
            let repoContext = "";
            
            function scan(dir) {
                if (!fs.existsSync(dir)) return;
                const files = fs.readdirSync(dir);
                for (const f of files) {
                    if (['.git', 'node_modules', 'build', '.gradle'].includes(f)) continue;
                    const fp = path.join(dir, f);
                    if (fs.statSync(fp).isDirectory()) scan(fp);
                    else {
                        if (fp.match(/\.(js|py|java|kt|xml|gradle|json|md|html|css|txt)$/)) {
                            if (fs.statSync(fp).size < 15000) {
                                repoContext += `FILE: ${fp}\n${fs.readFileSync(fp, 'utf8')}\n---\n`;
                            }
                        }
                    }
                }
            }
            scan('.');

            const prompt = `
            Sen DeepSeek Orchestrator. 
            Proje Tipi: ${process.env.ENV_TYPE}
            
            GÃ–REV:
            KullanÄ±cÄ± isteÄŸini (${process.env.USER_MSG}) yerine getir.
            
            KURALLAR:
            1. Tam Ã§alÄ±ÅŸan kod yaz.
            2. FORMAT: ---FILE:dosya/yolu--- iÃ§erik ---END---
            3. DÃ¼ÅŸÃ¼nce zincirini kullan.
            `;

            try {
                const response = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${process.env.API_KEY}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "deepseek-reasoner",
                        messages: [{ role: "system", content: prompt }, { role: "user", content: repoContext }],
                        stream: false,
                        max_tokens: 8000
                    })
                });
                
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                
                const aiReply = data.choices[0].message.content;
                const thinking = data.choices[0].message.reasoning_content || "";
                
                // Dosya Yazma
                const regex = /---FILE:\s*(.*?)---\n([\s\S]*?)---END---/g;
                let match;
                let files = [];
                while ((match = regex.exec(aiReply)) !== null) {
                    const fpath = match[1].trim();
                    const content = match[2].trim();
                    const dir = path.dirname(fpath);
                    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                    fs.writeFileSync(fpath, content);
                    files.push(fpath);
                }
                
                core.setOutput('files', files.join(', '));
                // Base64 encode (GÃ¼venlik iÃ§in)
                core.setOutput('reply', Buffer.from(aiReply).toString('base64'));
                core.setOutput('thinking', Buffer.from(thinking).toString('base64'));

            } catch (e) {
                core.setFailed(e.message);
            }

      # 6. DERLEME (Build)
      - name: ğŸ—ï¸ Derle
        run: |
          SETUP="${{ steps.strategy.outputs.setup_cmd }}"
          BUILD="${{ steps.strategy.outputs.build_cmd }}"
          
          echo "Setup: $SETUP"
          eval "$SETUP"
          
          echo "Build: $BUILD"
          if eval "$BUILD"; then
            echo "BUILD_STATUS=SUCCESS" >> $GITHUB_ENV
          else
            echo "BUILD_STATUS=FAILURE" >> $GITHUB_ENV
          fi
        continue-on-error: true

      # 7. COMMIT & PUSH
      - name: ğŸ’¾ Kaydet ve Pushla
        run: |
          git add .
          git commit -m "ğŸ¤– DeepSeek: ${{ github.event.inputs.task || 'GeliÅŸtirme' }}"
          git push origin ${{ env.CURRENT_BRANCH }}

      # 8. PULL REQUEST
      - name: ğŸ”€ PR AÃ§
        uses: actions/github-script@v7
        with:
          script: |
            const branch = process.env.CURRENT_BRANCH;
            try {
              await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸ¤– DeepSeek PR: ${branch}`,
                body: "DeepSeek tarafÄ±ndan otomatik oluÅŸturulan kodlar.",
                head: branch,
                base: 'main'
              });
            } catch(e) { console.log("PR zaten var veya hata:", e.message); }

      # 9. RAPOR
      - name: ğŸ“Š Rapor
        uses: actions/github-script@v7
        env:
          THINKING: ${{ steps.coder.outputs.thinking }}
          FILES: ${{ steps.coder.outputs.files }}
          STATUS: ${{ env.BUILD_STATUS }}
        with:
          script: |
            const thinking = Buffer.from(process.env.THINKING, 'base64').toString('utf-8');
            
            let msg = `### ğŸš€ Ä°ÅŸlem TamamlandÄ±\n`;
            msg += `**Durum:** ${process.env.STATUS}\n`;
            msg += `**Dosyalar:** ${process.env.FILES}\n\n`;
            msg += `<details><summary>DÃ¼ÅŸÃ¼nce SÃ¼reci</summary>\n\n${thinking.substring(0,3000)}\n</details>`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: msg
            });
