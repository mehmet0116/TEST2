name: DeepSeek Ultimate Workflow

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '**.md'
      - '**.py'
      - '**.js'
      - '**.ts'
      - '**.json'
      - '**.yml'
      - '**.yaml'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      task:
        description: 'Task to perform'
        required: false
        default: 'analyze'

env:
  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
  DEEPSEEK_BASE_URL: https://api.deepseek.com
  MAX_TOKENS: 32000
  REASONING_MODEL: deepseek-reasoner
  CHAT_MODEL: deepseek-chat

jobs:
  analyze-and-process:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests pyyaml gitpython

      - name: Detect task complexity and select model
        id: model_selection
        run: |
          import os
          import json
          
          # Task keywords for complexity detection
          complex_keywords = [
              'architecture', 'design', 'refactor', 'optimization', 'security',
              'performance', 'algorithm', 'analysis', 'debug', 'investigate',
              'complex', 'critical', 'enhance', 'improve', 'transform',
              'restructure', 'migration', 'integration', 'planning', 'strategy'
          ]
          
          simple_keywords = [
              'update', 'fix', 'typo', 'format', 'cleanup', 'lint',
              'simple', 'minor', 'patch', 'quick', 'document', 'comment',
              'add', 'remove', 'rename', 'style', 'test'
          ]
          
          # Get task from input or commit message
          task_input = "${{ github.event.inputs.task }}"
          commit_message = "${{ github.event.head_commit.message }}"
          
          task_text = (task_input or commit_message or "").lower()
          
          # Determine model based on keywords
          model = "deepseek-chat"
          complexity = "simple"
          
          for keyword in complex_keywords:
              if keyword in task_text:
                  model = "deepseek-reasoner"
                  complexity = "complex"
                  break
          
          # Check if any simple keyword exists (only if no complex keyword found)
          if complexity == "simple":
              for keyword in simple_keywords:
                  if keyword in task_text:
                      model = "deepseek-chat"
                      complexity = "simple"
                      break
          
          # Default to reasoning model for ambiguous tasks
          if not task_text or len(task_text.split()) < 3:
              model = "deepseek-reasoner"
              complexity = "complex"
          
          print(f"Selected Model: {model}")
          print(f"Task Complexity: {complexity}")
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"model={model}\n")
              f.write(f"complexity={complexity}\n")
        shell: python

      - name: Get changed files and deletions
        id: changes
        run: |
          import subprocess
          import json
          import os
          
          # Get the list of changed files
          result = subprocess.run(['git', 'diff', '--name-only', 'HEAD~1..HEAD'], 
                                capture_output=True, text=True)
          changed_files = result.stdout.strip().split('\n') if result.stdout.strip() else []
          
          # Get deleted files
          result = subprocess.run(['git', 'diff', '--name-only', '--diff-filter=D', 'HEAD~1..HEAD'], 
                                capture_output=True, text=True)
          deleted_files = result.stdout.strip().split('\n') if result.stdout.strip() else []
          
          # Get added files
          result = subprocess.run(['git', 'diff', '--name-only', '--diff-filter=A', 'HEAD~1..HEAD'], 
                                capture_output=True, text=True)
          added_files = result.stdout.strip().split('\n') if result.stdout.strip() else []
          
          # Get modified files
          result = subprocess.run(['git', 'diff', '--name-only', '--diff-filter=M', 'HEAD~1..HEAD'], 
                                capture_output=True, text=True)
          modified_files = result.stdout.strip().split('\n') if result.stdout.strip() else []
          
          changes_info = {
              'changed': [f for f in changed_files if f],
              'deleted': [f for f in deleted_files if f],
              'added': [f for f in added_files if f],
              'modified': [f for f in modified_files if f]
          }
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"changes_json={json.dumps(changes_info)}\n")
              f.write(f"changed_files={','.join(changes_info['changed'])}\n")
              f.write(f"deleted_files={','.join(changes_info['deleted'])}\n")
        shell: python

      - name: Call DeepSeek API with Reasoning-First Approach
        id: deepseek_analysis
        run: |
          import requests
          import json
          import os
          
          api_key = os.environ.get('DEEPSEEK_API_KEY')
          base_url = os.environ.get('DEEPSEEK_BASE_URL')
          model = "${{ steps.model_selection.outputs.model }}"
          max_tokens = int(os.environ.get('MAX_TOKENS', 32000))
          
          changes_json = """${{ steps.changes.outputs.changes_json }}"""
          changes = json.loads(changes_json) if changes_json and changes_json != '{}' else {}
          
          # Build comprehensive prompt with reasoning-first approach
          prompt = f"""You are an expert code reviewer and analyzer using a reasoning-first approach.

## Task Context:
- Repository: mehmet0116/TEST2
- Model Selected: {model}
- Task Complexity: ${{ steps.model_selection.outputs.complexity }}
- Timestamp: $(date -u)

## Changed Files Summary:
- Modified Files: {', '.join(changes.get('modified', [])) or 'None'}
- Added Files: {', '.join(changes.get('added', [])) or 'None'}
- Deleted Files: {', '.join(changes.get('deleted', [])) or 'None'}
- Total Changes: {len(changes.get('changed', []))}

## Instructions:
1. First, deeply reason about the changes and their implications
2. Analyze code quality, security, and performance
3. Identify potential issues and improvements
4. Provide actionable recommendations
5. For deleted files, explain impact and suggest alternatives if needed

Please provide a comprehensive analysis with your reasoning process clearly shown."""

          headers = {
              'Authorization': f'Bearer {api_key}',
              'Content-Type': 'application/json'
          }
          
          # Reasoning-first payload with increased max_tokens
          payload = {
              'model': model,
              'messages': [
                  {
                      'role': 'user',
                      'content': prompt
                  }
              ],
              'max_tokens': max_tokens,
              'temperature': 0.7 if model == 'deepseek-chat' else 0.5
          }
          
          # Add reasoning config for deepseek-reasoner
          if model == 'deepseek-reasoner':
              payload['thinking'] = {
                  'type': 'enabled',
                  'budget_tokens': 20000
              }
          
          try:
              response = requests.post(
                  f'{base_url}/chat/completions',
                  json=payload,
                  headers=headers,
                  timeout=120
              )
              response.raise_for_status()
              
              result = response.json()
              
              if model == 'deepseek-reasoner' and 'thinking' in result.get('choices', [{}])[0]:
                  thinking = result['choices'][0]['thinking']
                  content = result['choices'][0]['message']['content']
                  analysis = f"## Reasoning Process:\n{thinking}\n\n## Analysis Result:\n{content}"
              else:
                  analysis = result['choices'][0]['message']['content']
              
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  # Escape newlines for GitHub output
                  escaped_analysis = analysis.replace('%', '%25').replace('\n', '%0A').replace('\r', '%0D')
                  f.write(f"analysis<<EOF\n{analysis}\nEOF\n")
              
              print("âœ“ DeepSeek API call successful")
              print(f"âœ“ Model used: {model}")
              print(f"âœ“ Analysis completed")
              
          except requests.exceptions.RequestException as e:
              print(f"âœ— API Error: {str(e)}")
              raise
        shell: python

      - name: Create or update analysis document
        id: create_analysis
        run: |
          import os
          import json
          from datetime import datetime
          
          analysis = """${{ steps.deepseek_analysis.outputs.analysis }}"""
          
          analysis_content = f"""# Code Analysis Report
## Generated: {datetime.utcnow().isoformat()}Z
## Model: ${{ steps.model_selection.outputs.model }}
## Complexity: ${{ steps.model_selection.outputs.complexity }}

{analysis}

---
*This analysis was generated by DeepSeek Ultimate Workflow*
"""
          
          # Write to file
          os.makedirs('.github/analysis', exist_ok=True)
          filename = f".github/analysis/analysis_{datetime.utcnow().strftime('%Y%m%d_%H%M%S')}.md"
          
          with open(filename, 'w') as f:
              f.write(analysis_content)
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"analysis_file={filename}\n")
          
          print(f"âœ“ Analysis document created: {filename}")
        shell: python

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Commit and push analysis
        id: push_changes
        run: |
          import subprocess
          import os
          
          analysis_file = "${{ steps.create_analysis.outputs.analysis_file }}"
          
          # Check if file exists
          if os.path.exists(analysis_file):
              # Add the analysis file
              subprocess.run(['git', 'add', analysis_file], check=True)
              
              # Check if there are changes to commit
              result = subprocess.run(['git', 'diff', '--cached', '--quiet'], capture_output=True)
              
              if result.returncode != 0:
                  # Create commit
                  commit_msg = f"chore: Add DeepSeek analysis report from ${{ steps.model_selection.outputs.model }}"
                  subprocess.run(['git', 'commit', '-m', commit_msg], check=True)
                  
                  # Push to current branch
                  current_branch = subprocess.run(['git', 'rev-parse', '--abbrev-ref', 'HEAD'], 
                                                capture_output=True, text=True).stdout.strip()
                  subprocess.run(['git', 'push', 'origin', current_branch], check=True)
                  
                  print(f"âœ“ Changes pushed to {current_branch}")
                  
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"pushed=true\n")
                      f.write(f"branch={current_branch}\n")
              else:
                  print("No changes to commit")
                  with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                      f.write(f"pushed=false\n")
          else:
              print(f"Analysis file not found: {analysis_file}")
              with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                  f.write(f"pushed=false\n")
        shell: python

      - name: Handle file deletions
        if: steps.changes.outputs.deleted_files != ''
        run: |
          import os
          
          deleted_files = "${{ steps.changes.outputs.deleted_files }}".split(',')
          deleted_files = [f.strip() for f in deleted_files if f.strip()]
          
          if deleted_files:
              print("ðŸ“‹ Deleted Files Summary:")
              for idx, file in enumerate(deleted_files, 1):
                  print(f"  {idx}. {file}")
              
              # Create deletion log
              os.makedirs('.github/logs', exist_ok=True)
              with open('.github/logs/deletions.log', 'a') as f:
                  for file in deleted_files:
                      f.write(f"[DELETED] {file}\n")
              
              print(f"\nâœ“ Deletion log updated")
        shell: python

      - name: Summary
        if: always()
        run: |
          echo "## DeepSeek Ultimate Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Model Selected:** ${{ steps.model_selection.outputs.model }}" >> $GITHUB_STEP_SUMMARY
          echo "**Task Complexity:** ${{ steps.model_selection.outputs.complexity }}" >> $GITHUB_STEP_SUMMARY
          echo "**Max Tokens:** ${{ env.MAX_TOKENS }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Files Changed:** $(echo '${{ steps.changes.outputs.changed_files }}' | wc -w)" >> $GITHUB_STEP_SUMMARY
          echo "**Files Deleted:** $(echo '${{ steps.changes.outputs.deleted_files }}' | wc -w)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Analysis File:** ${{ steps.create_analysis.outputs.analysis_file }}" >> $GITHUB_STEP_SUMMARY
          echo "**Changes Pushed:** ${{ steps.push_changes.outputs.pushed }}" >> $GITHUB_STEP_SUMMARY
