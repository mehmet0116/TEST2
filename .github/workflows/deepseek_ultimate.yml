name: DEEPSEEK ULTIMATE PRO v10.0
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      task:
        description: 'GÃ¶rev TanÄ±mÄ±'
        required: true
        default: 'Projeyi analiz et, geliÅŸtir ve derle'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  deepseek_heavy_agent:
    # DÃœZELTME 1: Standart runner kullanÄ±ldÄ± (16core Ã¶zel planda Ã§alÄ±ÅŸÄ±r)
    runs-on: ubuntu-latest
    timeout-minutes: 360 # 6 Saat (BÃ¼yÃ¼k derlemeler iÃ§in)
    if: github.actor != 'github-actions[bot]'
    
    steps:
      # ========================================================
      # ADIM 1: SAHA HAZIRLIÄI
      # ========================================================
      - name: ğŸš€ PROJE KAYNAKLARINI Ã‡EK
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref || github.ref }}

      # ========================================================
      # ADIM 2: DERÄ°NLEMESÄ°NE ORTAM ANALÄ°ZÄ° (BASH SCRIPT)
      # ========================================================
      - name: ğŸ” PROFESYONEL PROJE ANALÄ°ZÃ–RÃœ
        id: analyzer
        run: |
          echo "================================================"
          echo "ğŸ•µï¸ DEEPSEEK ANALÄ°Z MOTORU BAÅLATILIYOR..."
          echo "================================================"
          
          # DeÄŸiÅŸkenleri baÅŸlat
          IS_ANDROID="false"
          IS_NODE="false"
          IS_PYTHON="false"
          
          # 1. ANDROID TESPÄ°TÄ°
          if [ -f "build.gradle" ] || [ -f "build.gradle.kts" ] || [ -f "app/build.gradle" ]; then
            echo "âœ… TESPÄ°T: Android Projesi"
            IS_ANDROID="true"
            echo "PROJECT_TYPE=android" >> $GITHUB_ENV
            
            # Gradle Wrapper KontrolÃ¼
            if [ ! -f "gradlew" ]; then
              echo "âš ï¸ UYARI: gradlew bulunamadÄ±, oluÅŸturulacak."
              echo "FIX_GRADLE=true" >> $GITHUB_ENV
            else
              chmod +x gradlew
              echo "âœ… gradlew yetkilendirildi."
            fi
          fi
          
          # 2. NODE.JS TESPÄ°TÄ°
          if [ -f "package.json" ]; then
            echo "âœ… TESPÄ°T: Node.js Projesi"
            IS_NODE="true"
            echo "PROJECT_TYPE=nodejs" >> $GITHUB_ENV
          fi
          
          # 3. PYTHON TESPÄ°TÄ°
          if [ -f "requirements.txt" ] || [ -f "pyproject.toml" ]; then
            echo "âœ… TESPÄ°T: Python Projesi"
            IS_PYTHON="true"
            echo "PROJECT_TYPE=python" >> $GITHUB_ENV
          fi
          
          # Dosya Ä°statistikleri
          FILE_COUNT=$(find . -type f -not -path '*/.*' | wc -l)
          echo "ğŸ“„ Toplam Dosya: $FILE_COUNT"
          echo "TOTAL_FILES=$FILE_COUNT" >> $GITHUB_ENV

      # ========================================================
      # ADIM 3: AÄIR SÄ°STEM KURULUMLARI (SYSTEM SETUP)
      # ========================================================
      - name: ğŸ› ï¸ GELÄ°ÅTÄ°RME ORTAMI KURULUMU
        id: setup_env
        run: |
          echo "ğŸ”§ Gerekli araÃ§lar yÃ¼kleniyor..."
          sudo apt-get update -qq
          sudo apt-get install -y curl wget unzip tree jq build-essential
          
          # JAVA KURULUMU (Android iÃ§in her zaman hazÄ±r olsun)
          echo "â˜• Java 17 (Temurin) Kuruluyor..."
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
          
      - name: ğŸ Python Kurulumu
        if: env.PROJECT_TYPE == 'python'
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
          
      - name: ğŸŸ¢ Node.js Kurulumu
        if: env.PROJECT_TYPE == 'nodejs'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # ========================================================
      # ADIM 4: DEEPSEEK BEYNÄ° (AI ENGINE) - SENÄ°N Ä°STEDÄ°ÄÄ°N GÄ°BÄ°
      # ========================================================
      - name: ğŸ§  DEEPSEEK ULTIMATE ENGINE (Reasoning Mode)
        id: deepseek_engine
        uses: actions/github-script@v7
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          PROJECT_TYPE: ${{ env.PROJECT_TYPE }}
          USER_MSG: ${{ github.event.inputs.task || github.event.comment.body || github.event.issue.body }}
        with:
          timeout-minutes: 20
          script: |
            // --- MODÃœLLER ---
            const fs = require('fs');
            const path = require('path');
            
            console.log("ğŸš€ [DEEPSEEK MOTORU] Tam GÃ¼Ã§le Ã‡alÄ±ÅŸÄ±yor...");
            
            const apiKey = process.env.DEEPSEEK_API_KEY;
            if (!apiKey) throw new Error("KRÄ°TÄ°K HATA: API AnahtarÄ± Secrets iÃ§inde yok!");

            // --- 1. DOSYA OKUMA VE BAÄLAM (CONTEXT) ---
            const criticalFiles = [
              'build.gradle', 'app/build.gradle', 'settings.gradle', 'AndroidManifest.xml', // Android
              'package.json', 'package-lock.json', 'next.config.js', // Node
              'requirements.txt', 'main.py', 'app.py', 'setup.py', // Python
              'README.md', '.gitignore', 'docker-compose.yml'
            ];
            
            let contextData = "### ğŸ“‚ MEVCUT PROJE YAPISI VE Ä°Ã‡ERÄ°ÄÄ°:\n\n";
            let filesReadCount = 0;
            
            function readFilesRecursively(dir) {
                if (!fs.existsSync(dir)) return;
                const entries = fs.readdirSync(dir, { withFileTypes: true });
                
                for (const entry of entries) {
                    const fullPath = path.join(dir, entry.name);
                    
                    // YasaklÄ± klasÃ¶rleri atla
                    if (entry.isDirectory()) {
                        if (!['.git', 'node_modules', 'build', '.gradle', 'venv', '__pycache__'].includes(entry.name)) {
                            readFilesRecursively(fullPath);
                        }
                    } else {
                        // Dosya okuma kriterleri
                        if (criticalFiles.includes(entry.name) || 
                            fullPath.endsWith('.xml') || 
                            fullPath.endsWith('.java') || 
                            fullPath.endsWith('.kt') || 
                            fullPath.endsWith('.js') || 
                            fullPath.endsWith('.py')) {
                            
                            try {
                                const stat = fs.statSync(fullPath);
                                if (stat.size < 15000) { // 15KB altÄ± dosyalarÄ± oku
                                    const content = fs.readFileSync(fullPath, 'utf8');
                                    contextData += `---START_FILE: ${fullPath}---\n${content}\n---END_FILE---\n\n`;
                                    filesReadCount++;
                                }
                            } catch(e) { console.log(`Okuma hatasÄ±: ${fullPath}`); }
                        }
                    }
                }
            }
            readFilesRecursively('.');
            console.log(`âœ… ${filesReadCount} adet dosya okundu ve hafÄ±zaya alÄ±ndÄ±.`);

            // --- 2. SÄ°STEM TALÄ°MATI (PROMPT) ---
            const systemPrompt = `
            Sen DeepSeek Ultimate Pro, dÃ¼nyanÄ±n en geliÅŸmiÅŸ otonom yazÄ±lÄ±m mÃ¼hendisisin.
            
            GÃ–REVÄ°N:
            1. KullanÄ±cÄ±nÄ±n isteÄŸini analiz et.
            2. Mevcut proje yapÄ±sÄ±nÄ± (CONTEXT) incele.
            3. Hata varsa dÃ¼zelt, yoksa istenen Ã¶zelliÄŸi EKSÄ°KSÄ°Z kodla.
            4. **"Reasoning" (DÃ¼ÅŸÃ¼nme)** yeteneÄŸini kullan. Ã–nce planla, sonra uygula.
            
            KURALLAR:
            - YarÄ±m kod bÄ±rakma.
            - "BurayÄ± sen doldur" deme.
            - EÄŸer Android projesi ise: 'build.gradle' sÃ¼rÃ¼mlerinin uyumlu olduÄŸundan emin ol.
            - KodlarÄ±n DERLENEBÄ°LÄ°R (Compilable) olmasÄ± zorunludur.
            
            Ã‡IKTI FORMATI (KESÄ°N):
            Dosya oluÅŸturmak iÃ§in:
            ---START_FILE: dosya_yolu---
            [Kod Ä°Ã§eriÄŸi]
            ---END_FILE---
            
            Dosya silmek iÃ§in:
            ---DELETE_FILE: dosya_yolu---
            ---END_DELETE---
            `.trim();

            // --- 3. API Ã‡AÄRISI (REASONER MODELÄ°) ---
            // DÃœZELTME: Senin istediÄŸin 'dÃ¼ÅŸÃ¼nen' modeli kullanÄ±yoruz.
            console.log("ğŸ§  DÃ¼ÅŸÃ¼nme Modeli (DeepSeek-Reasoner) tetikleniyor...");
            
            try {
                const response = await fetch("https://api.deepseek.com/chat/completions", {
                  method: "POST",
                  headers: {
                    "Authorization": `Bearer ${apiKey}`, 
                    "Content-Type": "application/json"
                  },
                  body: JSON.stringify({
                    model: "deepseek-reasoner", // En gÃ¼Ã§lÃ¼ model
                    messages: [
                      { role: "system", content: systemPrompt },
                      { role: "user", content: `KULLANICI Ä°STEÄÄ°: ${process.env.USER_MSG}\n\n${contextData}` }
                    ],
                    stream: false,
                    max_tokens: 8000
                  })
                });

                if (!response.ok) {
                    const txt = await response.text();
                    throw new Error(`API HatasÄ±: ${txt}`);
                }

                const data = await response.json();
                const aiReply = data.choices[0].message.content;
                const thinking = data.choices[0].message.reasoning_content || "DÃ¼ÅŸÃ¼nce verisi yok.";
                
                console.log("âš¡ Cevap alÄ±ndÄ±.");
                
                // Ã‡Ä±ktÄ±larÄ± dÄ±ÅŸarÄ± aktar (Markdown sorunu olmasÄ±n diye encode ediyoruz)
                core.setOutput('thinking', Buffer.from(thinking).toString('base64'));
                
                // --- 4. DOSYA YAZMA (SCRIPT Ä°Ã‡Ä°NDE) ---
                const startRegex = /---START_FILE:\s*(.*?)---\n([\s\S]*?)\n---END_FILE---/g;
                const delRegex = /---DELETE_FILE:\s*(.*?)---\n---END_DELETE---/g;
                
                let match;
                let filesCreated = [];
                
                // Dosya OluÅŸturma
                while ((match = startRegex.exec(aiReply)) !== null) {
                    const filePath = match[1].trim();
                    const fileContent = match[2].trim();
                    
                    // KlasÃ¶r yoksa aÃ§
                    const dir = path.dirname(filePath);
                    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                    
                    fs.writeFileSync(filePath, fileContent);
                    console.log(`ğŸ“ YazÄ±ldÄ±: ${filePath}`);
                    filesCreated.push(filePath);
                }
                
                // Dosya Silme
                while ((match = delRegex.exec(aiReply)) !== null) {
                    const filePath = match[1].trim();
                    if (fs.existsSync(filePath)) {
                        fs.unlinkSync(filePath);
                        console.log(`ğŸ—‘ï¸ Silindi: ${filePath}`);
                    }
                }
                
                core.setOutput('files', filesCreated.join(', '));
                core.setOutput('reply', aiReply);

            } catch (err) {
                console.error("HATA:", err);
                core.setFailed(err.message);
            }

      # ========================================================
      # ADIM 5: KODLARI KAYDET (COMMIT)
      # ========================================================
      - name: ğŸ’¾ KODLARI DEPOYA GÃ–NDER
        run: |
          git config --global user.name "DeepSeek AI"
          git config --global user.email "ai@deepseek.com"
          git add .
          git commit -m "ğŸ¤– DeepSeek ULTIMATE: Kod GÃ¼ncellemesi ve DÃ¼zenleme" || echo "DeÄŸiÅŸiklik yok."
          git push

      # ========================================================
      # ADIM 6: DERLEME VE Ä°NÅA (COMPILATION & BUILD)
      # ========================================================
      - name: ğŸ—ï¸ OTOMATÄ°K DERLEME MOTORU
        id: auto_build
        run: |
          echo "================================================"
          echo "ğŸ”¨ DERLEME SÃœRECÄ° BAÅLIYOR..."
          echo "================================================"
          
          # --- ANDROID BUILD ---
          if [ "${{ env.PROJECT_TYPE }}" == "android" ]; then
            echo "ğŸ“± Android Build AlgÄ±landÄ±."
            
            # Wrapper yoksa oluÅŸtur
            if [ ! -f "gradlew" ]; then
                gradle wrapper
            fi
            chmod +x gradlew
            
            echo "1ï¸âƒ£ Temizlik yapÄ±lÄ±yor..."
            ./gradlew clean
            
            echo "2ï¸âƒ£ APK Derleniyor (Debug)..."
            if ./gradlew assembleDebug --stacktrace; then
                echo "âœ… BUILD BAÅARILI!"
                echo "BUILD_RESULT=SUCCESS" >> $GITHUB_ENV
            else
                echo "âŒ BUILD HATASI!"
                echo "BUILD_RESULT=FAILURE" >> $GITHUB_ENV
                exit 1 # Hata varsa durma, raporla ama fail et
            fi
          fi
          
          # --- NODE.JS BUILD ---
          if [ "${{ env.PROJECT_TYPE }}" == "nodejs" ]; then
            echo "ğŸŸ¢ Node.js Build AlgÄ±landÄ±."
            npm install
            if npm run build --if-present; then
                echo "âœ… BUILD BAÅARILI!"
                echo "BUILD_RESULT=SUCCESS" >> $GITHUB_ENV
            else
                echo "âŒ BUILD HATASI!"
                echo "BUILD_RESULT=FAILURE" >> $GITHUB_ENV
            fi
          fi
        continue-on-error: true # Derleme hatasÄ± olsa bile raporu yaz

      # ========================================================
      # ADIM 7: SONUÃ‡LARI YÃœKLE (ARTIFACTS)
      # ========================================================
      - name: ğŸ“¤ APK DOSYASINI YÃœKLE
        if: env.PROJECT_TYPE == 'android' && env.BUILD_RESULT == 'SUCCESS'
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/*.apk

      # ========================================================
      # ADIM 8: DETAYLI RAPORLAMA
      # ========================================================
      - name: ğŸ“Š SONUÃ‡ RAPORU OLUÅTUR
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = process.env.BUILD_RESULT || 'ATLANDI';
            const files = `${{ steps.deepseek_engine.outputs.files }}`;
            const reply = `${{ steps.deepseek_engine.outputs.reply }}`;
            
            // DÃ¼ÅŸÃ¼nce verisini Ã§Ã¶z
            let thinking = "Gizli";
            try {
                thinking = Buffer.from(`${{ steps.deepseek_engine.outputs.thinking }}`, 'base64').toString('utf-8');
            } catch(e) {}

            let body = `### ğŸ§¬ DEEPSEEK ULTIMATE PRO v10.0 RAPORU\n\n`;
            
            body += `<details><summary>ğŸ§  <b>Modelin DÃ¼ÅŸÃ¼nce SÃ¼reci (TÄ±kla)</b></summary>\n\n\`\`\`text\n${thinking.substring(0, 5000)}...\n\`\`\`\n</details>\n\n`;
            
            body += `#### ğŸ› ï¸ YapÄ±lan Ä°ÅŸlemler:\n`;
            body += `- **Ä°ÅŸlenen Dosyalar:** ${files}\n`;
            body += `- **Derleme Durumu:** ${buildStatus == 'SUCCESS' ? 'âœ… BAÅARILI' : 'âŒ BAÅARISIZ'}\n\n`;
            
            body += `#### ğŸ’¬ AI MesajÄ±:\n${reply.substring(0, 2000)}...\n\n`;
            
            if (buildStatus == 'SUCCESS' && process.env.PROJECT_TYPE == 'android') {
                body += `ğŸ‰ **APK DosyasÄ± HazÄ±r!** YukarÄ±daki "Artifacts" kÄ±smÄ±ndan indirebilirsiniz.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
