name: DEEPSEEK OMNI v20.1 (FIXED)
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      task:
        description: 'G√∂rev'
        required: true
        default: 'Projeyi analiz et ve geli≈ütir'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  architect_planning:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    outputs:
      env_config: ${{ steps.plan.outputs.env_config }}
      user_request: ${{ steps.plan.outputs.user_request }}
    
    steps:
      - name: üöÄ Projeyi √áek
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üß† Mimar Analizi
        id: plan
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_MSG: ${{ github.event.inputs.task || github.event.comment.body || github.event.issue.body }}
        with:
          script: |
            const fs = require('fs');
            
            // HATA BURADAYDI: 'context' yerine 'projectContext' kullandƒ±m.
            let projectContext = "### MEVCUT DOSYA Sƒ∞STEMƒ∞:\n";
            
            function scanFiles(dir, depth = 0) {
              if (depth > 3) return;
              if (!fs.existsSync(dir)) return;
              
              const files = fs.readdirSync(dir, { withFileTypes: true });
              for (const file of files) {
                if (file.name.startsWith('.') || file.name === 'node_modules' || file.name === 'build') continue;
                
                if (file.isDirectory()) {
                  projectContext += `üìÅ [KLAS√ñR] ${file.name}\n`;
                  scanFiles(`${dir}/${file.name}`, depth + 1);
                } else {
                  if (file.name.match(/(json|yaml|yml|gradle|xml|py|js|ts|cpp|c|h|java|kt|st|plc|txt|md)$/i)) {
                    try {
                        const content = fs.readFileSync(`${dir}/${file.name}`, 'utf8');
                        if (content.length < 5000) {
                            projectContext += `>>> DOSYA: ${dir}/${file.name}\n${content}\n---\n`;
                        }
                    } catch(e) {}
                  }
                }
              }
            }
            scanFiles('.');
            
            const prompt = `
            Sen DeepSeek OMNI. Projeyi analiz et ve GEREKLƒ∞ ORTAMI JSON olarak belirle.
            KULLANICI: ${process.env.USER_MSG}
            MEVCUT DURUM: ${projectContext}
            
            SADECE JSON FORMATINDA CEVAP VER:
            {
              "language": "java|python|node|cpp|plc",
              "java_version": "17",
              "python_version": "3.10",
              "node_version": "20",
              "install_command": "komut",
              "build_command": "komut",
              "system_packages": ["paket1"]
            }
            `;
            
            const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${process.env.API_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{ role: "system", content: "JSON Config Bot" }, { role: "user", content: prompt }],
                    stream: false
                })
            });
            
            const data = await response.json();
            let configJson = data.choices[0].message.content.replace(/```json/g, '').replace(/```/g, '').trim();
            console.log("CONFIG:", configJson);
            
            core.setOutput('env_config', Buffer.from(configJson).toString('base64'));
            core.setOutput('user_request', process.env.USER_MSG);

  development_cycle:
    needs: architect_planning
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: github.actor != 'github-actions[bot]'
    
    steps:
      - uses: actions/checkout@v4
      
      - name: ‚öôÔ∏è Ortamƒ± Kur
        run: |
          CONFIG=$(echo "${{ needs.architect_planning.outputs.env_config }}" | base64 --decode)
          echo "CONFIG_JSON=$CONFIG" >> $GITHUB_ENV
          
          # JQ y√ºkl√º gelir ama garanti olsun
          sudo apt-get install -y jq
          
          JAVA_VER=$(echo "$CONFIG" | jq -r '.java_version // "17"')
          PY_VER=$(echo "$CONFIG" | jq -r '.python_version // "3.10"')
          NODE_VER=$(echo "$CONFIG" | jq -r '.node_version // "20"')
          SYS_PKGS=$(echo "$CONFIG" | jq -r '.system_packages[]?' | tr '\n' ' ')
          
          if [ ! -z "$SYS_PKGS" ]; then
            sudo apt-get update && sudo apt-get install -y $SYS_PKGS
          fi
          
          echo "JAVA_VER=$JAVA_VER" >> $GITHUB_ENV
          echo "PY_VER=$PY_VER" >> $GITHUB_ENV
          echo "NODE_VER=$NODE_VER" >> $GITHUB_ENV

      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VER }}
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}
          
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VER }}

      - name: üîÑ Kodlama D√∂ng√ºs√º
        uses: actions/github-script@v7
        timeout-minutes: 60
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          CONFIG: ${{ env.CONFIG_JSON }}
          USER_MSG: ${{ needs.architect_planning.outputs.user_request }}
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            const path = require('path');
            
            const apiKey = process.env.API_KEY;
            const config = JSON.parse(process.env.CONFIG);
            const userMsg = process.env.USER_MSG;
            
            async function askAI(msgs) {
                const res = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({ model: "deepseek-reasoner", messages: msgs, max_tokens: 8000 })
                });
                const d = await res.json();
                return d.choices[0].message;
            }

            // Dosyalarƒ± Yazma Fonksiyonu
            function writeFiles(txt) {
                const regex = /---FILE:\s*(.*?)---\n([\s\S]*?)---END---/g;
                let m;
                let count = 0;
                while((m = regex.exec(txt)) !== null) {
                    const fPath = m[1].trim();
                    const dir = path.dirname(fPath);
                    if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                    fs.writeFileSync(fPath, m[2].trim());
                    console.log(`Yazƒ±ldƒ±: ${fPath}`);
                    count++;
                }
                return count;
            }

            let msgs = [
                { role: "system", content: `Sen DeepSeek OMNI.
                  PROJE: ${JSON.stringify(config)}
                  KURALLAR:
                  1. Tam √ßalƒ±≈üan kod yaz.
                  2. FORMAT: ---FILE:yol/ad.uzanti--- icerik ---END---
                  3. "Burayƒ± sen tamamla" deme.` 
                },
                { role: "user", content: `G√ñREV: ${userMsg}` }
            ];

            console.log("TUR 1: Kodlama...");
            let aiRes = await askAI(msgs);
            msgs.push(aiRes);
            writeFiles(aiRes.content);

            console.log("TUR 2: Test...");
            let buildCmd = config.build_command;
            if(buildCmd && buildCmd !== "null") {
                try {
                    execSync(buildCmd, { stdio: 'inherit' });
                    console.log("‚úÖ BA≈ûARILI!");
                } catch(e) {
                    console.log("‚ùå HATA ALINDI. D√ºzeltiliyor...");
                    msgs.push({ role: "user", content: `HATA: ${e.message}. D√ºzelt.` });
                    let fix = await askAI(msgs);
                    writeFiles(fix.content);
                }
            }

      - name: üíæ Kaydet
        run: |
          git config --global user.name "DeepSeek OMNI"
          git config --global user.email "bot@deepseek.com"
          git add .
          git commit -m "OMNI Geli≈ütirmesi" || echo "Yok"
          git push
      
      - name: üì§ Sonu√ßlar
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: project-build
          path: |
            **/*.apk
            **/*.exe
            build/
