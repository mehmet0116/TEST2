name: DEEPSEEK OMNI v20.0 (UNIVERSAL GOD MODE)
on:
  issues:
    types: [opened, edited]
  issue_comment:
    types: [created, edited]
  workflow_dispatch:
    inputs:
      task:
        description: 'GÃ¶rev TanÄ±mÄ±'
        required: true
        default: 'Projeyi analiz et, en uygun ortamÄ± kur ve geliÅŸtir'

permissions:
  contents: write
  issues: write
  pull-requests: write
  actions: write

jobs:
  # ==============================================================================
  # 1. FAZ: BEYÄ°N FIRTINASI VE ORTAM ANALÄ°ZÄ° (Ajan Ã¶nce ne yapacaÄŸÄ±nÄ± planlar)
  # ==============================================================================
  architect_planning:
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    outputs:
      env_config: ${{ steps.plan.outputs.env_config }}
      user_request: ${{ steps.plan.outputs.user_request }}
    
    steps:
      - name: ğŸš€ Projeyi Masaya YatÄ±r (Checkout)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ§  Mimar Analizi (Architect)
        id: plan
        uses: actions/github-script@v7
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          USER_MSG: ${{ github.event.inputs.task || github.event.comment.body || github.event.issue.body }}
        with:
          script: |
            const fs = require('fs');
            
            console.log("ğŸš€ [OMNI] Mimar Modu Devrede. Proje inceleniyor...");
            
            // 1. DÄ°NAMÄ°K DOSYA TARAMASI (Dosya uzantÄ±sÄ±na bakmaksÄ±zÄ±n)
            // Sadece kod dosyalarÄ±nÄ± deÄŸil, config dosyalarÄ±nÄ± da okur.
            let context = "### MEVCUT DOSYA SÄ°STEMÄ°:\n";
            
            function scanFiles(dir, depth = 0) {
              if (depth > 3) return; // Ã‡ok derine inme
              if (!fs.existsSync(dir)) return;
              
              const files = fs.readdirSync(dir, { withFileTypes: true });
              for (const file of files) {
                if (file.name.startsWith('.') || file.name === 'node_modules' || file.name === 'build') continue;
                
                if (file.isDirectory()) {
                  context += `ğŸ“ [KLASÃ–R] ${file.name}\n`;
                  scanFiles(`${dir}/${file.name}`, depth + 1);
                } else {
                  // Kritik dosyalarÄ± oku
                  if (file.name.match(/(json|yaml|yml|gradle|xml|py|js|ts|cpp|c|h|java|kt|st|plc|txt|md)$/i)) {
                    try {
                        const content = fs.readFileSync(`${dir}/${file.name}`, 'utf8');
                        if (content.length < 5000) {
                            context += `>>> DOSYA: ${dir}/${file.name}\n${content}\n---\n`;
                        }
                    } catch(e) {}
                  }
                }
              }
            }
            scanFiles('.');
            
            // 2. ORTAM BELÄ°RLEME PROMPTU
            // DeepSeek'e soruyoruz: "Bu projeyi Ã§alÄ±ÅŸtÄ±rmak iÃ§in hangi bilgisayara ihtiyacÄ±m var?"
            const prompt = `
            Sen DeepSeek OMNI, evrensel bir yazÄ±lÄ±m mimarÄ±sÄ±n.
            
            GÃ–REVÄ°N:
            AÅŸaÄŸÄ±daki proje yapÄ±sÄ±nÄ± ve kullanÄ±cÄ± isteÄŸini incele.
            Bu projenin Ã§alÄ±ÅŸmasÄ± iÃ§in gereken ORTAMI (Environment) JSON formatÄ±nda belirle.
            
            KULLANICI Ä°STEÄÄ°: ${process.env.USER_MSG}
            
            MEVCUT DOSYALAR:
            ${context}
            
            DÄ°KKAT:
            - EÄŸer proje eski bir Java projesiyse, Java 8 veya 11 seÃ§. Yeni ise 17 veya 21.
            - PLC projesi ise ona uygun notlar dÃ¼ÅŸ.
            - Robotik (C++/Python) ise gerekli kÃ¼tÃ¼phaneleri yaz.
            
            SADECE ÅU JSON FORMATINDA CEVAP VER (BaÅŸka yazÄ± yazma):
            {
              "language": "java" | "python" | "node" | "cpp" | "plc" | "multi",
              "java_version": "17", (EÄŸer Java ise)
              "python_version": "3.10", (EÄŸer Python ise)
              "node_version": "20", (EÄŸer Node ise)
              "install_command": "npm install" veya "pip install -r requirements.txt",
              "build_command": "./gradlew assembleDebug" veya "python main.py",
              "system_packages": ["cmake", "gcc"] (Linux paketleri)
            }
            `;
            
            // API Ã‡AÄRISI
            const response = await fetch("https://api.deepseek.com/chat/completions", {
                method: "POST",
                headers: { "Authorization": `Bearer ${process.env.API_KEY}`, "Content-Type": "application/json" },
                body: JSON.stringify({
                    model: "deepseek-chat", // HÄ±zlÄ± analiz iÃ§in chat modeli
                    messages: [{ role: "system", content: "Sen bir JSON yapÄ±landÄ±rma botusun." }, { role: "user", content: prompt }],
                    stream: false
                })
            });
            
            const data = await response.json();
            let configJson = data.choices[0].message.content.trim();
            // Markdown temizliÄŸi
            configJson = configJson.replace(/```json/g, '').replace(/```/g, '').trim();
            
            console.log("ğŸ”§ ALGILANAN ORTAM:", configJson);
            
            // Ã‡Ä±ktÄ±larÄ± aktar
            core.setOutput('env_config', Buffer.from(configJson).toString('base64'));
            core.setOutput('user_request', process.env.USER_MSG);

  # ==============================================================================
  # 2. FAZ: GELÄ°ÅTÄ°RME VE Ä°YÄ°LEÅTÄ°RME (Development & Self-Healing)
  # ==============================================================================
  development_cycle:
    needs: architect_planning
    runs-on: ubuntu-latest
    timeout-minutes: 360
    if: github.actor != 'github-actions[bot]'
    
    steps:
      - name: ğŸš€ Ã‡alÄ±ÅŸma AlanÄ±nÄ± HazÄ±rla
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Dinamik OrtamÄ± Kur
        id: setup
        run: |
          # 1. Config'i Ã‡Ã¶z
          CONFIG=$(echo "${{ needs.architect_planning.outputs.env_config }}" | base64 --decode)
          echo "CONFIG_JSON=$CONFIG" >> $GITHUB_ENV
          
          # JSON Parsing (jq ile)
          LANG=$(echo "$CONFIG" | jq -r '.language')
          JAVA_VER=$(echo "$CONFIG" | jq -r '.java_version // "17"')
          PY_VER=$(echo "$CONFIG" | jq -r '.python_version // "3.10"')
          NODE_VER=$(echo "$CONFIG" | jq -r '.node_version // "20"')
          SYS_PKGS=$(echo "$CONFIG" | jq -r '.system_packages[]?' | tr '\n' ' ')
          
          echo "ğŸŒ AlgÄ±lanan Dil: $LANG"
          
          # Sistem Paketlerini Kur (Robotik/C++ iÃ§in Ã¶nemli)
          if [ ! -z "$SYS_PKGS" ]; then
            echo "ğŸ”§ Sistem Paketleri Kuruluyor: $SYS_PKGS"
            sudo apt-get update && sudo apt-get install -y $SYS_PKGS
          fi
          
          # Dillerin Kurulumu (Hepsini hazÄ±r et, ne olur ne olmaz)
          echo "JAVA_VER=$JAVA_VER" >> $GITHUB_ENV
          echo "PY_VER=$PY_VER" >> $GITHUB_ENV
          echo "NODE_VER=$NODE_VER" >> $GITHUB_ENV

      # DÄ°NAMÄ°K ORTAMLAR (Senin istediÄŸin versiyon neyse onu kurar)
      - uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VER }}
      
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VER }}
          
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VER }}

      # --------------------------------------------------------------------------------
      # ğŸ§  ANA BEYÄ°N: KOD YAZMA + HATA DÃœZELTME DÃ–NGÃœSÃœ
      # BurasÄ± "Copilot gibi" Ã§alÄ±ÅŸÄ±r. Kodu yazar, dener, olmazsa dÃ¼zeltir.
      # --------------------------------------------------------------------------------
      - name: ğŸ”„ DeepSeek OMNI DÃ¶ngÃ¼sÃ¼ (Write -> Test -> Fix)
        uses: actions/github-script@v7
        timeout-minutes: 60
        env:
          API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          CONFIG: ${{ env.CONFIG_JSON }}
          USER_MSG: ${{ needs.architect_planning.outputs.user_request }}
        with:
          script: |
            const fs = require('fs');
            const { execSync } = require('child_process');
            
            const apiKey = process.env.API_KEY;
            const config = JSON.parse(process.env.CONFIG);
            const userMsg = process.env.USER_MSG;
            
            // API Fonksiyonu
            async function askDeepSeek(messages) {
                const response = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: { "Authorization": `Bearer ${apiKey}`, "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "deepseek-reasoner", // En zeki model
                        messages: messages,
                        stream: false,
                        max_tokens: 8000
                    })
                });
                const data = await response.json();
                return data.choices[0].message;
            }

            // Dosya Okuma Fonksiyonu
            function getFileContext() {
                let ctx = "";
                // Basit tarama
                try {
                    const files = fs.readdirSync('.').filter(f => !f.startsWith('.'));
                    for(const f of files) {
                        if(fs.statSync(f).isFile()) ctx += `FILE: ${f}\n${fs.readFileSync(f, 'utf8').substring(0,2000)}\n\n`;
                    }
                } catch(e) {}
                return ctx;
            }

            // --- 1. TUR: KODLAMA ---
            console.log("ğŸ¯ [TUR 1] Kodlama BaÅŸlÄ±yor...");
            let conversation = [
                { role: "system", content: `Sen DeepSeek OMNI. KullanÄ±cÄ±nÄ±n isteÄŸini yerine getir.
                  PROJE AYARLARI: ${JSON.stringify(config)}
                  KURALLAR:
                  1. Tam Ã§alÄ±ÅŸan kod yaz.
                  2. Dosya formatÄ±: ---FILE:isim--- icerik ---END---
                  3. PLC/Robotik ise mantÄ±ÄŸÄ± ona gÃ¶re kur.` 
                },
                { role: "user", content: `Ä°STEK: ${userMsg}\n\nMEVCUT DOSYALAR:\n${getFileContext()}` }
            ];

            let aiMsg = await askDeepSeek(conversation);
            let aiContent = aiMsg.content;
            conversation.push(aiMsg); // HafÄ±zaya at

            // DosyalarÄ± Yaz
            function writeFiles(text) {
                const regex = /---FILE:\s*(.*?)---\n([\s\S]*?)---END---/g;
                let m;
                while((m = regex.exec(text)) !== null) {
                    fs.writeFileSync(m[1].trim(), m[2].trim());
                    console.log(`âœ… YazÄ±ldÄ±: ${m[1]}`);
                }
            }
            writeFiles(aiContent);

            // --- 2. TUR: TEST VE DERLEME (Build) ---
            console.log("ğŸ”¨ [TUR 2] Test ve Derleme...");
            let buildCmd = config.build_command || "echo 'Build komutu yok'";
            let installCmd = config.install_command || "echo 'Kurulum yok'";
            
            let buildLog = "";
            let buildSuccess = false;

            try {
                console.log(`ğŸ”Œ BaÄŸÄ±mlÄ±lÄ±klar yÃ¼kleniyor: ${installCmd}`);
                execSync(installCmd, { stdio: 'inherit' });
                
                console.log(`ğŸš€ Derleniyor: ${buildCmd}`);
                execSync(buildCmd, { stdio: 'inherit' });
                buildSuccess = true;
                console.log("ğŸ‰ DERLEME BAÅARILI!");
            } catch (error) {
                console.log("ğŸ’¥ DERLEME HATASI OLUÅTU!");
                buildLog = error.message + "\n" + (error.stdout ? error.stdout.toString() : "") + "\n" + (error.stderr ? error.stderr.toString() : "");
            }

            // --- 3. TUR: SELF-HEALING (Kendi Kendini Tamir) ---
            if (!buildSuccess) {
                console.log("ğŸš‘ [TUR 3] Hata DÃ¼zeltme Modu Devrede...");
                
                conversation.push({
                    role: "user",
                    content: `KODLARI YAZDIN AMA HATA ALDIM. Ä°ÅŸte hata Ã§Ä±ktÄ±sÄ±:\n\n${buildLog.substring(0, 5000)}\n\nLÃ¼tfen hatayÄ± analiz et ve dosyalarÄ± DÃœZELT.`
                });
                
                let fixMsg = await askDeepSeek(conversation);
                console.log("ğŸ§  DÃ¼zeltme geldi, dosyalar gÃ¼ncelleniyor...");
                writeFiles(fixMsg.content);
                
                // Son kez dene (Opsiyonel)
                try {
                    execSync(buildCmd, { stdio: 'inherit' });
                    console.log("ğŸ‰ DÃœZELTME SONRASI BAÅARILI!");
                } catch(e) { console.log("âš ï¸ Hala hata var, ama en iyi halini kaydettim."); }
            }

      # 3. KODLARI KAYDET
      - name: ğŸ’¾ Commit & Push
        run: |
          git config --global user.name "DeepSeek OMNI"
          git config --global user.email "omni@deepseek.com"
          git add .
          git commit -m "ğŸ¤– OMNI: Kodlama ve Otomatik DÃ¼zeltme" || echo "DeÄŸiÅŸiklik yok"
          git push

      # 4. SONUÃ‡ YÃœKLEME (Android APK vb.)
      - name: ğŸ“¤ Artifacts (Varsa)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: |
            **/*.apk
            **/*.jar
            **/*.exe
            build/
